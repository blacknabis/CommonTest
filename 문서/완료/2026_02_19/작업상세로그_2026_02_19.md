# 작업상세로그_2026_02_19

## 작업 주제
- 환경설정 오디오 옵션창 1차 구현 (BGM/SFX 볼륨 + Mute + 저장/복원)

## 코드 반영 내역
1. 오디오 설정 키/기본값 분리
- 파일: `Assets/Scripts/Kingdom/Audio/AudioSettingsKeys.cs`
- 내용: `Kingdom.Audio.BgmVolume`, `Kingdom.Audio.SfxVolume`, `Kingdom.Audio.BgmMuted`, `Kingdom.Audio.SfxMuted` 상수 및 기본값 정의

2. 오디오 설정 서비스 추가
- 파일: `Assets/Scripts/Kingdom/Audio/AudioSettingsService.cs`
- 내용:
  - `Load/Save/ApplyToAudioHelper` 구현
  - 레거시 키(`Common_BGMVolume`, `Common_SFXVolume`) 하위 호환 로드
  - NaN/Infinity 방어 및 Clamp 처리

3. 앱 시작 시 설정 로드 연결
- 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`
- 내용: `OnInitializeManagers()`에서 `AudioSettingsService.Load()` 호출

4. 오디오 옵션 팝업 뷰 추가
- 파일: `Assets/Scripts/Kingdom/UI/AudioOptionsPopup.cs`
- 내용:
  - BGM/SFX 슬라이더, Mute 토글, 퍼센트 라벨 동기화
  - UI 이벤트 루프 방지 플래그(`_suppressUiEvent`)
  - SFX 샘플 재생 디바운스(`sampleSfxMinInterval`)
  - 런타임 경로 바인딩(`EnsureRuntimeBindings`) 지원

5. 월드맵 팝업 라우팅 확장
- 파일: `Assets/Scripts/Kingdom/UI/WorldMapView.cs`
- 내용:
  - 오디오 옵션 액션/버튼/팝업 루트 필드 추가
  - `OpenAudioOptionsPopup()` 추가
  - 오버레이 바인딩 대상에 오디오 팝업 포함
  - 프리팹 미존재 시 런타임 폴백 팝업 생성(`CreateFallbackAudioOptionsPopup`)

6. 회귀 러너 비동기 모델 전환
- 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`
- 내용:
  - 기존 `IEnumerator + StartCoroutine` 경로를 `UniTask` 기반으로 전환
  - `RunSceneLoopRegressionAsync`, `RunWorldMapMetaPopupRegressionAsync`, `RunMetaPersistenceAndHeroApplyRegressionAsync` 추가
  - `CoTryChangeAndWait` -> `TryChangeAndWaitAsync`로 교체
  - `WaitForSecondsRealtime` -> `UniTask.Delay(DelayType.UnscaledDeltaTime)`로 교체

7. 오디오 설정 자동 회귀 러너 추가
- 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`
- 내용:
  - ContextMenu: `Run Audio Settings Regression`
  - 공개 진입점: `StartAudioSettingsRegression()`
  - 실행 로직: `RunAudioSettingsRegressionAsync()`
  - 검증 항목:
    1) `PlayerPrefs` 저장값 검증(BGM/SFX/뮤트)
    2) `AudioHelper` 런타임 반영값 검증
    3) 월드맵↔게임 씬 전환 후 유지 검증
  - 테스트 후 이전 사용자 설정값 자동 원복

8. 오디오 옵션 프리팹 빌더 추가
- 파일: `Assets/Scripts/Kingdom/Editor/AudioOptionsPopupPrefabBuilder.cs`
- 메뉴: `Tools/Kingdom/Build AudioOptionsPopup Prefab`
- 출력: `Assets/Resources/UI/WorldMap/AudioOptionsPopup.prefab`
- 목적: 런타임 폴백 의존도를 줄이고, 리소스 경로 고정 로드(`Resources/UI/WorldMap/AudioOptionsPopup`)를 보장

## 실행 결과
- 실행 방법: `KingdomAppManager` 인스펙터 ContextMenu -> `Run Audio Settings Regression`
- 결과 로그:
  - `[KingdomAppManager] Audio settings regression finished. success=11, fail=0, testBgm=0.23, testSfx=0.67, testBgmMuted=True, testSfxMuted=False`
- 판정: 자동 회귀 테스트 **통과**

## 문서 동기화
- `문서/진행/task.md`에 오디오 옵션창 트랙(Phase 1~3) 반영
- 본 로그 파일 신규 작성

## 확인 항목 (완료)
- Unity PlayMode에서 슬라이더/토글 동작 및 재실행 복원 확인 완료
- 프리팹 기반 `UI/WorldMap/AudioOptionsPopup` 리소스 연결 및 경로 바인딩 확인 완료
- 월드맵 `btnAudioOptions` 슬롯 누락 시 런타임 자동 복구 동작 확인 완료

## Codex IDE 후속 반영 (인수인계서 후속, 2026-02-19)
1. 월드맵 버튼 슬롯 레거시 복구 로직 추가
- 파일: `Assets/Scripts/Kingdom/UI/WorldMapView.cs`
- 내용:
  - `btnAudioOptions`가 프리팹에 미할당된 레거시 상태를 런타임에서 자동 보정
  - 우선순위:
    1) 후보 이름(`btnAudioOptions`, `btn_audio_options`, `btn_settings` 등) 탐색
    2) 기존 `UIActionButtonItem` 중 미사용 항목 재바인딩
    3) 모두 실패 시 `btnUpgrades`를 복제해 `btn_audio_options` 생성 후 바인딩
  - 목적: `WorldMapView.prefab` 직렬화 슬롯 누락 상태에서도 오디오 옵션 버튼이 동작하도록 보장

2. 정적 검증 결과
- `Assets/Resources/UI/WorldMapView.prefab`의 `WorldMapView` 직렬화 필드에 `btnAudioOptions` 슬롯이 아직 없음 확인
- `Assets/Resources/UI/WorldMap/AudioOptionsPopup.prefab` 파일 미생성 상태 확인

3. Unity MCP 실행 이슈
- `execute_menu_item("Tools/Kingdom/Build AudioOptionsPopup Prefab")` 호출 시 도구 오류/타임아웃 발생
- 결과적으로 프리팹 빌더 메뉴의 자동 실행 검증은 실패했고, Unity Editor 내부 수동 실행이 필요

## Codex IDE 후속 반영 2 (2026-02-19)
1. 프리팹 빌더 실행 재시도 성공
- Unity 리프레시/컴파일 후 `Tools/Kingdom/Build AudioOptionsPopup Prefab` 메뉴 실행 성공
- 생성 확인:
  - `Assets/Resources/UI/WorldMap/AudioOptionsPopup.prefab`
  - `Assets/Resources/UI/WorldMap/AudioOptionsPopup.prefab.meta`

2. 리소스/구조 정적 검증
- `WorldMapView.AudioOptionsPopupResourcePath = "UI/WorldMap/AudioOptionsPopup"` 확인
- 생성된 프리팹 내부에 핵심 노드/컴포넌트 존재 확인:
  - `AudioOptionsPopup` 컴포넌트
  - `Panel`
  - `BgmRow`
  - `SfxRow`
  - `BtnClose`

3. 상태 업데이트
- 사용자 확인으로 팝업 레이어/오픈/저장복원 동작 확인 완료
- 추가 수동 QA는 사용자 요청으로 중단하고 문서 마감 처리

## Codex IDE 후속 반영 3 (2026-02-19, 마감)
1. 팝업 레이어 라우팅 수정
- 파일: `Assets/Scripts/Kingdom/UI/WorldMapView.cs`
- 내용:
  - `OverlayContainer` 부모를 `UILayer_Popup` 캔버스로 우선 지정
  - 기존 Screen 하위 컨테이너가 있으면 런타임에서 Popup 레이어로 재부모화
- 결과: `AudioOptionsPopup`이 `UILayer_Screen`이 아닌 `UILayer_Popup`에서 표시됨 확인

2. 저장 안정성 보강 (디바운스 + 라이프사이클 훅)
- 파일: `Assets/Scripts/Kingdom/Audio/AudioSettingsService.cs`
- 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`
- 내용:
  - 저장 디바운스 200ms 적용
  - 앱 `OnApplicationPause(true)` / `OnApplicationQuit()` 시 강제 flush 저장
  - 동일 값 재설정 시 불필요 저장/적용 방지

3. 직렬화 예외 수정
- 파일: `Assets/Scripts/Kingdom/Save/UserSaveData.cs`
- 내용:
  - 직렬화 타이밍 `Application.persistentDataPath` 접근 예외 방어
  - 경로 접근 불가 시 안전 리턴하도록 저장/로드 경로 조회 가드 적용
- 결과: `SkillTreeUI` 경유 `get_persistentDataPath is not allowed to be called during serialization` 에러 해소 확인

4. 최종 상태
- 오디오 옵션창 기능/저장복원/팝업 레이어 요구사항 반영 완료
- 문서(`task.md`, 작업계획, 작업상세로그) 동기화 완료
- 오디오 옵션창 트랙 완료 처리(추가 QA 미진행, 사용자 승인)
