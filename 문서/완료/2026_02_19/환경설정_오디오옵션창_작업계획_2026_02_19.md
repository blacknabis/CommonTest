# 환경설정 오디오 옵션창 작업계획 (2026-02-19)

## 0) 문서 목적 / 범위
- 목적: 환경설정에서 **BGM / 효과음(SFX) 볼륨을 실시간 조절**하고, 재실행 후에도 설정값이 유지되도록 한다.
- 범위: UI(옵션 팝업), 오디오 라우팅, 저장/로드, 최소 QA 체크리스트.
- 비범위: 신규 사운드 리소스 제작, 믹싱 밸런스 최종 확정. (Notebook 분석: 원작도 음성(Voice)은 별도 채널 없이 SFX에 포함됨)

## 1) Notebook 참조 기반 요구 정리
본 플랜은 기존 Notebook 기반 문서 흐름을 따름.

- 참고 1: `문서/완료/2026_02_16/게임씬_구현명세서.md`
  - 사운드 동시 재생 시 우선순위/채널 혼잡 제어 필요
- 참고 2: `문서/개발일지/DevLog_2026_02_12.md`
  - `AudioHelper`(BGM/SFX 싱글톤, 볼륨/자동저장) 방향성 기재

적용 해석:
1. 설정 UI는 단순 저장창이 아니라 **즉시 반영(Preview)** 되어야 함
2. 저장 실패/로드 실패 시에도 안전한 기본값으로 동작해야 함
3. 채널별(BGM/SFX) 독립 조절이 가능해야 함

### 1-1. ADR (결정 기록)
- ADR-01: 오디오 옵션은 1차에서 `BGM/SFX` 2채널만 제공한다. (`Master/Voice`는 Future)
- ADR-02: 저장소는 1차에서 `PlayerPrefs`를 사용한다. (멀티 프로필/클라우드 저장은 범위 외)
- ADR-03: UI 값 변경은 **즉시 반영 + 디바운스 저장** 정책을 채택한다.
- ADR-04: 음소거는 볼륨값을 0으로 덮는 방식이 아니라, `Mute 플래그 + 이전 볼륨 기억` 방식을 사용한다.

## 2) 목표 기능 (MVP)
1. 옵션창에 `BGM 슬라이더`, `SFX 슬라이더`, `음소거 토글(Checkbox)`, `닫기` 제공
2. 슬라이더 조절 즉시 볼륨 반영
3. 값 저장(`PlayerPrefs`) 및 앱 재실행 후 복원
4. 값 범위 `0.0 ~ 1.0`, 기본값 `BGM=0.8`, `SFX=1.0`
5. `SFX` 슬라이더 변경 시 짧은 샘플 효과음(디바운스) 1회 재생

### 2-1. 비기능 요구사항 (NFR)
- 성능: 슬라이더 드래그 중 프레임 드랍 유발 금지(저장 호출 디바운스)
- 안정성: 사운드 소스 누락/씬 전환 중에도 예외 없이 동작
- 일관성: 월드맵/게임 씬에서 동일한 볼륨 정책 적용
- 사용성: 0%/100% 극단값에서 텍스트/토글 표시가 직관적

## 3) UX 정책
- 진입: 월드맵/게임 공통으로 환경설정 버튼에서 오픈
- 조작: 드래그 중 실시간 반영
- 닫기: `X`, 배경 터치(옵션), BackKey 정책은 기존 오버레이 규칙 재사용
- 스타일: 킹덤러쉬 풍의 **나무(Wood)** 또는 **석재(Stone)** 질감 패널 사용 (Notebook 참조: UI 일관성)
- 접근성: 슬라이더 옆 숫자 라벨(예: `80%`, `100%`) 표시

### 3-1. 세부 UX 규칙
- `Mute` ON 시: 해당 채널 실출력을 0으로 만들되, 슬라이더 마지막 값은 유지 표시
- `Mute` OFF 시: 마지막 슬라이더 값으로 즉시 복원
- `SFX` 샘플 재생 간 최소 간격: 150~250ms (권장 200ms)
- 옵션창 닫을 때 별도 저장 버튼 없이 자동 저장 완료 상태 유지

## 4) 기술 설계

### 4-1. 데이터 키/기본값
- 키
  - `Kingdom.Audio.BgmVolume`
  - `Kingdom.Audio.SfxVolume`
  - `Kingdom.Audio.BgmMuted`
  - `Kingdom.Audio.SfxMuted`
- 기본값
  - `DefaultBgmVolume = 0.8f`
  - `DefaultSfxVolume = 1.0f`
  - `DefaultBgmMuted = false`
  - `DefaultSfxMuted = false`

### 4-2. 런타임 오디오 라우팅
- BGM 채널: 배경음 `AudioSource` 볼륨에 `bgmVolume` 적용
- SFX 채널: UI 클릭/전투 효과음 `AudioSource` 또는 재생 헬퍼에 `sfxVolume` 적용
- 확장 대비: 추후 `MasterVolume` 추가 시 최종 출력은 `Master * Channel` 구조

### 4-3. 저장/로드
- 앱 시작 시 1회 로드 후 오디오 시스템에 적용
- 슬라이더 변경 시 즉시 반영 + 200ms 디바운스 저장
- 잘못된 값/키 누락 시 `Mathf.Clamp01 + 기본값 폴백`
- 저장 시점: `onValueChanged`(디바운스), `OnApplicationPause(true)`, `OnApplicationQuit()`

### 4-3-1. 마이그레이션/호환
- 기존 키가 없는 구버전 사용자: 기본값으로 초기화
- 기존 볼륨 키만 있고 Mute 키가 없는 경우: `Mute=false`로 보정
- 잘못 저장된 NaN/Infinity 값은 기본값으로 강제 복구

### 4-4. 이벤트 계약(초안)
- `AudioSettingsService`
  - `float BgmVolume { get; }`
  - `float SfxVolume { get; }`
  - `bool IsBgmMuted { get; }`
  - `bool IsSfxMuted { get; }`
  - `void SetBgmVolume(float value)`
  - `void SetSfxVolume(float value)`
  - `void SetBgmMuted(bool muted)`
  - `void SetSfxMuted(bool muted)`
  - `event Action<float> OnBgmVolumeChanged`
  - `event Action<float> OnSfxVolumeChanged`
  - `event Action<bool> OnBgmMuteChanged`
  - `event Action<bool> OnSfxMuteChanged`
- `OptionsPopupView`
  - `Init(AudioSettingsService service)`
  - 슬라이더 `onValueChanged` -> `SetBgmVolume/SetSfxVolume`
  - 토글 `onValueChanged` -> `SetBgmMuted/SetSfxMuted`

### 4-5. 적용 순서(권장)
1. 서비스 로드 (`AudioSettingsService.Load()`)
2. 채널 실출력 계산(`volume * (muted ? 0 : 1)`)
3. 오디오 소스 반영
4. UI 초기화 바인딩
5. 사용자 변경 이벤트 수신

### 4-6. 상세 UI 구조 (Prefab Hierarchy)
- **Root (AudioOptionsPopup)** - [CanvasGroup, RectTransform (Stretch/Stretch)]
    - **DimmedBackground** - [Image (Black, Alpha 0.7), RaycastTarget=True, Button(Close)]
    - **Panel** - [Image (Wood/Stone Texture), RectTransform (Centered, ~800x600)]
        - **Header**
            - **TitleText** - [TMP (H1, "OPTIONS"), Anchor: Top-Center]
        - **ContentArea** - [VerticalLayoutGroup (Spacing: 40, Padding: 40)]
            - **BGM_Row** - [HorizontalLayoutGroup]
                - **Label** - [TMP ("MUSIC"), Width: 150]
                - **Slider** - [Slider (0~1)]
                - **ValueText** - [TMP ("80%"), Width: 80]
                - **MuteToggle** - [Toggle (Checkbox Style), "Mute"]
            - **SFX_Row** - [HorizontalLayoutGroup]
                - **Label** - [TMP ("SOUNDS"), Width: 150]
                - **Slider** - [Slider (0~1)]
                - **ValueText** - [TMP ("100%"), Width: 80]
                - **MuteToggle** - [Toggle (Checkbox Style), "Mute"]
        - **Footer**
            - **CloseButton** - [Button (Text: "DONE"), Anchor: Bottom-Center]

### 4-7. 핵심 클래스 책임 (Service vs View)
- **AudioSettingsService (Logic)**
  - `데이터`: 현재 볼륨/Mute 상태 관리, PlayerPrefs I/O 담당
  - `로직`: 값 변경 시 유효성 검사, 최소/최대값 클램핑, 실제 오디오 적용 로직 호출
  - `통지`: 값이 변경될 때만 이벤트 발생 (View 갱신용)
- **AudioOptionsPopup (View)**
  - `초기화`: `Service.Properties` 읽어서 슬라이더/토글 초기화
  - `입력`: 슬라이더 드래그/토글 클릭 시 `Service.Set...()` 메서드 호출
  - `갱신`: `Service.On...Changed` 이벤트 구독 -> UI 강제 동기화 (양방향 바인딩)

## 5) 변경 대상 파일(예정)
### 신규
1. `Assets/Scripts/Kingdom/Audio/AudioSettingsService.cs`
2. `Assets/Scripts/Kingdom/UI/Options/AudioOptionsPopup.cs`
3. `Assets/Scripts/Kingdom/Audio/AudioSettingsKeys.cs` (상수 분리, 선택)

### 수정
1. `Assets/Scripts/Kingdom/UI/WorldMapView.cs`
   - 환경설정 버튼에서 오디오 옵션창 오픈
2. `Assets/Scripts/Kingdom/UI/GameView.cs`
   - 인게임 진입 시 현재 볼륨값 반영(필요 시)
3. 오디오 재생 공용 유틸(프로젝트 현재 사용 클래스 기준)
   - SFX/BGM 재생 함수에 채널 볼륨 반영
4. `PROJECT_RULES.md` 또는 운영 문서
   - 오디오 키 네이밍/기본값 정책 기록 (선택)

## 6) 단계별 실행 계획

### Phase A. 서비스/저장 기반 구축
- `AudioSettingsService` 작성
- `PlayerPrefs` 키/기본값/클램프/로드/저장 구현
- 부팅 시점 적용 연결
- 구버전 키/누락 키 마이그레이션 처리

### Phase B. 옵션 UI 연결
- 오디오 옵션 팝업 프리팹(또는 런타임 생성) 구성
- BGM/SFX 슬라이더 + 음소거 토글 + 퍼센트 라벨 바인딩
- 오버레이 닫기 동선 기존 정책 재사용

### Phase C. 실시간 반영/피드백
- 슬라이더 변경 즉시 채널 볼륨 적용
- SFX 조절 시 샘플 효과음 재생(디바운스)
- 음소거(0%) 상태 UI 가시성 점검
- 씬 전환 중 오디오 소스 재바인딩 안정성 점검

### Phase D. 회귀/문서 동기화
- 월드맵/게임 씬 왕복 시 값 유지 검증
- 앱 재시작 복원 검증
- `문서/진행/task.md` 및 작업로그 반영

## 7) QA 체크리스트

### 기능
- [x] 옵션창에서 BGM 슬라이더 변경 시 즉시 배경음 크기가 바뀐다.
- [x] 옵션창에서 SFX 슬라이더 변경 시 즉시 효과음 크기가 바뀐다.
- [x] BGM/SFX 음소거 토글 ON/OFF가 즉시 반영된다.
- [x] 0%/100% 극단값에서 오류 없이 동작한다.

### 저장/복원
- [x] 앱 재실행 후 마지막 설정값이 유지된다.
- [x] 키가 없거나 비정상값일 때 기본값으로 안전 복구된다.
- [x] 구버전 데이터(볼륨 키만 존재)에서 mute 기본값 보정이 정상 동작한다.

### 회귀
- [x] 기존 UI 클릭음 동작이 깨지지 않는다.
- [x] 월드맵/게임씬 전환 반복 시 볼륨 값이 일관된다.
- [x] 일시정지/복귀 시 볼륨이 초기화되지 않는다.

### 수동 테스트 시나리오 (권장 순서)
1. 최초 실행(키 없음) -> 기본값 적용 확인
2. BGM 20%, SFX 70% 설정 후 재실행 -> 값 복원 확인
3. BGM Mute ON 후 재실행 -> Mute 상태 복원 확인
4. SFX 슬라이더 빠르게 왕복 드래그 -> 샘플음 과재생/끊김 여부 확인
5. 월드맵↔게임씬 10회 왕복 -> 값 일관성/콘솔 에러 확인

## 8) 리스크 및 대응
1. **오디오 재생 경로 분산**
   - 대응: 공용 재생 진입점 1곳(또는 최소 2곳)으로 수렴 후 채널 볼륨 적용
2. **슬라이더 드래그 중 과도한 저장 호출**
   - 대응: 디바운스 저장 또는 OnPointerUp 시점 저장 병행
3. **팝업 중복 인스턴스 생성**
   - 대응: 단일 인스턴스 가드(이미 열려 있으면 재사용)
4. **Mute와 0% 볼륨의 의미 혼동**
   - 대응: 토글과 슬라이더를 분리 표시하고, 툴팁/라벨로 상태 명확화
5. **씬 로드 시 AudioSource 재할당 타이밍 이슈**
   - 대응: 씬 활성화 시점 재적용 훅(`OnSceneLoaded`) 추가

## 9) 완료 기준 (Definition of Done)
- [x] 월드맵/게임 모두에서 오디오 옵션창 접근 가능
- [x] BGM/SFX 실시간 조절 + Mute + 저장/복원 정상
- [x] 신규 콘솔 에러/치명 경고 0건
- [x] `task.md`/작업로그 동기화 완료

## 9-1) 수용 기준 (Acceptance Criteria)
- AC-01: 슬라이더 1회 이동 시 100ms 내 청감 반영
- AC-02: 앱 재실행 후 마지막 상태(볼륨+mute) 100% 복원
- AC-03: 키 누락/비정상값 환경에서도 예외 없이 기본값 복구
- AC-04: 월드맵/게임씬 어느 쪽에서 바꿔도 즉시 동기화
- AC-05: 옵션창 재오픈 시 UI 값(슬라이더/토글/퍼센트 라벨)이 서비스 상태와 불일치하지 않음

## 10) 후속 확장 (Future)
- Master Volume 추가
- Master Mute(전체 음소거) 추가
- AudioMixer Group 기반 세분화(UI/전투/환경)
- 플랫폼별(모바일/PC) 기본값 프리셋 분리

## 11) 롤백 계획
- 문제가 발생하면 `AudioSettingsService` 적용만 비활성화하고, 기존 고정 볼륨 경로로 즉시 복귀
- 저장 키는 삭제하지 않고 읽기만 중단하여 사용자 설정 손실 방지
- 롤백 후 원인 로그(재현 경로, 씬, 디바이스) 작업로그에 기록

## 12) 구현 체크리스트 (개발자가 바로 실행 가능)

### 12-1. Service 구현 체크
- [x] `Load()`에서 모든 키 읽기 + 기본값/클램프 보정
- [ ] `SetBgmVolume/SetSfxVolume`에서 값 변경 시에만 이벤트 발행
- [x] `SetBgmMuted/SetSfxMuted`에서 변경 즉시 실출력 재계산
- [x] `Save()` 디바운스 타이머(200ms) 적용
- [x] `OnApplicationPause/OnApplicationQuit` 강제 저장 훅 연결

### 12-2. View 구현 체크
- [x] 팝업 `OnEnable` 시 서비스 상태로 UI 초기화
- [x] 슬라이더 변경 시 퍼센트 텍스트 동기화 (`Mathf.RoundToInt(value * 100f)`) 
- [ ] 토글 변경 시 라벨(예: `Muted`) 시각 상태 변경
- [x] 이벤트 역바인딩으로 인한 루프 호출 방지 가드(`_suppressUiEvent`) 적용
- [ ] 팝업 `OnDisable`에서 이벤트 구독 해제

### 12-3. 오디오 적용 체크
- [x] BGM 전용 `AudioSource` 참조 경로 통일
- [x] SFX 공용 재생 진입점에서 채널 볼륨 계수 적용
- [ ] 씬 로드 직후 재적용(`OnSceneLoaded`)으로 소스 재바인딩
- [ ] 소스 누락 시 경고 로그 1회만 출력(로그 스팸 방지)

## 17) 마감 메모 (2026-02-19)
- 오디오 옵션 팝업은 `UILayer_Popup` 캔버스에서 생성/표시되도록 보정 완료
- `AudioOptionsPopup.prefab` 생성 및 리소스 경로(`UI/WorldMap/AudioOptionsPopup`) 로드 확인 완료
- `UserSaveData` 직렬화 시점 `persistentDataPath` 접근 예외 방어 적용 완료
- 추가 수동 QA는 사용자 요청으로 더 진행하지 않고 현 상태 기준 문서 마감 처리
- 미적용(차기 개선):
  - `AudioSettingsService` 이벤트 계약(`OnBgmVolumeChanged` 등) 구현
  - `AudioOptionsPopup`의 `OnDisable` 기반 구독 해제(현재 `OnDestroy` 해제)

## 13) 코드 스케치 (Pseudo)
```csharp
// AudioSettingsService 핵심 계산식
float EffectiveBgm => IsBgmMuted ? 0f : Mathf.Clamp01(BgmVolume);
float EffectiveSfx => IsSfxMuted ? 0f : Mathf.Clamp01(SfxVolume);

void SetBgmVolume(float value)
{
    value = Mathf.Clamp01(value);
    if (Mathf.Approximately(BgmVolume, value)) return;
    BgmVolume = value;
    ApplyBgm();
    OnBgmVolumeChanged?.Invoke(BgmVolume);
    DebouncedSave();
}
```

```csharp
// AudioOptionsPopup 이벤트 루프 방지
bool _suppressUiEvent;

void RefreshUiFromService()
{
    _suppressUiEvent = true;
    bgmSlider.value = service.BgmVolume;
    sfxSlider.value = service.SfxVolume;
    bgmMuteToggle.isOn = service.IsBgmMuted;
    sfxMuteToggle.isOn = service.IsSfxMuted;
    _suppressUiEvent = false;
}
```

## 14) 일정/공수 추정 (1인 개발 기준)
- Day 1 (0.5~1d): `AudioSettingsService` + 저장/마이그레이션
- Day 2 (0.5~1d): 옵션 팝업 UI 바인딩 + 월드맵 연결
- Day 3 (0.5d): 게임씬/공용 SFX 경로 연동 + 회귀 테스트
- Day 4 (0.5d): QA 수정 + 문서 동기화 + 마감

## 15) 관측 로그 포맷 (운영/디버그)
- `[AudioSettings] Loaded bgm={0.00}, sfx={0.00}, bgmMuted={bool}, sfxMuted={bool}`
- `[AudioSettings] Saved bgm={0.00}, sfx={0.00}, bgmMuted={bool}, sfxMuted={bool}`
- `[AudioSettings] Applied scene={SceneName}, bgmSources={n}, sfxRouter={true|false}`

## 16) 문서 동기화 규칙
- 본 문서 수정 시 다음 파일을 함께 갱신한다.
  1. `문서/진행/task.md` (진행 상태)
  2. `문서/진행/작업상세로그_YYYY_MM_DD.md` (실행 로그)
  3. 완료 시 `문서/완료/YYYY_MM_DD/마감정리_오디오옵션창_YYYY_MM_DD.md`

