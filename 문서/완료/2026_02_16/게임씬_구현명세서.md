# 게임씬 구현 플랜 (보강본)

## 1. 목적
- `GameScene`을 Mock 중심 임시 상태에서 실제 전투 루프로 전환한다.
- 씬 흐름을 `Init -> Title -> WorldMap -> Game -> WorldMap`로 고정한다.
- 전투 결과(승/패, 별, 기록)가 저장과 월드맵 반영까지 일관되게 연결되도록 한다.

## 2. 범위
- 포함:
  - 전투 상태머신
  - 웨이브/스폰/경로
  - 타워/병영 블로킹/영웅 기본 루프
  - 전투 경제(골드)
  - 결과 처리/저장/월드맵 복귀
  - HUD/일시정지/결과 UI 최소 기능
- 제외(후속):
  - 라이브옵스 운영툴(원격 밸런스 패치, A/B)
  - 고급 연출(시네마틱, 특수 카메라 워크)

## 3. 현재 코드 기준 진단
| 항목 | 현재 상태 | 연결 코드 |
|------|----------|----------|
| 씬 정의 | 3개 (`Title`, `WorldMap`, `Game`) | `KingdomDef.SCENES` |
| 게임 진입 | 월드맵 스테이지 선택 후 전환 | `WorldMapScene.SelectedStageId` |
| 전투 로직 | FSM + 최소 루프 스캐폴딩 적용 (본 전투 시스템은 진행중) | `GameStateController`, `WaveManager` |
| HUD | 최소 슬롯 적용 (`Lives/Gold/Wave/NextWave/Hero/Spell/Result`) | `GameView` |
| 스테이지 데이터 | `StageConfig` SO — 웨이브/적 미포함 | `StageData` 구조체 |
| 저장 | 글로벌 `SaveManager` 싱글톤 경유로 단일화 | `SaveManager`, `WorldMapScene` |
| 복귀 경로 | `WorldMapScene`으로 통일 (Mock은 DEV_MOCK 분리) | `GameMockController`, `GameView` |

## 4. 목표 아키텍처

### 4.1 상태 흐름 다이어그램
```
┌─────────────────────────────────────────────────────┐
│  GameScene FSM                                      │
│                                                     │
│  ┌─────────┐   ┌────────────┐   ┌───────────┐      │
│  │ Prepare  │──>│ WaveRunning │──>│ WaveBreak │──┐  │
│  └─────────┘   └─────┬──────┘   └─────┬─────┘  │  │
│                      │                 │         │  │
│                      │    ┌────────────┘         │  │
│                      │    │  (다음 웨이브 있으면)   │  │
│                      │    v                      │  │
│                      │  ┌────────────┐           │  │
│                      │  │ WaveRunning│───────────┘  │
│                      │  └─────┬──────┘              │
│                      │        │ (마지막 웨이브 종료)  │
│                      v        v                     │
│                   ┌──────┐                          │
│                   │Result│                          │
│                   └──┬───┘                          │
│         ┌────────────┼────────────┐                 │
│         v            v            v                 │
│     [승리→월드맵] [패배→Retry]  [패배→Exit]         │
│                                                     │
│  ※ Pause: 모든 전투 상태에서 오버레이 진입/복귀 가능  │
└─────────────────────────────────────────────────────┘
```

### 4.2 매니저 배치
- 글로벌(`DontDestroyOnLoad`)
  - `SaveManager`
  - `AudioManager`
  - `MetaEconomyManager`
- 로컬(`GameScene` 전용)
  - `GameStateController` — FSM 상태 전이 총괄
  - `WaveManager` — 웨이브 진행/조기 호출/종료 판정
  - `SpawnManager` — 적 유닛 생성 및 경로 주입
  - `PathManager` — 적 이동 경로 캐시(웨이포인트)
  - `TowerManager` — 건설/업그레이드/판매/분기
  - `HeroController` — 이동/공격/스킬
  - `InGameEconomyManager` — 골드 수급/지출
  - `GameView` — HUD 표시 (기존 `BaseView` 확장, `InGameUIBinder` 역할 겸임)

## 5. 핵심 설계 원칙 (NotebookLM 반영)
- KR 스타일 핵심인 `고정 건설 포인트` + `병영 블로킹`을 초기에 포함한다.
- 단순 화력 경쟁 대신 `조기 웨이브 호출(Early Call)`의 리스크/리워드를 구현한다.
- 밸런싱은 감각이 아니라 계측 기반으로 진행한다(KPI 선구축).
- 초기화 순서를 강제한다:
  - 글로벌 매니저 초기화 완료
  - 스테이지 데이터 로드
  - 경로 캐시
  - 웨이브/스폰 시작

## 6. 전투 수학 (피해 공식)

### 6.1 피해 유형
| 유형 | 적용 방어 | 설명 |
|------|----------|------|
| **물리(Physical)** | ArmorPhysical(%) | 아처/병영/포병 기본 출력 |
| **마법(Magic)** | ArmorMagic(%) | 마법사 기본 출력, 물리 방어 무시 |
| **고정(True)** | 없음 | 독/저주 등, 모든 방어 무시 |

### 6.2 물리 피해 공식
```
실제피해 = 기본피해 × (1 - ArmorPhysical / 100)
```
- 포병 특수: 적 방어력을 **절반 무시** → `실제피해 = 기본피해 × (1 - ArmorPhysical / 200)`

### 6.3 즉사(Insta-kill)
- **확률 기반**: 공격 히트 시 확률 판정 (예: 스나이퍼 샷 최대 60%)
- **쿨타임 기반**: 일정 쿨다운 후 확정 발동 (예: 죽음의 광선)
- **보스 면역**: 보스/엘리트는 즉사 + 강제이동(CC) 면역

### 6.4 별 등급 기준
| 등급 | 조건 |
|------|------|
| ★★★ | 생명력 손실 ≤ 기준값A (거의 무손실) |
| ★★ | 생명력 손실 ≤ 기준값B |
| ★ | 생명력 > 0으로 클리어 |
| 패배 | 생명력 = 0 |

> 기준값은 `WaveConfig.StarThresholds[]`로 스테이지별 개별 설정

### 6.5 타격 판정 정책 (NotebookLM 반영)
- 기준 날짜: 2026-02-16
- 근거: NotebookLM `킹덤러쉬` 노트북 질의 결과
- 결론:
  - 원작 감성 기준으로 전투 판정은 `즉시(HitScan)` 단일이 아니라 `투사체(Projectile) + 즉시` 혼용이 맞다.
  - 기본 원칙은 `충돌 시 데미지`이며, 일부 타워만 예외적으로 즉시 판정을 허용한다.

타워군별 기본 정책:
- `Archer`: 투사체 충돌 시 데미지
- `Mage`: 기본은 투사체, 상위 분기/특수 스킬은 즉시 판정 허용
- `Artillery`: 포탄 도달/폭발 지점 기준 판정(AoE)
- `Barracks`: 투사체 없음, 근접 교전/블로킹 판정

구현 규칙:
- `TowerManager`는 직접 `ApplyDamage`를 호출하지 않고, 공격 의도만 생성한다.
- 실제 피해 적용 시점은 `Projectile` 충돌 또는 도달 이벤트에서 처리한다.
- 타겟이 투사체 도달 전에 사망/소실되면 유도 재탐색 또는 미스 처리 정책을 따른다(타워 타입별 선택).

### 6.6 투사체 판정 상세 규격 (구현 기준)
투사체 수명주기:
1. `발사(Fire)` — 타워가 쿨다운 충족 시 투사체 생성
2. `비행(Travel)` — 타겟 추적 또는 목표 지점 이동
3. `충돌(Hit)` — 적/지점과 접촉 시 판정 발생
4. `피해 적용(ResolveDamage)` — 충돌 시점에만 `ApplyDamage`
5. `소멸(Despawn)` — 히트 후 즉시 또는 잔여 연출 후 반환/파기

타워군별 히트 정책(초기):
| 타워군 | 비행 방식 | 피해 적용 시점 | 타겟 소실 시 처리 |
|---|---|---|---|
| Archer | 단일 타겟 추적 | 적 충돌 시 | 미스 처리(소멸) |
| Mage(기본) | 단일 타겟 추적 | 적 충돌 시 | 재탐색 1회 후 실패 시 미스 |
| Mage(특수) | 즉시(HitScan) | 발사 프레임 | 즉시 타겟 검증 실패 시 취소 |
| Artillery | 목표 지점 탄도 | 지점 도달/폭발 시(AoE) | 지점 고정 폭발 유지 |
| Barracks | 투사체 없음 | 근접 교전 틱 | N/A |

충돌 판정 공통 규칙:
- 동일 투사체는 동일 타겟에 1회만 피해 적용
- `IsDead` 타겟은 충돌 대상에서 제외
- `ProjectileMaxLifetime` 초과 시 안전 소멸
- `Time.timeScale` 변경(x1/x2/Pause) 시 판정 일관성 유지(멈춤/재개 동기화)

### 6.7 타워군별 판정 시퀀스 (구현 기준)
Archer(기본):
`AcquireTarget -> SpawnProjectile(Homing) -> Travel -> OnHit(target) -> ApplyDamage -> Despawn`

Mage(기본):
`AcquireTarget -> SpawnProjectile(Homing) -> Travel -> OnHit(target) -> ApplyDamage(Magic) -> Despawn`

Mage(특수 즉시):
`AcquireTarget -> ValidateTarget -> ApplyDamage(Instant) -> PlayVFX/SFX`

Artillery:
`AcquireAimPoint -> SpawnProjectile(Ballistic) -> Travel -> OnArrive(point) -> Explosion(AoE Query) -> ApplyDamageToEach -> Despawn`

Barracks:
`AcquireEnemy -> TryEnterBlock -> MeleeTickDamage -> ReleaseBlock(Death/Sell/OutOfRange)`

## 7. 타워 건설 UI 인터랙션

### 7.1 빈 건설 포인트 터치
```
터치 → 원형 링 메뉴 열림 (4종 타워 아이콘 + 비용 표시)
     ├─ 타워 선택 → 골드 차감 → 건설
     ├─ 골드 부족 → 아이콘 비활성(그레이아웃) + 비용 빨간색
     └─ 외부 터치/취소 → 메뉴 닫힘
```

### 7.2 기존 타워 터치
```
터치 → 타워 정보 + 액션 메뉴
     ├─ [업그레이드] 다음 레벨 비용 표시 (Lv1→2→3)
     ├─ [판매] 회수 골드 표시
     ├─ [분기 선택] Lv3→Lv4 시 2개 분기 아이콘 표시 (택 1, 비가역)
     └─ [랠리 포인트] (병영 전용) 집결 위치 드래그 지정
```

### 7.3 Lv4 이후 터치
```
터치 → 특수 능력 구매 메뉴
     ├─ 능력 A (비용/효과 표시)
     ├─ 능력 B (비용/효과 표시)
     └─ [판매]
```

## 7.4 GameView 프리팹 최소 슬롯 (NotebookLM 기준)
> 기준: NotebookLM `킹덤러쉬` 노트북 질의 결과 (전투 HUD 최소셋)

### A. Top HUD (필수)
- `txtLives` : 생명력 표시
- `txtGold` : 골드 표시
- `txtWaveInfo` : `WAVE n / total`
- `btnNextWave` : 조기 웨이브 호출 버튼
- `btnPause` : 일시정지 토글

### B. Hero / Spell (필수)
- `imgHeroPortrait` : 영웅 상태 슬롯
- `btnSpellReinforce` : 증원군 스킬
- `btnSpellRain` : 불의비 스킬
- `imgSpellReinforceCooldown` : 증원군 쿨다운 오버레이
- `imgSpellRainCooldown` : 불의비 쿨다운 오버레이

### C. Result / Debug (개발 단계)
- `resultRoot`, `txtResultTitle`, `txtResultMessage`
- `btnRetry`, `btnExit`
- `btnVictory`, `btnDefeat` (개발 디버그 전용)

### D. 이벤트 인터페이스
- `Bind(GameStateController)` : 상태/웨이브 바인딩
- `UpdateResourceInfo(lives, gold)` : 자원 HUD 갱신
- `SetNextWaveInteractable(bool)` : 조기호출 활성/비활성
- `SetSpellCooldown(spellId, normalized01)` : 스킬 쿨다운 반영
- `ShowResult(...)`, `HideResult()`, `SetPauseVisual(...)`

## 8. 단계별 구현 계획

### 8.1 1단계: 전투 프레임 구축
- 작업:
  - `GameStateController` 추가 (enum FSM)
  - 상태 전이 규칙 확정 (§4.1 다이어그램 기반)
  - `Pause` 진입/복귀 — `Time.timeScale = 0` + 오버레이 UI
- 산출물: 상태 전이 로그(디버그), FSM 유닛테스트
- 완료 조건: Prepare→WaveRunning→WaveBreak→Result 전이 끊김 없음

### 8.2 2단계: 맵/경로/웨이브 골격
- 작업:
  - `PathManager` — 웨이포인트 기반 적 이동 경로 캐시
  - `WaveConfig`/`EnemyConfig` SO 도입
  - `SpawnManager` 적 생성 + 경로 주입
  - `WaveManager` 웨이브 종료 판정 (생존 적 0 + 스폰 완료)
- 산출물: 최소 1개 스테이지 웨이브 실행
- 완료 조건: 적이 경로를 따라 이동, 웨이브 시작/종료 정확 판정

### 8.3 3단계: 타워/경제/블로킹
- 작업:
  - `TowerManager` 건설/업그레이드/판매/분기
  - 원형 링 메뉴 UI (§7 인터랙션 기반)
  - `InGameEconomyManager` 골드 수급/소모
  - 타워 공격 판정을 `즉시 데미지`에서 `투사체 충돌 데미지` 중심으로 전환
  - `ProjectileManager`(또는 동등 역할) 추가 — 발사/이동/충돌/소멸 관리
  - 포병은 충돌 지점 기반 범위 피해(AoE)로 분리
  - 병영 블로킹 루프 (적 상태: `Moving→Blocked→Attacking→Dead`)
  - 조기 호출 보상 (남은시간 × 보상계수 + 스펠 쿨다운 단축)
- 산출물: 4계열 기본 타워 동작, 조기 호출 버튼
- 완료 조건:
  - 경제 루프(처치→골드→강화) 안정 순환
  - 투사체 시각 이벤트와 실제 피해 적용 프레임이 논리적으로 일치
  - 포병 AoE가 충돌 지점 기준으로 복수 적에게 적용
  - 타겟 소실 시 미스/재탐색 정책이 타워군별 규칙대로 동작

### 8.4 4단계: 영웅/결과/복귀
- 작업:
  - `HeroController` 이동/공격/스킬 최소 구현
  - 승/패 결과 계산 (§6.4 별 등급 기준 적용)
  - 저장 반영 + `WorldMapReturnAnimator` 연계
  - 복귀 경로를 `WorldMapScene`으로 통일
- 산출물: 승리/패배 UI, 저장 리포트 로그
- 완료 조건: 승/패 후 월드맵 복귀 정상, 앱 재시작 후 기록 유지

### 8.5 5단계: Mock 격리/회귀 안정화
- 작업:
  - `GameMockController`를 `DEV_MOCK` 분기로 제한
  - 기본 실행 경로에서 Mock 완전 분리
  - 핵심 회귀 테스트 수행
- 완료 조건: 기본 빌드 Mock 비활성, 주요 루프 회귀 통과

## 9. 데이터 스키마(초안)

> **`StageConfig`와 `WaveConfig`의 관계**: 기존 `StageConfig` SO는 월드맵 표시용(위치/이름/해금)이고, `WaveConfig`는 전투 실행용(웨이브/골드/적). `StageConfig.StageId`를 키로 1:1 매핑하되, SO는 분리 유지한다. `StageConfig`에 `WaveConfig` 참조 필드를 추가하여 연결한다.

### 9.1 `WaveConfig` (SO)
- `StageId` — `StageConfig.StageId`와 1:1 매핑
- `InitialGold`
- `InitialLives`
- `StarThresholds[]` — 3별/2별 판정 기준 (남은 생명력)
- `Wave[]`
  - `WaveIndex`
  - `SpawnEntries[]`
    - `EnemyId`
    - `Count`
    - `SpawnInterval`
    - `PathId`
    - `SpawnDelay`
  - `BonusGoldOnEarlyCall`
  - `IsBossWave`

### 9.2 `TowerConfig` (SO)
- `TowerId`
- `TowerType` (`Archer/Barracks/Mage/Artillery`)
- `DamageType` (`Physical/Magic/True`)
- `BuildCost`
- `SellRate` (회수 비율, 예: 0.6)
- `CanTargetAir`
- `Levels[]`:
  - `Damage`, `FireRate`, `Range`, `UpgradeCost`
  - `AttackDeliveryType` (`Projectile/HitScan/Melee`)
  - `ProjectileProfileId` (투사체 규격 참조 키, HitScan/Melee는 비움 가능)
- `BarracksData` (병영 전용, `TowerType == Barracks`일 때만 사용):
  - `SoldierCount` — 소환 병사 수 (기본 3)
  - `SoldierHP`, `SoldierArmor`, `SoldierDamage`
  - `RespawnCooldown` — 병사 재소환 대기 시간
  - `RallyRange` — 집결 위치 지정 가능 반경
- `BranchOptions[]` (Lv4 분기):
  - `BranchId`, `BranchName`, `BranchCost`
  - `Abilities[]` (특수 능력, 개별 비용)

### 9.3 `EnemyConfig` (SO)
- `EnemyId`
- `HP`
- `ArmorPhysical` (% 감소)
- `ArmorMagic` (% 감소)
- `MoveSpeed`
- `GoldBounty`
- `DamageToBase` (탈출 시 생명력 차감)
- `IsFlying`
- `IsBoss`
- `IsInstaKillImmune`
- `SpawnOnDeath[]` (하수인 소환 시)

### 9.4 `HeroConfig` (SO)
- `HeroId`
- `HeroName`
- `HP`, `Armor`, `MoveSpeed`
- `AttackDamage`, `AttackRange`, `AttackSpeed`
- `Skills[]`:
  - `SkillId`, `SkillType` (`Passive/Active/Ultimate`)
  - `Cooldown`, `Duration`, `DamageOrEffect`

### 9.5 `SpellConfig` (SO)
- `SpellId` (증원군/불의비)
- `Cooldown`
- `EarlyCallCooldownReduction`
- `Duration`, `DamageOrEffect`

### 9.6 `ProjectileProfile` (SO 또는 직렬화 구조)
- `ProjectileId`
- `MoveType` (`Homing/Ballistic/Linear`)
- `Speed`
- `MaxLifetime`
- `HitRadius` (직격/근접 판정 반경)
- `ExplosionRadius` (포병 AoE용)
- `CanPierce`
- `MaxHitCount`
- `VfxOnSpawn`, `VfxOnHit`, `SfxOnHit`

초기 기본값(1차 가이드):
| Profile | MoveType | Speed | MaxLifetime | HitRadius | ExplosionRadius | CanPierce | MaxHitCount |
|---|---|---:|---:|---:|---:|---|---:|
| Archer_Arrow | Homing | 11.0 | 1.6 | 0.12 | 0.0 | False | 1 |
| Mage_Bolt | Homing | 9.0 | 1.8 | 0.14 | 0.0 | False | 1 |
| Artillery_Shell | Ballistic | 6.0 | 2.4 | 0.18 | 1.1 | False | 99 |

튜닝 가드:
- `Speed`는 1회 조정 시 ±15% 이내
- `MaxLifetime`은 `경로 최장 사거리 도달 시간 + 0.3s` 이상
- `ExplosionRadius` 변경 시 `TowerBuildRateByType`와 `EnemyLeakCountByType`를 함께 확인

## 10. KPI/텔레메트리(초기 필수)
- `WaveClearTime`
- `LifeLostPerWave`
- `GoldIncomePerWave` / `GoldSpendPerWave`
- `UnspentGoldAtWaveStart`
- `TowerBuildRateByType` / `TowerSellRateByType`
- `EnemyLeakCountByType`
- `EnemyDeathHeatmap` (경로 구간별)
- `EarlyCallUsageRate`
- `HeroSkillUsageRate`

### 10.1 튜닝 기준(초기)
> 난이도 튜닝(체감 난이도/스테이지별 밸런스)은 스테이지 제작 단계에서 수행하며, 본 단계에서는 기능 검증/KPI 수집에 집중한다.

- 한 웨이브 종료 후 평균 `신규 건설 0~1회` 또는 `업그레이드 1회` 가능한 경제값
- 특정 타워 타입 사용률이 과도하게 치우치면 수치 조정 트리거
- `UnspentGoldAtWaveStart`가 지속적으로 높으면 난이도/가격 재조정

## 11. 위험 요소와 대응
| 위험 | 대응 |
|------|------|
| 초기화 순서 꼬임 → Null/경로 누락 | 부트스트랩 완료 전 `GameScene` 진입 금지 가드 |
| 병영 블로킹 → 전투 상태 충돌 | 적 상태를 `Moving/Blocked/Attacking/Dead`로 분리 |
| Mock 경로 잔존 → 실제 루프 왜곡 | `DEV_MOCK` 컴파일 심볼로 강제 분리 |
| 피해 공식 누적 오차 → 밸런스 붕괴 | 고정소수점 또는 `int` 기반 HP/데미지 사용 |
| 타워 UI 터치 영역 겹침 | 타워/건설포인트에 우선순위 레이어 + 상호배타 처리 |
| `UserSaveData` 인스턴스 중복 → 데이터 덮어쓰기 | 글로벌 `SaveManager` 싱글톤으로 단일 인스턴스 보장 |
| `Time.timeScale` 변경 → Coroutine/DOTween 오동작 | `timeScale` 비의존 타이머 분리, 속도 변경 시 회귀 테스트 |
| 고속 투사체 관통 누락(터널링) | Raycast/연속 충돌 보정 적용, 최소 히트 반경 보장 |
| 타겟 소실 시 유령 투사체 잔존 | 최대 수명/소실 가드로 강제 정리 |
| 시각 히트와 실제 피해 타이밍 불일치 | `OnHit` 단일 이벤트에서 VFX+데미지 동기 처리 |

## 12. 체크리스트
- [ ] 월드맵 → 게임 진입 시 스테이지 데이터 일치
- [ ] 웨이브 시작/종료와 HUD 동기화
- [ ] 타워 건설/업그레이드/판매 정상
- [ ] 병영 블로킹 정상
- [ ] 조기 웨이브 호출 보상 정상
- [ ] 영웅 이동/스킬 최소 기능 정상
- [ ] 승/패 결과 저장 반영 정상 (§6.4 별 등급)
- [ ] 게임 → 월드맵 복귀 루프 정상
- [ ] 앱 재실행 후 기록 유지
- [x] 기본 빌드 Mock 비활성 확인
- [ ] 피해 공식 검증 (물리/마법/고정/포병 관통)
- [ ] 속도 조절(x1/x2) 시 Coroutine/애니메이션/물리 정상 동작
- [ ] 복귀 경로 통일 확인 (Mock/GameView 모두 `WorldMapScene`)
- [ ] 투사체 충돌 타이밍과 데미지 적용 타이밍 동기화
- [ ] 포병 AoE가 충돌 지점 기준으로 정확히 적용됨
- [ ] 타겟 소실 시 미스/재탐색 정책이 타워군별로 일치함

### 12.1 투사체 판정 테스트 표준 (최소 8케이스)
| ID | 시나리오 | 기대 결과 |
|---|---|---|
| P-01 | Archer 투사체 기본 히트 | 충돌 시점에만 1회 피해 적용 |
| P-02 | Mage 기본 투사체 히트 | 충돌 시점에 마법 피해 1회 적용 |
| P-03 | Mage 특수 즉시 판정 | 발사 프레임 즉시 피해, 투사체 생성 없음 |
| P-04 | Artillery 지점 폭발 | 충돌 지점 AoE 범위 내 적에게만 적용 |
| P-05 | 타겟 소실(비행 중 사망) | 정책대로 미스 또는 1회 재탐색 후 종료 |
| P-06 | x2 속도 전환 | 히트 누락/중복 없이 동일 규칙 유지 |
| P-07 | Pause/Resume | 정지 중 판정 없음, 재개 후 정상 지속 |
| P-08 | 고밀도 전투(다수 투사체) | 성능 저하 허용 범위 내, GC 스파이크 급증 없음 |

## 13. 우선순위
1. 상태머신 + 웨이브/스폰/경로
2. 타워/경제 + 병영 블로킹
3. 결과 처리 + 저장 + 월드맵 복귀
4. 영웅 최소 기능
5. KPI 계측 + 튜닝
6. Mock 제거 + 회귀 안정화

## 14. 참고 메모
- 본 문서는 NotebookLM `킹덤러쉬` 노트북을 기반으로 보강했다.
- 반영 포인트:
  - KR 스타일 핵심 전투 루프(병영 블로킹, 조기 호출)
  - 전투 씬 매니저 분리 원칙
  - 초기 단계 KPI 기반 밸런싱 접근
  - 피해 유형 3종(물리/마법/고정) + 포병 관통 공식
  - 별 등급 산정 기준 (라이프 기반)
  - 타워 건설 UI 인터랙션 흐름 (링 메뉴 → 분기 → 능력 구매)

## 15. 누락 위험 체크리스트 (High Risk)
- [ ] 병영/영웅이 적을 실제로 멈추게 하는 `Melee Lock` 규칙이 구현됨
- [ ] 적 상태(`Moving/Blocked/Attacking/Dead`) 전이가 프레임 단위로 충돌 없이 동작함
- [ ] 초기화 순서가 고정됨(맵/경로 로드 전 스폰 시작 금지)
- [ ] 비행 적 타겟팅 제약(`CanTargetAir`)이 타워별로 정확히 적용됨
- [ ] 방어력/저항/고정피해 계산식이 공통 함수로 단일화됨
- [x] 보스 면역(즉사/강제이동 면역) 플래그가 실제 전투 판정에 반영됨
- [ ] 웨이브 미리보기 UI가 실 유닛 스폰 없이 데이터만으로 동작함
- [ ] 조기 웨이브 호출이 경제 보상과 스킬 쿨다운 감소를 함께 처리함
- [ ] Pause 상태에서도 입력 허용 범위(배치/업글/이동)가 명확히 분리됨
- [ ] 사운드 동시 재생 시 우선순위/채널 제한으로 클러터링을 제어함

## 16. Definition Of Done (전투씬)

### 16.1 기능
- [ ] 웨이브 데이터 기준으로 적 수량/타이밍이 정확히 스폰됨
- [ ] 적이 경로를 이탈하지 않고 목표 지점까지 이동함
- [ ] 타워가 유효 타겟만 공격하고(지상/공중 제약) 우선순위가 적용됨
- [ ] 투사체 계열 타워는 충돌 시점에만 피해가 적용됨
- [ ] 포병은 충돌 지점 AoE 규칙으로 피해가 적용됨
- [ ] 병영 블로킹 및 영웅 교전이 정상 동작함
- [ ] 승/패 판정 및 결과 UI가 기획 조건대로 동작함

### 16.2 성능
- [ ] 적/투사체/이펙트 오브젝트 풀링 적용
- [ ] 목표 기기에서 전투 피크 시 목표 FPS 유지
- [ ] 불필요한 GC 스파이크(웨이브 시작/종료 구간) 없음

### 16.3 안정성
- [ ] Null 참조 없이 타겟 소실 시 재탐색
- [ ] 씬 전환 반복(월드맵↔게임) 30회 이상에서 누수/크래시 없음
- [ ] 저장 실패/로드 실패 시 안전 폴백 동작

### 16.4 밸런스
- [ ] 초반 3웨이브 체감 난이도가 급격히 튀지 않음
- [ ] 특정 타워 한 종류만으로 강제되지 않음(사용률 편중 감시)
- [ ] 조기 호출 사용이 명확한 보상과 리스크를 가짐

### 16.5 회귀
- [ ] `WorldMapScene -> GameScene -> WorldMapScene` 루프 회귀 통과
- [ ] 기존 저장 데이터와 신규 스키마 호환 확인
- [x] `DEV_MOCK` 비활성 빌드에서 Mock 경로 호출 0건

## 17. 코드 반영 대상 (초안)
- `Assets/Scripts/Kingdom/App/GameScene.cs`
  - `GameMockController` 자동 생성 제거, `GameStateController` 초기화 진입점으로 변경
- `Assets/Scripts/Kingdom/App/WorldMapScene.cs`
  - 진입 파라미터(`SelectedStageId`, 난이도) 전달 검증 강화
- `Assets/Scripts/Kingdom/App/GameMockController.cs`
  - `DEV_MOCK` 분기 격리 및 기본 빌드 경로 차단
- `Assets/Scripts/Kingdom/UI/GameView.cs`
  - HUD/링 메뉴/결과 UI 이벤트 바인딩 확장
- `Assets/Scripts/Kingdom/WorldMap/WorldMapReturnAnimator.cs`
  - 전투 결과 데이터 소비 지점 점검
- 신규(예정):
  - `Assets/Scripts/Kingdom/Game/GameStateController.cs`
  - `Assets/Scripts/Kingdom/Game/WaveManager.cs`
  - `Assets/Scripts/Kingdom/Game/SpawnManager.cs`
  - `Assets/Scripts/Kingdom/Game/PathManager.cs`
  - `Assets/Scripts/Kingdom/Game/InGameEconomyManager.cs`
  - `Assets/Scripts/Kingdom/Game/TowerManager.cs`
  - `Assets/Scripts/Kingdom/Game/HeroController.cs`
  - `Assets/Scripts/Kingdom/Game/ProjectileManager.cs`
  - `Assets/Scripts/Kingdom/Game/ProjectileRuntime.cs` (또는 동등 파일)

### 17.1 명세-코드 매핑표 (투사체 판정)
| 명세 항목 | 구현 책임 | 1차 대상 파일 |
|---|---|---|
| 6.5 타격 정책(혼용) | 타워군별 전달 방식 선택 | `Assets/Scripts/Kingdom/Game/TowerManager.cs` |
| 6.6 수명주기(Fire/Travel/Hit/Resolve/Despawn) | 투사체 상태 전이 | `Assets/Scripts/Kingdom/Game/ProjectileRuntime.cs` |
| 6.6 충돌 공통 규칙 | 중복 히트 방지/최대수명/소실 가드 | `Assets/Scripts/Kingdom/Game/ProjectileManager.cs` |
| 6.7 타워군별 시퀀스 | Archer/Mage/Artillery/Barracks 분기 | `Assets/Scripts/Kingdom/Game/TowerManager.cs` |
| 9.2 AttackDeliveryType | 레벨 데이터 기반 전달 타입 | `Assets/Scripts/Kingdom/Game/Data/TowerConfig.cs` |
| 9.6 ProjectileProfile | 투사체 속성 데이터 로드 | `Assets/Scripts/Kingdom/Game/ProjectileManager.cs` |
| Artillery AoE | 폭발 지점 적 탐색/적용 | `Assets/Scripts/Kingdom/Game/ProjectileRuntime.cs` |
| 속도/Pause 일관성 | 타임스케일 전환 안전성 | `Assets/Scripts/Kingdom/App/GameScene.cs` |

## 18. 작업 순서(실행 단위)
1. `GameScene`에서 Mock 자동생성 제거 + FSM 뼈대 연결
2. 웨이브/스폰/경로 최소 루프 구현
3. 타워 건설/업글/판매 + 골드 루프 연결
4. 병영 블로킹 + 영웅 최소 동작 추가
5. 결과 저장 + 월드맵 복귀 루프 고정
6. KPI 로그 삽입 후 수치 1차 튜닝

## 19. StageInfoPopup 반영 (2026-02-15)
- NotebookLM(킹덤러쉬) 기준 최소 정보 구조를 반영했다: 스테이지명/별/권장 난이도/최고 기록 + 난이도 선택 + Start/Back/Close 흐름.
- Assets/Resources/UI/StageInfoPopup.prefab 신규 제작.
- 프리팹 자동화 빌더 추가: Assets/Scripts/Kingdom/Editor/StageInfoPopupPrefabBuilder.cs (Tools/Kingdom/Build StageInfoPopup Prefab).
- WorldMapScene에서 Resources/UI/StageInfoPopup 로드 경로를 우선 사용하도록 연결.
- StageInfoPopup 시각/청각 보강: 리소스 스프라이트(ico_stage_bg, ico_text_bg) 적용, UI 클릭/오픈 SFX(WorldMap_Click) 적용, 클릭 중복 재생 방지 처리.
- 리소스 로드 정책 정리: StageInfoPopup 전용 경로(UI/Sprites/WorldMap/StageInfoPopup/*) 우선 로드, 미존재 시 레거시 리소스로 fallback.
- StageInfoPopup 에셋 적용 2/3 단계 반영: 신규 생성 이미지 배치 및 PrefabBuilder 재실행으로 프리팹 업데이트 완료.
- 이미지 생성 경로 보강: OpenAI Image API 한도 이슈 시 ComfyUI 브릿지(Assets/Scripts/Kingdom/Editor/stageinfopopup_comfy_bridge.py)로 StageInfoPopup 에셋 4종 생성/반영.

## 20. 전투 규칙 공통화/비행 타겟 제약 반영 (2026-02-15)
- `DamageCalculator`를 추가해 물리/마법/고정 피해 계산식을 공통 함수로 단일화했다.
- `TowerConfig`에 `DamageType`, `HalfPhysicalArmorPenetration` 필드를 추가해 포병 관통 규칙(물리 방어 절반 적용)을 데이터로 제어 가능하게 했다.
- `EnemyRuntime.ApplyDamage(...)`를 공통 계산식 경유로 전환했다.
- `TowerManager`의 타겟 선택에 `CanTargetAir` 규칙을 반영해, 해당 값이 `false`인 타워는 `IsFlying` 적을 타겟팅하지 않도록 적용했다.

## 21. 타워 링 메뉴 최소 구현 반영 (2026-02-15)
- `GameView`에 `TowerRingMenuRoot`를 추가해 `Build` 버튼 클릭 시 링 메뉴를 토글하도록 구현했다.
- 메뉴 항목은 `Archer/Barracks/Mage/Artillery/Cancel` 최소 구성으로 반영했다.
- `GameView`에서 선택한 `TowerType` 이벤트를 `GameScene`으로 전달하고, `TowerManager.TryBuildNextTower(TowerType)`로 연결했다.
- `TowerType` 런타임 반영:
  - 타입별 타워 틴트 적용(시각 구분)
  - `Mage`는 마법 피해로 처리
  - `Artillery`는 물리 방어 절반 관통 활성
  - `Barracks`는 비행 적 타겟팅 제외
- 링 메뉴 경제 반영:
  - 버튼 라벨에 타입별 비용(`nG`) 표시
  - 골드 부족 또는 잔여 슬롯 0일 때 버튼 비활성/그레이아웃 처리
  - 타입별 건설 비용 계산(`TowerManager.GetBuildCost`)을 실제 소모 비용에 연동
- 건설 포인트 직접 선택 반영:
  - `GameScene`에서 빈 건설 슬롯 클릭 시 해당 슬롯 월드 위치에 링 메뉴를 오픈
  - 선택된 타입은 `TowerManager.TryBuildTowerAtSlot(...)`으로 전달되어 지정 슬롯에 건설
  - 슬롯 점유 관리는 `free slot index` 기반으로 전환하여 순차 고정 배치 제약을 해소

## 22. 타워 액션 메뉴 최소 구현 반영 (2026-02-15)
- 기존 타워 클릭 시 액션 메뉴(`Upgrade/Sell/Close`)가 열리도록 `GameView`/`GameScene` 입력 루프를 확장했다.
- `TowerManager`에 타워 조회/상태 조회 API를 추가했다:
  - `TryFindTowerAtWorldPosition(...)`
  - `TryGetTowerActionInfo(...)`
- 업그레이드/판매 최소 루프를 반영했다:
  - `TryUpgradeTower(...)`: 최대 Lv3, 레벨 기반 피해/공속 보정
  - `TrySellTower(...)`: 환급 골드 지급 및 점유 슬롯 재개방
- 액션 메뉴는 현재 선택 타워의 `타입/레벨/업그레이드비용/판매환급`을 표시하고, 골드 부족 시 Upgrade 버튼을 비활성화한다.

## 23. 병영 블로킹 루프 최소 구현 반영 (2026-02-15)
- `EnemyRuntime`에 이동 상태 머신 최소 버전 추가:
  - `Moving -> Blocked -> Attacking -> Dead`
  - 블로킹 API: `TryEnterBlock(...)`, `ReleaseBlock(...)`
- `TowerManager`의 병영(`TowerType.Barracks`) 전용 처리 추가:
  - 병영 반경 내 지상 적 탐색 후 점유(block)
  - 점유 중인 적을 근접 공격
  - 적 사망/이탈/타워 판매 시 블로킹 해제
- 타워 제거/적 제거 이벤트에서 블로킹 참조 정리를 수행해 dangling block 상태를 방지한다.

## 24. 병영 랠리 포인트 최소 구현 반영 (2026-02-15)
- 타워 액션 메뉴에 `Rally` 버튼을 추가하고, 병영 타워 선택 시에만 활성화되도록 처리했다.
- `Rally` 선택 후 월드 클릭으로 집결 지점을 지정하는 최소 흐름을 반영했다.
- `TowerManager.TrySetRallyPoint(...)`에서 병영 기준 반경(`BarracksData.RallyRange`) 내로 입력 위치를 클램프해 저장한다.
- 병영 블로킹/교전 중심점을 타워 위치가 아닌 랠리 포인트로 전환했다.

## 25. 조기 호출 보상 최소 구현 반영 (2026-02-15)
- `GameStateController`에 `TryEarlyCallNextWave()`를 추가해 `WaveRunning` 상태에서 조기 호출을 처리하도록 했다.
- `GameScene`에서 `NextWave` 버튼 이벤트를 직접 처리하고 조기 호출 성공 시 보상을 지급한다.
- 보상 공식(최소 버전):
  - `WaveConfig.WaveData.BonusGoldOnEarlyCall`
  - `+ (남은 Wave 시간 × 2)` 정수 반올림
- 조기 호출 시 스펠 쿨다운 단축(최소 버전):
  - `reinforce`, `rain` 쿨다운 각각 4초 감소
  - `GameView.SetSpellCooldown(...)`로 HUD 즉시 반영

## 26. 전투 속도 토글 + KPI 웨이브 계측 반영 (2026-02-15)
- `GameView` 상단 HUD에 속도 버튼(`btnSpeed`)을 추가했다.
- 속도 토글 이벤트(`SpeedToggleRequested`)를 `GameScene`으로 연결했다.
- `GameScene`에서 `x1/x2` 전환을 지원한다.
  - 일반: `Time.timeScale = 1`
  - 가속: `Time.timeScale = 2`
  - Pause 충돌 방지를 위해 `ApplyEffectiveTimeScale()`로 단일 제어한다.
- KPI 웨이브 요약 로그를 추가했다.
  - `WaveClearTime`
  - `lifeLost`(웨이브 시작 대비 감소량)
  - `netGoldDelta`(웨이브 시작 대비 골드 순변화)
  - `towerBuildRateByType`
  - `enemyLeakCountByType`
  - `earlyCallUsageRate`
- 로그 포맷: `[KPI] WaveSummary ...`
- `task.md`의 7단계 항목 중
  - `KPI 로그 삽입`
  - `속도 조절(x1/x2) 구현`
  를 완료 처리했다.

## 26. Hero/Spell 데이터 최소 스키마 반영 (2026-02-15)
- `HeroConfig`, `SpellConfig` 최소 SO 스키마를 추가했다(현재 코드 구조상 `TowerConfig.cs` 내 선언).
- `GameScene`의 스펠 하드코딩 수치를 `SpellConfig` 기반으로 치환했다:
  - 쿨다운 시간(`CooldownSeconds`)
  - 조기 호출 단축 시간(`EarlyCallCooldownReductionSeconds`)
- `Resources`에 스펠 설정 파일이 없을 경우 런타임 fallback 설정을 생성해 null 참조 없이 동작하도록 보강했다.

## 27. HeroController 최소 전투 루프 반영 (2026-02-15)
- `HeroController`를 최소 런타임 버전으로 추가했다.
- 동작:
  - `SpawnManager` 적 스폰/제거 이벤트를 구독해 활성 적 목록 유지
  - 최근접 적 탐색 후 사거리 밖이면 이동, 사거리 내면 쿨다운 기반 공격
  - 타깃 사망/이탈 시 즉시 재탐색
- `GameScene`에 초기화 연동:
  - `HeroController` 자동 생성/탐색
  - `HeroConfig` 리소스 로드(`Data/HeroConfigs/DefaultHero`)
  - 리소스 미존재 시 런타임 fallback `HeroConfig` 생성

## 28. 승/패 결과 산출 + 결과 UI 연결 (2026-02-15)
- `GameScene`의 `Result` 상태 처리에 실제 결과 계산을 연결했다.
- 승/패 판정(최소 버전):
  - `Lives <= 0`이면 패배
  - 그 외 `CurrentWave >= TotalWaves`이면 승리
- 별 등급 산출(승리 시):
  - `WaveConfig.StarThresholds[0]` 이상: 3별
  - `WaveConfig.StarThresholds[1]` 이상: 2별
  - 그 외: 1별
- UI 반영:
  - `GameView.ShowResult(...)` 호출 시 승/패 타이틀 + 결과 메시지(별/남은 생명)를 표시
  - 중복 표시 방지를 위해 `Result` 상태당 1회만 결과창 표시

## 29. 결과 저장 + 월드맵 복귀 연출 데이터 연계 (2026-02-15)
- 전투 결과 확정 시점(`Result` 상태 진입)에서 저장/복귀 연계를 수행하도록 `GameScene`을 보강했다.
- 저장 반영:
  - 승리 시 `SaveManager.Instance.SaveData.SetStageCleared(...)` 호출
  - 저장 값: `stageId`, `stars`, `clearTimeSeconds`, `difficulty`
- 월드맵 복귀 연계:
  - `WorldMapReturnAnimator.SetPendingReturnData(...)`에
    - `stageId`, `isCleared`, `clearTimeSeconds`, `difficulty`
    - 를 전달해 월드맵 씬 진입 후 연출에서 소비 가능하도록 연결
- 중복 저장/연계 방지:
  - 결과 확정 1회 가드(`_resultFinalized`)를 추가

## 30. 월드맵 재진입 시 진행도 즉시 갱신 보강 (2026-02-15)
- `WorldMapView`에 `RefreshStageNodeProgress()`를 추가했다.
- 동작:
  - 현재 스테이지 데이터 재로딩
  - `SaveManager.Instance.SaveData`를 사용해 진행도 저장소 재생성
  - `WorldMapPresenter` 재구성 후 `UIStageNode` 전체 재바인딩

## 31. Hero Portrait 위젯 프리팹 분리 (2026-02-15)
- `GameView`의 `imgHeroPortrait`를 단일 이미지 슬롯으로 유지하던 구조를 위젯 구조로 확장했다.
- 신규 위젯:
  - `Assets/Scripts/Kingdom/UI/HeroPortraitWidget.cs`
  - 역할: 포트레이트 표시, 배경/프레임 포함, fallback 생성
- 신규 프리팹 빌더:
  - `Assets/Scripts/Kingdom/Editor/HeroPortraitWidgetPrefabBuilder.cs`
  - 메뉴: `Tools/Kingdom/Build HeroPortraitWidget Prefab`
  - 출력: `Assets/Resources/UI/Widgets/HeroPortraitWidget.prefab`
- `GameView` 적용:
  - `HeroPortraitWidget`을 우선 로드하고 `SetHeroPortrait(...)`를 위젯으로 위임
  - 리소스 미존재 시 런타임 fallback 위젯 생성
  - 기존 `imgHeroPortrait` 참조 경로는 호환 유지

## 32. Hero 스프라이트 리소스 경로 규칙/자동 로드 반영 (2026-02-15)
- 아트 리소스가 준비되면 코드 수정 없이 파일 투입만으로 반영되도록 경로 규칙을 고정했다.
- Portrait(UI) 로드:
  - `Resources/UI/Sprites/Heroes/Portraits/{HeroId}.png`
  - `GameScene`에서 `HeroConfig.HeroId` 기반으로 로드 후 `GameView.SetHeroPortrait(...)` 전달
- InGame(월드) 로드:
  - `Resources/UI/Sprites/Heroes/InGame/{HeroId}.png`
  - `HeroController`에서 `HeroConfig.HeroId` 기반으로 로드해 `SpriteRenderer`에 적용
- 리소스 미존재 시 fallback:
  - Portrait: 빈 포트레이트(기존 HUD placeholder)
  - InGame: 기존 임시 흰색 스프라이트
- 프롬프트/산출물 가이드:
  - `문서/진행/Hero_Sprite_Prompt_Guide.md`를 ComfyUI/나노바나나 복붙용으로 정리

## 33. Hero 액션 시퀀스 프레임 애니메이션 연동 (2026-02-15)
- `HeroController`를 단일 스프라이트 + 시퀀스 프레임 겸용으로 확장했다.
- 시퀀스 경로 규칙:
  - `Resources/UI/Sprites/Heroes/InGame/{HeroId}/idle_00.png`부터 연속
  - `walk_00`, `attack_00`, `die_00` 동일 규칙
- 상태 기반 재생:
  - 이동 시 `walk`
  - 공격 시 `attack` (짧은 홀드 포함)
  - 기본 `idle`
- 리소스 없을 때 폴백:
  - 시퀀스 없음 → 단일 스프라이트(`.../InGame/{HeroId}.png`)
  - 단일도 없음 → 기존 fallback 스프라이트
- ComfyUI 액션 프롬프트 문서:
  - `문서/진행/Hero_Animation_ComfyUI_프롬프트.md`

## 34. DefaultHero ComfyUI 실생성 반영 (2026-02-15)
- ComfyUI API를 통해 `DefaultHero` 리소스를 실제 생성해 프로젝트에 반영했다.
- 생성 리소스:
  - Portrait:
    - `Assets/Resources/UI/Sprites/Heroes/Portraits/DefaultHero.png`
  - InGame 단일:
    - `Assets/Resources/UI/Sprites/Heroes/InGame/DefaultHero.png`
  - InGame 시퀀스:
    - `Assets/Resources/UI/Sprites/Heroes/InGame/DefaultHero/idle_00~03.png`
    - `Assets/Resources/UI/Sprites/Heroes/InGame/DefaultHero/walk_00~03.png`
    - `Assets/Resources/UI/Sprites/Heroes/InGame/DefaultHero/attack_00~03.png`
    - `Assets/Resources/UI/Sprites/Heroes/InGame/DefaultHero/die_00~03.png`
- 현재 코드 경로 규칙에 따라, 위 리소스는 추가 코드 수정 없이 자동 로드된다.

## 35. 타워 밸런스 현황표 문서화 (2026-02-15)
- `Resources/Data/TowerConfigs/*.asset`의 현재 저장값과 `TowerManager.PopulateDefaultData(...)` 런타임 보정값을 비교 문서로 정리했다.
- 문서:
  - `문서/진행/타워밸런스_현황표_2026_02_15.md`
- 핵심 확인점:
  - 현재 SO 자산은 타입/레벨 값이 아직 충분히 분화되지 않아 런타임 보정 의존도가 높음
  - 밸런싱 단계에서는 각 타워 자산의 `Levels`를 명시적으로 입력/고정해야 함
- 호출 지점:
  - `WorldMapView.OnEnter(...)`
  - `WorldMapScene.OnStartScene()`
- 효과:
  - 게임씬에서 저장한 별/클리어 결과가 월드맵 복귀 직후 노드 상태/팝업 정보에 즉시 반영

## 31. 보스 면역 전투 판정 + 결과 저장 검증 가시화 (2026-02-15)
- `EnemyRuntime` 보강:
  - `IsBoss`, `IsInstaKillImmune` 접근 프로퍼티 추가
  - 보스는 `TryEnterBlock(...)` 실패 처리(강제 제어/블로킹 면역)
  - `TryApplyInstantKill()` API 추가(보스/즉사면역 대상 차단)
- `GameScene` 결과 표시 보강:
  - 승리 결과 메시지에 저장 후 기준의 `BEST 별`, `BEST 시간` 표시
  - 저장 반영 여부를 결과창에서 즉시 확인 가능
- 보스 스테이지 연계:
  - 승리 시 `BossEventSystem.NotifyBossStageCleared(stageId)` 호출

## 32. 저장 실패/로드 실패 안전 폴백 보강 (2026-02-15)
- `UserSaveData.Load()`에서 실패 케이스를 구체적으로 처리:
  - 빈 파일
  - 스키마 파싱 실패/무효 컨테이너
  - 예외 발생
- 실패 시 동작:
  - 기존 저장 파일을 `kingdom_user_save.corrupt_yyyyMMdd_HHmmss_<reason>.json`로 백업 이동
  - 빈 저장 컨테이너를 즉시 재생성/저장
- 효과:
  - 손상 저장 파일이 있어도 다음 실행에서 저장 시스템이 정상 부팅됨

## 33. Scene Loop 회귀 러너 도구 추가 (2026-02-15)
- `KingdomAppManager`에 컨텍스트 메뉴 실행 도구를 추가:
  - `Run Scene Loop Regression (30)`
- 동작:
  - `WorldMapScene -> GameScene` 루프를 30회 자동 반복
  - 각 스텝에서 씬 전환 성공/실패(타임아웃) 집계 로그 출력
  - 종료 후 `WorldMapScene`으로 복귀
- 목적:
  - 6단계 회귀 항목(루프 반복 안정성) 수동 검증 비용 절감

## 34. 기존 저장 스키마 호환 파서 보강 (2026-02-15)
- `UserSaveData.Load()`에 다중 역직렬화 경로를 추가했다.
- 지원 경로:
  - 현재 스키마(`StageProgressList`)
  - 레거시 루트(`StageProgress`, `Stages`)
  - 레거시 raw array(`[ {...}, {...} ]`)
  - camelCase 키(`stageProgressList`, `stageId`, `bestStars` 등) 정규화 후 재시도
- 실패 시:
  - 손상 파일 백업 이동 + 빈 컨테이너 재저장
- 효과:
  - 구 저장 파일 흡수 가능성을 높이고, 파싱 실패 시에도 저장 시스템 부팅 안정성 유지

## 35. Scene Loop 러너 메모리 지표 확장 (2026-02-15)
- `KingdomAppManager` 회귀 러너 완료 로그에 메모리 지표를 포함:
  - `memBefore`, `memAfter`, `memDelta`, `memPeakDelta`
- 용도:
  - `씬 전환 반복 시 메모리 누수/크래시 없음` 항목 검증 시 정량 근거 확보

## 36. 저장 호환 자가테스트 도구 추가 (2026-02-15)
- `SaveManager` 컨텍스트 메뉴 추가:
  - `Run Save Compatibility SelfTest`
- 테스트 방식:
  - 현재 저장 파일 내용 백업
  - 레거시 포맷 샘플(JSON)들을 순차 작성 후 `UserSaveData` 로드 검증
  - 결과 PASS/FAIL 로그 출력
  - 테스트 종료 후 원본 저장 파일 복원 및 `Reload()`
- 목적:
  - `기존 저장 데이터와 신규 스키마 호환 확인` 항목을 반복 가능하고 안전하게 검증

## 37. 타격 판정 정책 보강 (2026-02-16)
- NotebookLM `킹덤러쉬` 질의 결과 기준으로, 타격 판정 정책을 `즉시 단일`에서 `투사체+즉시 혼용`으로 명세 보강.
- 명세 반영 항목:
  - `Archer`: 투사체 충돌형
  - `Mage`: 기본 투사체 + 특수 즉시 허용
  - `Artillery`: 포탄 충돌/폭발형
  - `Barracks`: 근접 블로킹/교전형
- 후속 구현은 `TowerManager` 직접 피해 적용 제거 후 `Projectile` 충돌 이벤트 적용으로 전환 예정.

## 38. 타격 판정 규격 상세화 (2026-02-16)
- 정책 선언만으로 구현 편차가 생기지 않도록, 투사체 판정의 세부 규격을 명시했다.
- 추가 반영 내용:
  - `6.6` 수명주기/충돌 규칙/타워군별 히트 정책
  - `9.2`에 `AttackDeliveryType`, `ProjectileProfileId` 필드 정의
  - `9.6 ProjectileProfile` 스키마 정의
  - 위험요소/체크리스트/DoD에 투사체 동기화 항목 추가
- 기대 효과:
  - 구현자 변경 시에도 동일한 판정 품질 유지
  - 시각 연출과 실제 피해 타이밍 불일치 이슈를 사전 차단
