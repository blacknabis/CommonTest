# 스테이지 버튼 고도화 계획 (구조 정합화 완료본)

## 1. 개요
월드맵의 스테이지 버튼은 현재 `UIStageNode` 기반으로 표준화되어 있으며, `WorldMapView + WorldMapPresenter + UnlockPolicy` 구조로 데이터 기반 갱신이 동작합니다.  
본 문서는 초기 기획안(개념 설계)에서 **실제 코드 구조** 기준으로 내용을 정합화한 완료 문서입니다.

---

## 2. 목표 대비 구현 상태

### 2.1 프리팹/컴포넌트 표준화
- `UIStageNode` 컴포넌트 기반으로 스테이지 노드 표준화 완료
- 주요 상태 표시(잠금/선택/별/라벨/아이콘) 바인딩 완료

### 2.2 동적 정보 표시
- 별(0~3) 표시 완료
- 잠금 상태 표시 및 비활성 처리 완료
- 잠금 노드 클릭 시 피드백 토스트 처리 완료

### 2.3 안정성/확장성
- ViewModel(`StageNodeViewModel`) 분리 완료
- 잠금 규칙 인터페이스(`IStageUnlockPolicy`) 분리 완료
- StageId 유효성/중복 검사 로직 완료

---

## 3. 현재 코드 기준 데이터 구조

## 3.1 StageData (현행)
초기안은 `StageData : ScriptableObject` 단일 에셋형이었으나, 실제 구현은 `StageConfig` 내 `StageData struct`를 사용합니다.

```csharp
[Serializable]
public struct StageData
{
    public int StageId;
    public string StageName;
    public WaveConfig WaveConfig;
    public StageDifficulty Difficulty;
    public Vector2 Position;
    public List<int> NextStageIds;
    public List<float> StarRequirements;
    public bool IsBoss;
    public bool IsUnlocked;
    public float BestTime;
}
```

## 3.2 진행 데이터 (현행)
초기안의 `UserStageProgress` 전용 클래스 대신, 저장 계층의 `UserSaveData.StageProgressData`를 `UserSaveStageProgressRepository`가 `StageProgressSnapshot`으로 변환해 제공합니다.

```csharp
public sealed class UserSaveStageProgressRepository : IStageProgressRepository
{
    public IReadOnlyDictionary<int, StageProgressSnapshot> GetProgressMap();
    public int GetTotalEarnedStars();
}
```

## 3.3 ViewModel
뷰 바인딩 전용 데이터(`StageNodeViewModel`)를 사용하여 UI와 비즈니스 로직을 분리합니다.

```csharp
public readonly struct StageNodeViewModel
{
    public readonly int StageId;
    public readonly string StageLabel;
    public readonly bool IsUnlocked;
    public readonly bool IsCleared;
    public readonly int EarnedStars;
    public readonly bool IsSelected;
    public readonly bool IsBoss;
    public readonly bool HasNotification;
    public readonly Sprite IconSprite;
}
```

---

## 4. UI 컴포넌트 설계/구현 (현행)

## 4.1 UIStageNode 역할
- `Bind(in StageNodeViewModel vm)`로 멱등 바인딩
- `event Action<int> OnNodeClicked`로 클릭 이벤트 전달
- `Awake/OnValidate`에서 자동 참조 보정(`TryAutoWire`)
- 필수 참조/식별자 검증(`ValidateRequiredReferences`)

## 4.2 상태 반영
- Interactable: `vm.IsUnlocked` 기반
- LockIcon: 잠금 시 표시
- Highlight: 선택 상태 표시
- Stars: 획득 별 수 반영(0~3)
- Label/Icon: 잠금/선택/클리어 상태별 색상 규칙 반영

---

## 5. 월드맵 연동 및 해금 로직 (현행)

## 5.1 해금 정책 인터페이스
`IStageUnlockPolicy`를 통해 정책을 분리했고, 기본 구현은 `DefaultStageUnlockPolicy`입니다.

- 기본 규칙: `Stage 1` 항상 해금
- 나머지: 직전 스테이지 클리어 시 해금
- 선택 규칙: `StarRequirements[0]` 기반 별 조건 병행

## 5.2 WorldMapView 흐름
1. `CollectStageNodes()`로 노드 수집 및 정렬
2. `ValidateStageNodeIds()`로 StageId 유효성/중복 검사
3. `LoadStageData()`로 StageConfig(또는 fallback) 데이터 확보
4. `WorldMapPresenter` 생성(Repository + UnlockPolicy 주입)
5. 노드 클릭 이벤트 연결 및 `RebindAllStageNodes()` 바인딩
6. 잠금 클릭 피드백/해금 선택 처리

---

## 6. 작업 단계(Action Plan) 완료 체크

1. 데이터 계층 구현: **완료**
   - `StageData struct`, `IStageUnlockPolicy`, `IStageProgressRepository`, `UserSaveStageProgressRepository` 적용
2. UI 컴포넌트 구현(`UIStageNode`): **완료**
   - `Bind`, 클릭 이벤트, 자동참조, 안전검사 구현
3. `WorldMapView` 고도화: **완료**
   - 노드 수집/검증/Presenter 연동/잠금 피드백 처리 구현
4. 테스트/검증: **구현 레벨 완료**
   - StageId 중복/유효성 방어 로직 코드 반영 완료
   - 별/잠금/선택 표시 로직 코드 반영 완료

---

## 7. 코드 기준 참조 목록
- `Assets/Scripts/Kingdom/WorldMap/UIStageNode.cs`
- `Assets/Scripts/Kingdom/WorldMap/StageNodeViewModel.cs`
- `Assets/Scripts/Kingdom/WorldMap/IStageUnlockPolicy.cs`
- `Assets/Scripts/Kingdom/WorldMap/DefaultStageUnlockPolicy.cs`
- `Assets/Scripts/Kingdom/WorldMap/UserSaveStageProgressRepository.cs`
- `Assets/Scripts/Kingdom/WorldMap/WorldMapPresenter.cs`
- `Assets/Scripts/Kingdom/UI/WorldMapView.cs`
- `Assets/Scripts/Kingdom/WorldMap/StageConfig.cs`

---

## 8. 결론
스테이지 버튼 고도화는 현재 코드 기준으로 핵심 요구사항이 충족되어 **완료 상태**입니다.  
초기 기획안과의 차이는 데이터 모델 표현 방식(`StageData` SO 단일형 → `StageConfig + struct`)이며, 이는 현행 구조로 정합화 문서에 반영되었습니다.
