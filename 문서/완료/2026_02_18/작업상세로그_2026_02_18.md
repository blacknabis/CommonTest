# 작업 상세 로그 (2026-02-18)

## 1. 개요
- 웨이브 시작 시 몬스터가 즉시 출현하는 문제 수정
- Early Call(다음 웨이브 즉시 시작) 버튼 로직 수정

## 2. 변경 사항

### A. 웨이브 시작 지연 (Wave Start Delay)
- **변경 파일**: `WaveManager.cs`, `SpawnManager.cs`
- **내용**:
  - `WaveManager`에서 `SpawnManager.SpawnWave` 호출 시 `initialDelay` 파라미터(2.0f) 전달.
  - `SpawnManager`는 해당 지연 시간만큼 대기 후 첫 몬스터 스폰.
- **이유**: 웨이브 시작 직후 플레이어가 준비할 시간을 확보하고, UI 연출 등의 여유를 주기 위함.

### B. Early Call 로직 수정
- **변경 파일**: `GameStateController.cs`, `GameView.cs`
- **내용**:
  - 기존: `WaveRunning` 상태에서만 호출 가능 -> 수정: `Prepare` 또는 `WaveBreak` 상태에서만 호출 가능.
  - `TryEarlyCallNextWave` 호출 시 남은 시간(`remainingTime`)을 반환하도록 변경하여 보너스 골드 계산 가능성 열어둠.
  - `GameView`에서 해당 메서드 호출 성공 시 로그 출력.
- **이유**: '대기 시간 건너뛰기' 기능이므로, 웨이브 진행 중이 아니라 대기 중일 때 동작하는 것이 논리적으로 타당함.

## 3. 검증 결과
- [x] 게임 시작 시 첫 웨이브 몬스터가 약 2초 후 출현 확인.
- [x] 웨이브 종료 후 휴식 시간(Break)에 'Next Wave' 버튼 활성화 확인.
- [x] 'Next Wave' 버튼 클릭 시 즉시 다음 웨이브 시작 로그 확인.

## 4. 문서 고도화 작업 (오늘 추가)

### A. 플랜 문서 실행형 스펙 보강
- **대상 파일**: `문서/진행/전투_웨이브_준비시간_고도화_작업계획_2026_02_18.md`
- **반영 내용**:
  - 상태 전이표, 이벤트 계약, 보상 수식, QA, 롤백, 텔레메트리, 기능 플래그, ADR-lite 추가
  - 구현 착수용 작업 분할(담당/산출물/완료조건), 커밋 계획, 즉시 실행 TODO 추가
  - TimeScale 정책 충돌 정리: `Scaled Time(Time.deltaTime)` 기준으로 통일

### B. Task 문서 동기화
- **대상 파일**: `문서/진행/task.md`
- **반영 내용**:
  - 웨이브 준비시간 트랙 기준 문서/로그 연결 명시
  - `Phase 0. 설계/문서 동기화` 완료 항목 추가
  - 최근 완료 항목에 "웨이브 준비시간 고도화 문서 보강" 추가

### C. 3종 문서 정합성 맞춤
- **동기화 대상**:
  1) `문서/진행/task.md`
  2) `문서/진행/전투_웨이브_준비시간_고도화_작업계획_2026_02_18.md`
  3) `문서/진행/작업상세로그_2026_02_18.md`
- **정합화 결과**:
  - 메인 기준 문서가 플랜 문서로 통일됨
  - 구현 전/후 구분(설계 완료 vs 코드 적용 대기)이 명확해짐
  - 로그 기준으로 오늘 작업 이력이 추적 가능해짐

## 5. 현재 상태 요약
- 문서 설계: 완료
- 코드 구현: 대기 (task 체크리스트 기준 Phase 1~3 미완료)
- 다음 액션: `GameStateController`/`WaveManager`/`GameView` 코드 반영 시작

## 6. 코드 반영 진행 로그 (오늘 추가)

### A. `GameStateController` 상태 흐름 개편
- `GameFlowState`에 `WaveReady` 추가
- 상태 전이 변경:
  - `Prepare -> WaveReady -> WaveRunning`
  - `WaveBreak -> WaveReady`
- 조기 호출 허용 상태를 `WaveRunning`에서 `WaveReady`로 이동
- `WaveReadyRemaining`, `WaveReadyTimeChanged` 추가로 UI 연동 기반 마련

### B. `WaveManager` 스폰 트리거 분리
- `WaveRunning` 진입 시점에만 스폰
- `_spawnStartedWaveIndex`로 같은 웨이브 중복 스폰 차단
- `Prepare/Result` 상태에서 스폰 인덱스 리셋

### C. `GameScene` HUD/보상 연동 조정
- `NextWave` 버튼 활성 상태를 `WaveReady` 기준으로 변경
- 조기 호출 보상 계산 기준을 `WaveDuration-경과시간`에서 `WaveReadyRemaining`으로 변경
- `WaveReadyTimeChanged` 구독하여 HUD 카운트다운 업데이트 연결

### D. `GameView` 카운트다운 표시 추가
- `txtWaveTimer` 직렬화 필드 추가
- `SetWaveReadyCountdown()`, `HideWaveReadyCountdown()` 추가
- `txtWaveTimer`가 없을 때 `txtStateInfo` 폴백 표기

## 7. 현재 잔여 작업
- [x] 조기 호출 시 쿨타임 감소 로직 세부 보정(남은 준비시간 비례)
- [ ] 실제 프리팹에 `txtWaveTimer` 배치 여부 확인
- [ ] 플레이모드 회귀 테스트 및 로그 확정

## 8. 조기 호출 쿨타임 감소 수치 보정 (추가)

### A. 적용 내용
- 대상: `Assets/Scripts/Kingdom/App/GameScene.cs`
- 변경점:
  - 조기 호출 보상 시 쿨타임 감소를 고정치에서 "남은 `WaveReady` 시간 비례"로 변경
  - 보정 함수 `GetScaledEarlyCallCooldownReduction(...)` 추가
  - 최소 보정 배율 상수 `EarlyCallCooldownMinRatio = 0.35f` 도입

### B. 수식
- `t = clamp01(remainingReadySeconds / waveReadyDuration)`
- `ratio = lerp(0.35, 1.0, t)`
- `finalReduction = baseReduction * ratio`

### C. 의도
- 늦은 타이밍 조기 호출도 완전 무가치가 되지 않도록 최소 혜택 보장
- 빠른 조기 호출일수록 더 큰 쿨타임 이득 제공
- 과도한 즉시 충전 방지(상한은 기존 SpellConfig 값 유지)

## 9. prefab 처리 결정
- `Assets/Resources/UI/GameView.prefab`의 `txtWaveTimer` 직렬화 필드는 `0`(미연결)로 유지.
- 이유:
  1. 현재 `GameView`는 `txtWaveTimer`가 없으면 `txtStateInfo`로 안전 폴백하도록 구현됨
  2. prefab YAML에 신규 TMP 블록 수기 삽입은 리스크가 높아 에디터 배치 작업으로 분리하는 것이 안전
- 후속:
  - Unity Editor에서 `txtWaveTimer` 오브젝트를 배치/바인딩하고 시각 위치를 조정

## 10. 수동 회귀 테스트 절차 (즉시 실행용)

### 테스트 환경
- Scene: `GameScene`
- 배속 토글: x1, x2 각각 1회 이상 확인
- 입력: `Next Wave` 버튼 클릭 + Pause/Resume

### 시나리오 A. 첫 진입 준비시간
1. 게임 진입 후 첫 웨이브 즉시 스폰 여부 확인
2. `WaveReady` 구간에서 몬스터가 스폰되지 않는지 확인
3. 카운트다운 종료 후 `WaveRunning`으로 전환되며 스폰 시작되는지 확인

기대 결과:
- 첫 진입 직후 즉시 스폰 없음
- 준비시간 동안 `Next Wave` 버튼 활성
- 준비시간 종료 시 웨이브 자동 시작

실행 결과(사용자 확인):
- PASS: 시작 시 몬스터 즉시 출현하지 않음
- PASS: `Prepare/WaveReady` 구간 이후 약 3초 후 스폰 시작 확인

### 시나리오 B. 조기 호출 보상
1. `WaveReady` 시작 직후 `Next Wave` 클릭
2. 이후 웨이브에서 `WaveReady` 종료 직전에 `Next Wave` 클릭
3. 두 경우의 골드 증가량/스킬 쿨타임 감소량 비교

기대 결과:
- 시작 직후 조기호출의 보상이 더 큼
- 종료 직전 조기호출도 최소 보상(쿨타임 감소) 존재
- 한 웨이브에서 중복 보상 미발생

실행 결과(사용자 확인):
- PASS: 시작 직후 클릭이 종료 직전 클릭보다 보상이 큼

### 시나리오 C. Pause/Resume 안정성
1. `WaveReady` 중 Pause
2. 3초 대기 후 Resume
3. 남은 준비시간이 Pause 전후로 동일한지 확인

기대 결과:
- Pause 중 준비시간이 감소하지 않음

실행 결과(사용자 확인):
- PASS: 일시정지 중 준비시간 감소 없음

### 시나리오 D. 최종 웨이브/결과
1. 마지막 웨이브 진입/완료
2. 결과 UI 노출 확인

기대 결과:
- 마지막 웨이브 완료 후 `Result` 정상 전환
- 불필요한 `WaveReady` 재진입 없음

실행 결과(사용자 피드백):
- 이슈: 마지막 웨이브에서 모든 몬스터 처치 후 Victory 노출이 지연되는 체감 존재

원인 분석/조치:
- 기존 FSM은 `waveDuration` 타이머 만료에 의존해 `Result`로 이동하여, 적이 일찍 정리되어도 상태 전환이 늦을 수 있음
- 조치 코드 반영:
  - `WaveManager`에서 `스폰 완료 + 생존 적 0` 시 즉시 웨이브 완료 신호 전송
  - `GameStateController.TryCompleteCurrentWave()` 추가
  - 마지막 웨이브면 즉시 `Result`, 아니면 `WaveBreak`로 즉시 전환

재검증 결과(사용자 확인):
- PASS: 마지막 몬스터 처치 직후 Victory가 즉시 표시됨

## 11. 회귀 테스트 자동 체크러너 (보류)

- 요청 사항(텍스트 목적 툴 제거)에 따라 관련 자동 체크러너 코드는 적용 취소함.
- 본 작업의 검증 결과는 수동 회귀 테스트 로그(섹션 10) 기준으로 유지.
