# 전투 웨이브 준비시간 고도화 작업계획 (2026-02-18)

## 0) 문서 목적 / 범위
- 목적: 게임씬 진입 직후 웨이브가 즉시 시작되는 문제를 해결하고, **킹덤러시 스타일의 준비-전투 템포**를 구현한다.
- 범위: 상태머신(`GameStateController`)·웨이브 스폰(`WaveManager`)·HUD(`GameView`)·보상/스킬 쿨타임 로직의 설계 및 단계별 적용 계획.
- 비범위(본 문서 직접 구현 제외): 아트 리소스 제작, 사운드 리소스 녹음/믹싱, 세부 밸런스 최종값 확정.

## 1) 현재 문제 요약
- 게임씬 진입 후 `Prepare` 상태가 매우 짧게 지나가며(기본 1초), 곧바로 `WaveRunning`으로 전환된다.
- `WaveRunning` 진입 이벤트에서 즉시 스폰이 시작되어, 플레이어가 타워 배치/영웅 위치 조정/스킬 준비를 할 시간이 부족하다.

## 2) 코드 기준 원인 분석 (현행)
### A. 상태 전환 속도
- `Prepare`에서 `prepareDuration` 경과 시 바로 1웨이브로 진입.
- 확인 지점
  - `Prepare -> WaveRunning` 전환: `Assets/Scripts/Kingdom/Game/GameStateController.cs` 59~65라인
  - 기본 설정값: `prepareDuration = 1.0f`: 23라인

### B. 스폰 시작 트리거 결합
- `WaveManager`는 `StateChanged`에서 `WaveRunning` 상태를 받으면 즉시 `SpawnWave()`를 호출.
- 확인 지점
  - 상태 수신 및 분기: `Assets/Scripts/Kingdom/Game/WaveManager.cs` 78~83라인
  - 즉시 스폰 호출: 102~104라인

### C. 결과
- **상태 진입과 스폰 시작이 결합**되어 있어, 준비시간이 사실상 체감되지 않는다.

## 3) 목표 (킹덤러시 스타일)
1. 웨이브 시작 전 명확한 **전투 준비 구간** 제공
2. 플레이어가 버튼/카운트다운으로 **주도적으로 웨이브 시작** 가능
3. 시간 만료 시 자동 시작으로 템포 유지
4. 조기 호출(Early Call)에 대한 **명시적 보상(골드 + 쿨타임 혜택)** 제공
5. 초반 온보딩은 여유 있게, 후반은 빠르게(데이터 기반)

## 4) 목표 지표 (KPI / 완료 기준)
- KPI-1: 게임씬 진입 후 첫 적 스폰까지 최소 `4~6초` 확보
- KPI-2: `Next Wave` 수동 호출 사용률 `30%+`(튜토리얼 종료 이후 기준)
- KPI-3: 조기 호출 후 30초 내 타워/스킬 사용률 증가
- KPI-4: “준비할 시간 부족” 관련 피드백 빈도 감소
- 완료 기준(Definition of Done)
  - 기능/상태/UI/보상/검증 체크리스트 전부 통과
  - 예외 케이스(일시정지, 최종웨이브, 재시도) 회귀 테스트 통과

## 5) 핵심 설계안
### 5-1. 상태 모델 개선
- 기존: `Prepare -> WaveRunning -> WaveBreak -> Result`
- 개선:
  - `Prepare` : 전투 최초 준비
  - `WaveReady` : 웨이브별 준비(카운트다운, 조기 호출 가능)
  - `WaveRunning` : 실제 스폰/전투
  - `WaveBreak` : 웨이브 종료 후 정비
  - `Result`, `Pause`

> 최소 변경이 필요하면 `WaveReady`를 추가하지 않고 1웨이브 시작 전 `WaveBreak` 재활용도 가능하나, 가독성과 유지보수 측면에서 `WaveReady` 신설을 권장.

### 5-2. 스폰 트리거 분리
- 원칙: `WaveRunning` 상태 진입만으로 스폰하지 않는다.
- 방식:
  1. `WaveManager`에서 현재 웨이브 `spawnArmed`(또는 동등 플래그) 확인
  2. `spawnArmed == true`일 때만 `SpawnWave()` 실행
  3. `NextWaveRequested` 또는 카운트다운 만료 시 `spawnArmed = true` 후 전환/실행

### 5-3. 조기 호출(Early Call) 보상 로직
- NotebookLM 레퍼런스 반영:
  - 남은 카운트다운 시간(초)당 골드 지급
  - 영웅 스펠/지원군 쿨타임 즉시 감소
- 제안 수식(초기안)
  - `bonusGold = floor(remainingSeconds * goldPerSecond)`
  - `cooldownReduce = remainingSeconds * cooldownReduceRatio`
  - 기본값: `goldPerSecond=1`, `cooldownReduceRatio=1.0`

### 5-4. UI/UX
- HUD
  - 카운트다운 텍스트 + 진행바
  - `btnNextWave` 상태별 활성 제어
- 확장안
  - 경로 입구 `Monster Icon` 배치
  - 아이콘 클릭: 조기 호출, 호버/탭: 등장 적 정보 표시
- 피드백
  - 웨이브 시작 배너 + SFX + (모바일) 약한 진동

## 6) 영향 파일 / 변경 포인트
### 필수
1. `Assets/Scripts/Kingdom/Game/GameStateController.cs`
   - `GameFlowState`에 `WaveReady` 추가(또는 대체 구현)
   - 준비/브레이크/웨이브 구간 시간 제어 분리
2. `Assets/Scripts/Kingdom/Game/WaveManager.cs`
   - 상태 전환과 스폰 호출 분리
   - 조기 호출 시 보상 이벤트 또는 콜백 연결 지점 추가
3. `Assets/Scripts/Kingdom/UI/GameView.cs`
   - 카운트다운, `Next Wave` 버튼 상태, 준비 상태 표기 강화

### 선택(구조 정리 시)
4. 웨이브 보상/쿨타임 관리용 전용 서비스(예: `WaveRewardService`) 신설
5. 난이도/스테이지 프리셋 데이터 파일 확장

## 7) 단계별 실행 계획
### 1단계: 즉시 체감 개선 (반나절~1일)
- `prepareDuration` 상향(예: 1.0s -> 5.0s)
- 첫 웨이브 시작 전 카운트다운 추가(3~5초)
- 리스크: 구조 결합은 남아 재확장 시 재작업 가능성 존재

### 2단계: 구조 개선 (1~2일)
- `WaveReady` 상태 도입
- `WaveManager`의 스폰 게이트 플래그 도입
- `GameView.NextWaveRequested`를 상태머신 이벤트로 연결

### 3단계: 보상 고도화 (1일)
- 조기 호출 보상: 골드 + 스킬 쿨타임 감소 적용
- 밸런스 파라미터 외부화(`goldPerSecond`, `cooldownReduceRatio`)

### 4단계: UX 연출 강화 (1일+)
- 웨이브 배너/SFX/아이콘 상호작용 도입
- 스폰 지점 아이콘 클릭형 Early Call 확장

## 8) 리스크 및 대응
1. **Pause/Resume 시간 불일치**
   - 대응: 본 플랜의 기본 정책은 `Scaled Time(Time.deltaTime)` 단일화. Pause 시 자연 정지 보장
2. **중복 스폰/중복 보상**
   - 대응: 웨이브별 `isSpawnStarted`, `isEarlyCallConsumed` 플래그 강제
3. **최종 웨이브 처리 충돌**
   - 대응: 최종 웨이브는 `NextWave` 비활성 및 결과 전환 우선 규칙 고정
4. **튜토리얼 체감 저하(너무 긴 대기)**
   - 대응: 첫 스테이지 전용 파라미터 프리셋 분리

## 9) 테스트 계획 (QA 체크리스트)
### 기능
- [ ] 게임씬 진입 직후 즉시 적 스폰이 발생하지 않는다.
- [ ] 준비 구간에서 타워 건설/영웅 조정/스킬 확인이 가능하다.
- [ ] `Next Wave` 호출 시 즉시 시작되며, 중복 호출이 무시된다.
- [ ] 카운트다운 만료 시 자동 시작된다.
- [ ] 마지막 웨이브 후 `Result` 전환이 정상 동작한다.

### 보상
- [ ] 조기 호출 골드 보상이 남은 시간에 비례해 정확히 지급된다.
- [ ] 스킬 쿨타임 감소가 즉시 반영되며 음수 쿨타임이 발생하지 않는다.

### 안정성
- [ ] Pause/Resume 반복 중 카운트다운/보상 계산이 일관된다.
- [ ] Retry/맵 복귀 후 상태가 깨끗하게 초기화된다.

## 10) NotebookLM 검증 로그 반영 요약
NotebookLM("킹덤러쉬" 노트북) 기준으로 다음 메커니즘을 계획에 반영:
1. 조기 호출 보상은 단순 버튼 UX가 아니라 **의미 있는 위험-보상 구조**여야 함
2. 웨이브 예고는 텍스트만이 아니라 **경로 기반 시각 단서(아이콘)**가 효과적
3. 액션 피드백은 사운드/시각 타이밍이 맞아야 체감이 살아남

### 10-1. 웨이브 준비 시간 분포 (Deep Dive)
- **권장 분포**: 초반(1~3웨이브)은 튜토리얼 성격으로 매우 여유롭게 설정. 중후반은 짧게 설정하여 플레이어가 `Early Call`을 통해 골드를 벌도록 유도.
- **핵심 철학**: "기다리기 지루한 시간"이 아니라 "전략을 수정할 시간"을 제공하되, 숙련자는 이를 **자원(골드/쿨타임)**으로 환전할 수 있어야 함.

### 10-2. Early Call 보상 밸런스 경고
- **위험 요소**: 보상이 과도하면 타워 배치 전략보다 "고비용 타워 스팸"이 유리해져 전략성이 붕괴됨.
- **안전 장치**:
  - `goldPerSecond`는 기본 타워 가격의 1/50~1/100 수준으로 보수적 접근 권장.
  - 쿨타임 감소도 '즉시 충전'이 아니라 '남은 시간만큼 단축'으로 제한해야 함.

### 10-3. 스폰 아이콘 UX 가이드 (모바일/패드)
- **이중 기능(Dual Function)**: 아이콘은 **정보 제공(Info)**과 **속도 조절(Control)**을 동시에 수행해야 함.
- **구현 권장안**:
  - **Tap**: 웨이브 조기 호출 (확인 팝업 없이 즉시 실행, 단 실수 방지용 롱탭/더블탭 고려 가능).
  - **Long Press / Info Button**: 등장 적 상세 정보 팝업.
  - **시각 알림**: 화면 밖 스폰 시 가장자리에 인디케이터 표시 필수.


## 11) 최종 우선순위
1. **P0**: 첫 웨이브 준비시간 확보 + 스폰 분리(즉시 문제 해결)
2. **P1**: 조기 호출 보상(골드+쿨타임) 및 중복 방지
3. **P2**: 데이터 기반 템포 프리셋/연출 강화/아이콘 상호작용


## 12) 구현 상세 명세 (Technical Specs)
개발자가 바로 작업에 착수할 수 있도록 **상태 전이/이벤트 계약/데이터/예외 처리**를 명시한다.

### 12-1) 상태 전이 명세 (`GameStateController`)
#### 상태 정의
- `Prepare`: 전투 최초 준비(초기 배치/설명)
- `WaveReady`: 웨이브 시작 직전 준비(카운트다운/조기 호출 허용)
- `WaveRunning`: 실제 스폰 및 전투 진행
- `WaveBreak`: 웨이브 종료 후 정비
- `Pause`, `Result`

#### 전이 표
| 현재 상태 | 트리거 | 다음 상태 | 비고 |
|---|---|---|---|
| `Prepare` | `prepareDuration` 만료 | `WaveReady` | `CurrentWave = 1` 설정 |
| `WaveReady` | 조기 호출 성공 | `WaveRunning` | 보상 계산/지급 |
| `WaveReady` | 카운트다운 만료 | `WaveRunning` | 자동 시작 |
| `WaveRunning` | 웨이브 종료 조건 충족 | `WaveBreak` 또는 `Result` | 마지막 웨이브면 `Result` |
| `WaveBreak` | `waveBreakDuration` 만료 | `WaveReady` | `CurrentWave++` |
| `Pause` | Resume | 이전 상태 | 타이머 일관성 유지 |

#### 코드 레벨 변경 포인트
- `GameFlowState`에 `WaveReady` 추가
- 인스펙터 파라미터
  - `prepareDuration` (초기 준비)
  - `waveReadyDuration` (웨이브 준비)
  - `waveBreakDuration` (웨이브 간 정비)
- 런타임 필드
  - `_waveReadyRemainingUnscaled`
  - `_isEarlyCallConsumedForCurrentWave`

### 12-2) 이벤트 계약 (Controller ↔ View ↔ WaveManager)
#### 신규/확장 이벤트
- `GameStateController`
  - `event Action<float> WaveReadyTimeChanged` : 남은 준비시간(초)
  - `event Action<int, int> EarlyCallRewardCalculated` : `(gold, cooldownReduceSec)`

#### 메서드 계약
- `bool TryEarlyCallNextWave()`
  - 성공 조건: `CurrentState == WaveReady` && `!_isEarlyCallConsumedForCurrentWave`
  - 성공 시:
    1. 보상 계산
    2. 보상 이벤트 발행
    3. `WaveRunning` 전환
  - 실패 시 `false` 반환(중복 호출/잘못된 상태)

### 12-3) 스폰 제어 명세 (`WaveManager`)
- `OnStateChanged()` 분기 규칙
  - `WaveReady`: 스폰 시작 금지
  - `WaveRunning`: 웨이브당 1회만 `SpawnWave()` 실행
- 보호 플래그
  - `_spawnStartedWaveIndex`
  - 동일 웨이브 재진입 시 중복 스폰 차단
- 종료 조건
  - 기존 `_spawnCompletedForCurrentWave && _aliveEnemyCount <= 0` 판단 유지
  - 웨이브 완료 이벤트를 상태머신으로 전달(또는 폴링 유지하되 일관화)

### 12-4) HUD/UI 명세 (`GameView`)
#### UI 요소
- `txtWaveTimer`: `WaveReady`에서 `"NEXT WAVE IN {n}"` 표시
- `btnNextWave` 인터랙션
  - `WaveReady`: 활성
  - `Prepare`, `WaveRunning`, `Result`: 비활성
  - `Pause`: 상태 유지(입력 차단 정책에 맞춤)

#### 표시 우선순위
1. `Pause` 문구가 최우선
2. 그 외 상태 텍스트(`Prepare`, `WaveReady`, `WaveRunning`)
3. `WaveReady`일 때만 타이머 노출

### 12-5) 보상 계산 명세
#### 입력값
- `remainingSeconds`: 조기 호출 시점의 남은 시간
- `goldPerSecond`: 초당 골드
- `cooldownReduceRatio`: 쿨타임 감소 배율

#### 수식
- `bonusGold = floor(remainingSeconds * goldPerSecond)`
- `cooldownReduceSec = remainingSeconds * cooldownReduceRatio`

#### 경계값
- `remainingSeconds <= 0` 이면 보상 0
- 모든 결과값 `>= 0` 클램프
- 쿨타임 감소 적용 시 스킬별 최소값 0 보장

### 12-6) 데이터 스키마 확장안
`WaveConfig.WaveData` 또는 별도 밸런스 SO에 다음 항목 추가 검토:
- `float ReadyDurationOverride` (기본 -1: 전역값 사용)
- `int EarlyCallGoldPerSecondOverride` (기본 -1: 전역값 사용)
- `float EarlyCallCooldownReduceRatioOverride` (기본 -1f)

## 13) 구현 순서(작업 오더)
1. `GameStateController`에 `WaveReady` + 타이머/조기호출 처리 구현
2. `WaveManager` 중복 스폰 방지 플래그 적용
3. `GameView` 타이머/버튼 상태 연동
4. 보상 이벤트 소비처(골드/스킬 시스템) 연결
5. QA 체크리스트 기반 기능/회귀 검증

## 14) 수용 기준(Release Gate)
- 필수 게이트
  - 첫 웨이브 스폰 전 준비시간 확보
  - 조기 호출 단일 소비 보장(중복 보상 없음)
  - Pause/Resume 후 타이머 드리프트 없음
  - 최종 웨이브 결과 전환 정상
- 권장 게이트
  - 조기 호출 사용률/평균 보상량 텔레메트리 수집
  - 난이도별 준비시간 프리셋 A/B 비교 가능 상태

## 15) 롤백 계획
- 장애 발생 시 단계적 롤백:
  1. `WaveReady` 비활성 플래그 ON(기존 흐름 복귀)
  2. 조기 호출 보상 로직만 OFF
  3. UI 타이머 표시 OFF
- 롤백 후에도 저장 데이터/진행 상태 호환되도록 enum 추가 시 직렬화 영향 점검 필수

## 16) 코드 적용안 (Pseudo Code)
아래는 실제 구현 전 팀 내 합의용 의사코드다.

### 16-1) `GameStateController.Update()` 핵심 분기
```csharp
switch (CurrentState)
{
    case GameFlowState.Prepare:
        if (elapsed >= prepareDuration)
        {
            CurrentWave = 1;
            EnterWaveReady();
        }
        break;

    case GameFlowState.WaveReady:
        _waveReadyRemainingUnscaled -= deltaUnscaled;
        WaveReadyTimeChanged?.Invoke(_waveReadyRemainingUnscaled);
        if (_waveReadyRemainingUnscaled <= 0f)
        {
            ChangeState(GameFlowState.WaveRunning);
        }
        break;

    case GameFlowState.WaveRunning:
        // 기존 웨이브 진행/종료 처리
        break;
}
```

### 16-2) `TryEarlyCallNextWave()` 의사코드
```csharp
if (CurrentState != GameFlowState.WaveReady) return false;
if (_isEarlyCallConsumedForCurrentWave) return false;

float remain = Mathf.Max(0f, _waveReadyRemainingUnscaled);
int bonusGold = Mathf.FloorToInt(remain * goldPerSecond);
float cooldownReduce = Mathf.Max(0f, remain * cooldownReduceRatio);

_isEarlyCallConsumedForCurrentWave = true;
EarlyCallRewardCalculated?.Invoke(bonusGold, Mathf.CeilToInt(cooldownReduce));
ChangeState(GameFlowState.WaveRunning);
return true;
```

### 16-3) `WaveManager.OnStateChanged()` 의사코드
```csharp
if (state != GameFlowState.WaveRunning) return;
if (_spawnStartedWaveIndex == stateController.CurrentWave) return;

_spawnStartedWaveIndex = stateController.CurrentWave;
spawnManager.SpawnWave(waveConfig.Waves[waveIndex], pathManager);
```

## 17) 텔레메트리/로그 수집 설계
분석 가능한 개선 여부를 확인하기 위해 이벤트 스키마를 먼저 정의한다.

### 17-1) 필수 이벤트
1. `wave_ready_started`
   - 속성: `stageId`, `waveIndex`, `readyDurationSec`
2. `wave_early_call`
   - 속성: `stageId`, `waveIndex`, `remainingSec`, `bonusGold`, `cooldownReduceSec`
3. `wave_started`
   - 속성: `stageId`, `waveIndex`, `startType(auto|early_call)`
4. `wave_completed`
   - 속성: `stageId`, `waveIndex`, `elapsedSec`, `livesLeft`

### 17-2) KPI 계산식
- 조기 호출 사용률 = `wave_early_call count / wave_ready_started count`
- 평균 보상 골드 = `sum(bonusGold) / wave_early_call count`
- 준비시간 체감 지표(대체) = `wave_ready_started - wave_started` 구간의 중앙값

## 18) 기능 플래그 전략
배포 리스크를 줄이기 위해 단계별 플래그를 둔다.

- `Feature.WaveReadyEnabled` : 새 상태머신 on/off
- `Feature.EarlyCallRewardEnabled` : 보상 지급 on/off
- `Feature.WaveTimerUIEnabled` : 카운트다운 UI on/off
- `Feature.SpawnEntryIconEnabled` : 맵 아이콘 UX on/off

> 권장: QA/스테이징에서 조합 테스트 후 운영 반영.

## 19) 상세 QA 테스트케이스 (추가)
### 19-1) 상태 전이
- [ ] `Prepare` 종료 후 `WaveReady`로 진입한다.
- [ ] `WaveReady` 중 Pause/Resume 후 남은 시간이 비정상 점프하지 않는다.
- [ ] `WaveReady` 타이머 0 도달 시 정확히 1회 `WaveRunning`으로 진입한다.

### 19-2) 조기 호출
- [ ] `WaveReady`에서만 조기 호출이 성공한다.
- [ ] 같은 웨이브에서 2회 이상 조기 호출 시 보상이 중복 지급되지 않는다.
- [ ] 조기 호출 직후 `wave_started(startType=early_call)` 이벤트가 남는다.

### 19-3) 스폰 안정성
- [ ] 상태 재진입/Resume 상황에서 같은 웨이브 중복 스폰이 없다.
- [ ] 마지막 웨이브는 `Result` 전환이 우선되며 `WaveReady`로 가지 않는다.

## 20) 최종 실행 백로그 (체크리스트)
- [ ] `GameStateController`에 `WaveReady` 상태/타이머/이벤트 추가
- [ ] `TryEarlyCallNextWave()` 계약을 `WaveReady` 기준으로 재정의
- [ ] `WaveManager` 중복 스폰 방지 플래그 적용
- [ ] `GameView` 타이머/버튼 상태 매핑 적용
- [ ] 골드/스킬 시스템과 보상 이벤트 연결
- [ ] 기능 플래그 주입 및 기본값 정의
- [ ] 텔레메트리 이벤트 송신 구현

## 21) 엣지 케이스 및 안정성 확보 (Edge Cases & Stability)
### 21-1. TimeScale 및 Pause
- **문제**: `Time.timeScale = 0` (일시정지) 또는배속 모드 시 타이머 동작 확인 필요.
- **결정(정합성 반영)**:
  - 문서 내 타이머 정책을 **단일 기준으로 통일**한다.
  - 웨이브 준비시간은 체감/공정성 관점에서 **Pause 시 멈춰야 하므로 Scaled Time(`Time.deltaTime`)** 사용을 기본 정책으로 채택한다.
  - 배속(x2)에서는 준비시간도 함께 빨라져도 무방한지 기획 합의가 필요하며, 기본값은 **배속 영향 받음**으로 둔다.
- **해결**:
  - 변수명 정리: `_waveReadyRemainingUnscaled` -> `_waveReadyRemaining`
  - 계산식 정리: `delta = Time.deltaTime`
  - Pause 중 타이머 동결을 별도 분기 없이 `timeScale=0`로 자연 보장
  - 단, 향후 "UI 연출 전용 타이머"가 필요하면 그때만 `unscaledDeltaTime`을 별도 사용

### 21-2. 씬 전환 및 비동기 로드
- **문제**: `WaveReady` 상태에서 씬 재시작(Retry) 또는 월드맵 이동 시.
- **해결**:
  - `OnDestroy` 또는 `OnDisable`에서 타이머 코루틴/이벤트 구독 해제 필수.
  - `GameStateController` 초기화 시 `currentWave`, `state` 등 모든 변수 리셋 확인.

### 21-3. 보상 어뷰징 방지
- **문제**: 매크로 등을 통해 `TryEarlyCallNextWave()`를 한 프레임에 수십 번 호출.
- **해결**:
  - `_isEarlyCallConsumedForCurrentWave` 플래그 체크를 **가장 먼저** 수행.
  - 보상 지급 로직은 상태 전환 직전에 1회만 실행되도록 원자성 보장.

### 21-4. 저장/로드 (Save/Load)
- **문제**: `WaveReady` 상태에서 게임 강제 종료 후 이어하기 시.
- **해결**:
  - 저장 데이터에 `CurrentState = WaveReady` 및 `RemainingTime`을 포함하거나,
  - **단순화 전략**: 로드 시 무조건 `WaveReady` 시작 시간으로 리셋 (플레이어에게 유리한 판정).

## 22) 최종 점검 사항 (Sanity Check)
- [ ] 튜토리얼 스테이지에서도 `WaveReady`가 동작하는가? (필요 시 튜토리얼은 `waveReadyDuration = 0` 처리)
- [ ] 마지막 웨이브 클리어 후 `WaveReady`로 넘어가지 않고 `Result`로 가는가?
- [ ] `SpawnManager`가 `WaveReady` 동안 몬스터를 스폰하지 않고 대기하는가?

## 23) 구현 정책 결정 로그 (ADR-lite)
문서 내 충돌 가능성이 있는 선택지를 명시적으로 잠금한다.

### ADR-01. WaveReady 타이머 시간원 선택
- 선택: **Scaled Time(`Time.deltaTime`)**
- 이유: Pause 시 타이머 정지, 전투 속도와 준비 속도의 일관성 유지
- 기각안: `unscaledDeltaTime` (Pause 중 진행되는 오해/버그 가능성)

### ADR-02. 조기 호출 보상 지급 타이밍
- 선택: **상태 전환 직전 1회 지급**
- 이유: 중복 지급 차단이 쉬움, 디버그 로그 추적 용이
- 기각안: `WaveRunning` 진입 후 지급 (재진입/중복 호출 시 방어 비용 증가)

### ADR-03. 마지막 웨이브의 WaveReady 진입 여부
- 선택: 마지막 웨이브 시작 전에는 `WaveReady` 허용, 마지막 웨이브 완료 후엔 즉시 `Result`
- 이유: 전 웨이브 동일 UX 제공 + 종료 흐름 단순화

## 24) 실제 작업 분할 (담당/산출물/완료조건)
### A. FSM/게임플로우
- 대상: `GameStateController`
- 산출물: `WaveReady` 상태, 타이머, 조기호출 메서드/이벤트
- 완료조건:
  - [ ] 상태 전이표(12-1)와 100% 일치
  - [ ] Pause/Resume 시 타이머 드리프트 0

### B. 스폰/웨이브 런타임
- 대상: `WaveManager`
- 산출물: 중복 스폰 방지, 상태 연동 방어코드
- 완료조건:
  - [ ] 같은 웨이브에서 `SpawnWave()` 1회만 호출
  - [ ] `WaveReady` 상태에서 스폰 0건

### C. HUD/입력
- 대상: `GameView`
- 산출물: 타이머 표시, `NextWave` 버튼 상태 매핑
- 완료조건:
  - [ ] 상태별 버튼 활성 규칙 준수
  - [ ] 타이머 표시 지연/깜빡임 없음

### D. 보상/연동
- 대상: 골드/스킬 쿨다운 소비처
- 산출물: `EarlyCallRewardCalculated` 이벤트 소비
- 완료조건:
  - [ ] 골드/쿨타임 감소 정확도 테스트 통과
  - [ ] 중복 지급 0건

## 25) 커밋 계획 (권장)
1. `feat(gameflow): add WaveReady state and timer`
2. `feat(wave): guard duplicate spawn by wave index`
3. `feat(ui): show wave ready timer and next-wave state mapping`
4. `feat(reward): apply early-call gold and cooldown reduction`
5. `test(gameflow): add wave-ready transition and edge-case checks`

## 26) 즉시 실행용 TODO (오늘 기준)
- [ ] `GameStateController` 상태 enum/Update 분기 수정
- [ ] `TryEarlyCallNextWave()` 조건을 `WaveReady`로 이동
- [ ] `WaveManager`에 `_spawnStartedWaveIndex` 도입
- [ ] `GameView` 타이머 텍스트 바인딩 추가
- [ ] 최소 1개 스테이지에서 수동 테스트 영상/로그 확보

## 27) 문서 동기화 이력 (2026-02-18)
- `task.md`와 본 플랜, 작업상세로그 간 문구/체크리스트 기준을 동기화함.
- 핵심 동기화 항목:
  1. 메인 기준 문서를 본 플랜으로 고정
  2. 상태 정책(Scaled Time) 단일화
  3. Phase(설계 완료/구현 대기) 상태를 `task.md`에 반영
  4. 작업상세로그에 오늘 수행한 문서 보강 내역 누적

