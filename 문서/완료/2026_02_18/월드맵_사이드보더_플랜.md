# 월드맵 사이드 보더 플랜 (보강안)

## 1. 목적
- 아이폰/와이드 비율(예: 19.5:9)에서 월드맵 좌우에 보이는 파란 여백을 제거하거나 시각적으로 자연스럽게 숨긴다.
- 기존 맵 이미지의 비율 왜곡 없이(Stretch 금지) 품질을 유지한다.
- 현재 구조(`WorldMapView`, `imgBackground`, `ViewportSafeAreaLayout`)를 유지하면서 적용 가능하도록 설계한다.

## 2. 현재 원인 정리
- `imgBackground`는 `preserveAspect + EnvelopeParent`로 표시되고 있어, 원본 비율보다 화면이 더 넓은 경우 좌우에 카메라/배경색이 노출된다.
- 즉, “렌더링 버그”가 아니라 “비율 차이로 인한 정상 동작”이다.

## 3. 해결 전략 (권장 우선순위)

### A안. 사이드 보더 장식 추가 (즉시 적용, 리스크 낮음)  **권장**
- 좌우 여백 영역에 장식 패널(절벽/수풀/암석)을 배치해 파란색 노출을 숨긴다.
- 배경 원본을 바꾸지 않으므로 기존 아트/구도 보존에 유리하다.

### B안. 카메라 배경색 보정 (가장 빠름, 보조책)
- 카메라 `Background`를 월드맵 외곽 톤(짙은 녹색/갈색)으로 변경한다.
- 보더 사이에 미세 틈이 생겨도 이질감이 줄어든다.

### C안. 와이드 배경 재생성 (근본 해결, 비용 높음)
- 월드맵 배경 자체를 더 넓은 캔버스로 재생성(예: 2400x1080 이상)하고 좌우 정보를 확장한다.
- 아트 재작업 비용이 높아 후순위로 둔다.

## 4. 권장 구현안 (A + B 조합)

### 4.1 UI 계층 구조
```text
WorldMapView
├─ imgBackground
├─ SideBorders
│  ├─ LeftBorder
│  └─ RightBorder
├─ StageNodes
├─ LeftBar
├─ BottomBar
└─ TitleBanner / txtTitle
```

원칙:
- `SideBorders`는 `imgBackground` 위, `StageNodes` 아래.
- 즉 “여백만 가리고, 스테이지 노드/버튼은 가리지 않는” 레이어 순서 유지.

### 4.2 RectTransform 가이드
- `SideBorders`
  - AnchorMin `(0,0)`, AnchorMax `(1,1)`, Offset `0`
- `LeftBorder`
  - AnchorMin `(0,0)`, AnchorMax `(0,1)`, Pivot `(0,0.5)`
  - Width: `220~340` (기기별 튜닝)
- `RightBorder`
  - AnchorMin `(1,0)`, AnchorMax `(1,1)`, Pivot `(1,0.5)`
  - Width: `220~340` (좌우 동일 기준)

### 4.2.1 동적 너비 계산 (선택)
고정 너비 대신 런타임에 여백을 계산하여 보더 너비를 자동 조절할 수 있다.
```csharp
// 배경 이미지의 실제 표시 영역과 화면 전체 영역의 차이를 계산
float bgAspect = bgSprite.rect.width / bgSprite.rect.height;
float screenAspect = Screen.width / (float)Screen.height;
float borderWidth = (screenAspect > bgAspect)
    ? (Screen.width - Screen.height * bgAspect) * 0.5f
    : 0f;
```
- 장점: 모든 해상도에서 빈 영역만 정확히 덮음
- 단점: 코드 복잡도 증가, 이미지가 비율에 따라 늘어날 수 있음
- **1차 구현에서는 고정 너비를 권장**하고, 필요 시 2차로 동적 전환

### 4.3 이미지 임포트 권장
- 파일:
  - `WorldMap_SideBorder_Left.png`
  - `WorldMap_SideBorder_Right.png`
- 경로:
  - `Assets/Resources/UI/Sprites/WorldMap/`
- 설정:
  - `Texture Type: Sprite (2D and UI)`
  - `Alpha Is Transparency: On`
  - 표시 모드: `Sliced` 또는 `Simple`(아트에 따라 선택)

## 5. 생성 프롬프트 (ComfyUI/나노바나나 공용)

### Left
- Positive:
  - `fantasy game ui side border, rough stone cliff with moss and tree roots, vertical composition, kingdom rush style, hand painted 2d, clean silhouette, no text, transparent-friendly`
- Negative:
  - `text, letters, watermark, logo, blurry, photorealistic, 3d render, character`

### Right
- Positive:
  - `fantasy game ui side border, rocky wall with vines and cracks, vertical composition, mirrored balance for right side, kingdom rush style, hand painted 2d, clean silhouette, no text, transparent-friendly`
- Negative:
  - `text, letters, watermark, logo, blurry, photorealistic, 3d render, character`

## 6. 코드 반영 포인트
- `WorldMapView`에서 `imgBackground`는 기존처럼 유지.
- `SideBorders`는 프리팹 구조로 고정 배치하고, `ViewportSafeAreaLayout` 적용 시에도 화면 가장자리 기준으로 유지되도록 앵커 기반 설정.
- 카메라 배경색은 `WorldMapScene` 진입 시 1회 적용(옵션).

## 7. 테스트 체크리스트
- 해상도:
  - 16:9
  - 19.5:9 (아이폰 계열)
  - 4:3
- 확인 항목:
  - 좌우 파란 여백이 보이지 않는가
  - 맵 원본 비율이 찌그러지지 않는가
  - `StageNodes`, `BottomBar`, `LeftBar` 클릭 영역이 정상인가
  - Safe Area 적용 시 보더가 어색하게 잘리지 않는가

## 8. 완료 기준 (DoD)
- 파란 여백이 주요 타겟 해상도에서 시각적으로 제거됨
- 배경 이미지 왜곡 없음
- UI 인터랙션(스테이지 클릭/하단 버튼)이 회귀 없이 동작
- WorldMapView 프리팹에서 레이어 순서/앵커가 문서 기준과 일치

## 9. 작업 순서
1. 사이드 보더 이미지 2종 생성 및 임포트
2. `WorldMapView.prefab`에 `SideBorders` 계층 추가
3. 보더 폭 1차값(예: 280) 적용
4. 카메라 배경색 보정(옵션) 적용
5. 3개 비율에서 확인 후 폭/색상 미세조정
6. 검증 스크린샷 저장

## 10. 현재 진행 반영 (코드 반영 완료)
- 코드 보강
  - `WorldMapView`에 런타임 안전 구조 보완
    - `SideBorders`, `SafeAreaContent`가 없으면 자동 생성
    - `ViewportSafeAreaLayout`을 `SafeAreaContent`로 타겟 교체
    - 해상도 변경 시 좌우 보더 너비 자동 재적용
  - `ViewportSafeAreaLayout`에 런타임 바인딩 API 추가
    - `SetSafeAreaTarget(RectTransform)`
    - `SetBottomLiftTargets(RectTransform[])`
- 에디터 보강
  - 신규 메뉴 추가: `Kingdom/WorldMap/Setup Side Borders (Structure)`
  - 실행 시 `WorldMapView.prefab`에 `SideBorders`/`SafeAreaContent`가 영구 반영됨
  - `WorldMapView` 직렬화 필드(`sideBordersRoot`, `safeAreaContent`, `viewportLayout`) 동기화

## 11. 다음 권장 액션
1. 사이드 보더 PNG가 준비되면 `월드맵_사이드보더_플랜.md`의 §4.3 경로로 교체
2. 에디터 메뉴(`Kingdom/WorldMap/Setup Side Borders (Structure)`)를 한 번 실행해 프리팹 반영
3. 다음 해상도 스냅 확인: `16:9`, `19.5:9`, `4:3`
4. 필요 시 보더 폭 기본값 280 -> 240~300 범위로 튜닝
