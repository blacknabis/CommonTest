# 작업상세로그 2026-02-16

## 오늘 작업 요약
- 월드맵 `업그레이드/영웅 관리소` 구현 플랜 문서 작성 및 보강.
- `task.md`를 현재 메인 트랙 기준으로 재정리.
- 기존 장기 누적 항목을 정리하고, 즉시 실행 가능한 체크리스트로 축약.

## 반영 문서
- `문서/진행/월드맵_업그레이드_영웅관리소_플랜_2026_02_16.md`
- `문서/진행/task.md`

## 다음 시작점
- Phase A: `WorldMapView` 버튼 라우팅 + OverlayContainer 인프라 구현.

## 추가 기록 (Phase A 완료)
- `WorldMapView`에서 `업그레이드/영웅 관리소` 버튼을 실제 팝업 오픈 경로로 연결.
- `OverlayContainer` 자동 생성 로직 추가(프리팹에 없을 때 런타임 생성).
- 닫기 동선 통일 처리:
  - BackKey 우선 닫기
  - Overlay Dim 버튼 닫기
  - 팝업 내부 `Close/Back/Exit` 명칭 버튼 자동 바인딩 닫기
- 관련 파일: `Assets/Scripts/Kingdom/UI/WorldMapView.cs`, `문서/진행/task.md`

## 추가 기록 (Phase B 진행 중)
- `WorldMapView`에 `UpgradesPopup` 리소스 자동 로드 경로 추가:
  - `Resources/UI/WorldMap/UpgradesPopup` 우선 로드
  - 미존재 시 런타임 fallback 팝업 자동 생성
- fallback 팝업에 `btnClose` + `SkillTreeUI`를 자동 구성해 즉시 테스트 가능한 상태로 보강.
- `SkillTreeUI`에 런타임 fallback UI 생성 로직 추가:
  - 헤더(`총 별/사용 별/남은 별`) 자동 생성
  - 기본 노드 30개(6 카테고리 x 5 티어) 자동 생성
  - 노드별 업그레이드 버튼/잠금 오버레이/선행 조건 기본 세팅

## 추가 기록 (Phase B 부분 완료)
- `Tools/Kingdom/Build UpgradesPopup Prefab` 에디터 메뉴 추가 (`UpgradesPopupPrefabBuilder`).
- Unity MCP로 메뉴 실행 후 `Assets/Resources/UI/WorldMap/UpgradesPopup.prefab` 실제 생성 확인.
- `SkillTreeUI` 카테고리 탭 기능 추가:
  - 6개 탭(Archers/Barracks/Mages/Artillery/Rain/Reinforce)
  - 탭 선택 시 해당 카테고리 노드만 표시
  - 탭 선택 상태 색상 반영
- 콘솔 경고/에러 0건 확인 (read_console).

## 추가 기록 (Phase B 마무리)
- `SkillTreeUI` 별 부족 상태 피드백 보강:
  - 업그레이드 버튼 비활성 유지
  - 조건 문구를 `별 부족`으로 명시
- 업그레이드 구매 성공/실패(별 부족) 시 디버그 로그 추가.
- Unity 컴파일 후 콘솔 에러/경고 0건 확인.
- `task.md`에서 Phase B 잔여 2개 항목 완료 처리.

## 추가 기록 (Phase C 진행)
- `WorldMapView`에 `HeroRoomPopup` 리소스 로드 경로 추가 (`Resources/UI/WorldMap/HeroRoomPopup`).
- 리소스 미존재 시 HeroRoom fallback 팝업 자동 생성 로직 추가.
- `HeroSelectionUI`에 저장/복원(PlayerPrefs) 추가:
  - `Kingdom.Hero.SelectedHeroId`
  - `Kingdom.Hero.Party.0~N`
- `HeroSelectionUI` 런타임 fallback UI 자동 생성 추가(리스트/상세/파티/버튼).
- 에디터 메뉴 `Tools/Kingdom/Build HeroRoomPopup Prefab` 추가 및 실행 완료.
- `Assets/Resources/UI/WorldMap/HeroRoomPopup.prefab` 생성 확인.
- Unity 콘솔 경고/에러 0건 확인.

## 추가 기록 (Phase D 시작 - 선택 영웅 연동)
- `GameScene`의 영웅 로드를 고정 `DefaultHero`에서 `PlayerPrefs` 기반으로 변경.
- 적용 키: `Kingdom.Hero.SelectedHeroId`.
- 로드 순서:
  1) `Resources/Data/HeroConfigs/{SelectedHeroId}`
  2) 누락 시 `Resources/Data/HeroConfigs/DefaultHero` 폴백
  3) 그래도 누락 시 런타임 fallback `HeroConfig` 생성
- 관련 파일: `Assets/Scripts/Kingdom/App/GameScene.cs`, `문서/진행/task.md`

## 추가 기록 (Phase D 진행 - 업그레이드 수치 전투 훅)
- `TowerManager.Configure`에서 타워 타입별 Config를 런타임 복제(`Instantiate`) 후 사용하도록 변경.
  - 씬 재진입 시 에셋 원본 값이 누적 변형되지 않도록 방지.
- 월드맵 스킬트리 저장값(`Kingdom.SkillTree.SkillLevel.*`)을 읽어 전투 수치에 최소 반영 훅 추가.
  - 카테고리 매핑: `archers_ / barracks_ / mages_ / artillery_`
  - 반영 수치: `Damage`, `Range`, `Cooldown`
  - 배율: `Damage +4% * 누적레벨`, `Range +3% * 누적레벨`, `Cooldown -2% * 누적레벨(하한 50%)`
- 반영 시 로그 추가:
  - `[TowerManager] Meta upgrade applied...`
- Unity 리프레시/컴파일 요청 후 콘솔 점검 결과 신규 에러/경고 없음.
- 관련 파일: `Assets/Scripts/Kingdom/Game/TowerManager.cs`, `문서/진행/task.md`

## 추가 기록 (Phase D 마무리 - 경고 로그 정리)
- 콘솔 노이즈를 줄이기 위해 "정상 폴백" 성격의 로그를 `Warning`에서 `Log`로 조정.
- 변경 대상:
  - `GameScene`: 선택 영웅 Config 누락 시 기본 영웅 폴백 메시지
  - `WorldMapView`: 배경 스프라이트/기본 오디오 리소스 누락 메시지
- 원칙:
  - 실제 오동작 가능성이 높은 항목은 `Warning` 유지
  - 개발 중 허용되는 리소스 미존재/폴백은 `Log`로 처리
- Unity 리프레시/컴파일 후 신규 에러/경고 없음 확인.
- 관련 파일: `Assets/Scripts/Kingdom/App/GameScene.cs`, `Assets/Scripts/Kingdom/UI/WorldMapView.cs`, `문서/진행/task.md`

## 추가 기록 (Phase E 준비 - 검증 로그 보강)
- `GameScene`에 선택 영웅 Config 해석 성공 로그 추가.
  - 로그: `[GameScene] Hero config resolved from selected id...`
- `HeroSelectionUI`에 복원/저장 안정화 보강.
  - `OnDisable` 시점에도 선택/파티 상태 저장 호출
  - `LoadSelectionFromPrefs()` 완료 시 복원 결과 로그 추가
  - 로그: `[HeroSelectionUI] Selection loaded...`
- 목적: Phase E 수동 검증 시 월드맵 -> 게임 연동 및 재진입 복원 여부를 콘솔에서 즉시 확인 가능하도록 개선.
- 관련 파일: `Assets/Scripts/Kingdom/App/GameScene.cs`, `Assets/Scripts/Kingdom/WorldMap/UI/HeroSelectionUI.cs`, `문서/진행/task.md`

## 추가 기록 (GameView UX 보강)
- 타워 빌드 버튼 클릭 시 슬롯이 0개이면 링 메뉴를 열지 않고 상태 텍스트 `No Slot` 표시하도록 수정.
- 타워 링 메뉴 오픈 좌표를 HUD 경계 안으로 클램프 처리하여 화면 밖으로 잘리는 케이스 방지.
- 타워 링 버튼 상태 표시 개선:
  - 슬롯 없음: `NO SLOT` 표기 + 회색 톤
  - 골드 부족: 비용 표기 유지 + 비활성 색상
- 관련 파일: `Assets/Scripts/Kingdom/UI/GameView.cs`, `문서/진행/task.md`

## 추가 기록 (검증 자동화 보강)
- `KingdomAppManager`에 월드맵 메타 팝업 리그레션 러너 추가.
  - ContextMenu: `Run WorldMap Meta Popup Regression (20)`
  - 동작: WorldMapScene 진입 -> UpgradesPopup 열기/닫기 -> HeroRoomPopup 열기/닫기 루프 반복
  - 결과: success/fail 카운트 로그 출력
- 중복 실행 방지 플래그 추가: `isWorldMapMetaRegressionRunning`
- 관련 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`, `문서/진행/task.md`

## 추가 기록 (월드맵 메타 팝업 리그레션 실행 결과)
- 실행 로그 확인:
  - `[KingdomAppManager] WorldMap meta popup regression finished. success=40, fail=0, loops=20`
- 판정:
  - `월드맵 -> 업그레이드 -> 월드맵 루프` 통과
  - `월드맵 -> 영웅관리소 -> 월드맵 루프` 통과
- `task.md`의 Phase E 해당 2개 항목 완료 처리.

## 추가 기록 (검증 자동화 보강 2)
- `KingdomAppManager`에 메타 저장/선택 영웅 반영 리그레션 러너 추가.
  - ContextMenu: `Run Meta Persistence + Hero Apply Regression`
  - 검증 항목:
    1) PlayerPrefs 저장 직후 readback (영웅/스킬)
    2) GameScene 진입 성공
    3) `HeroController.CurrentHeroId`가 선택 영웅과 일치하는지 확인
    4) WorldMap 복귀 성공
    5) 씬 왕복 후 PlayerPrefs 값 유지 확인
- `HeroController`에 현재 적용 영웅 ID 조회용 프로퍼티 추가:
  - `CurrentHeroId`
- Unity MCP 연결이 일시적으로 끊겼으나 재시도로 복구 후 리프레시/컴파일 요청 완료.
- 관련 파일: `Assets/Scripts/Kingdom/KingdomAppManager.cs`, `Assets/Scripts/Kingdom/Game/SpawnManager.cs`, `문서/진행/task.md`

## 추가 기록 (메타 저장/선택 영웅 반영 리그레션 실행 결과)
- 실행 메뉴: `Tools/Kingdom/Run Meta Persistence + Hero Apply Regression` (Play Mode)
- 결과 로그:
  - `[KingdomAppManager] Meta persistence regression finished. success=7, fail=0, heroTest=DefaultHero, heroRuntime=DefaultHero, ...`
- 판정:
  - `월드맵 -> 게임 진입 시 선택 영웅 반영` 통과
  - 메타 저장값(PlayerPrefs) 씬 왕복 유지 통과
- 비고:
  - 실행 중 `TowerManager`의 invalid config 경고(기본값 리포퓰레이션)는 기존 데이터 경고로 관측됨.

## 추가 기록 (사용자 수동 검증 완료)
- 사용자 확인: `앱 재실행 후 업그레이드/영웅 선택 데이터 유지` 완료.
- `task.md` Phase E 해당 항목 완료 처리.

## 추가 기록 (Phase E 최종 콘솔 점검)
- `TowerManager`의 데이터 보정 메시지를 `Warning` -> `Log`로 조정.
- 콘솔 클리어 후 Play Mode 진입 및 리그레션 메뉴 실행 시 로그 점검 결과:
  - 신규 `Error` 없음
  - 신규 `Warning` 없음
- `task.md`의 `신규 콘솔 에러/치명 경고 0건` 완료 처리.
