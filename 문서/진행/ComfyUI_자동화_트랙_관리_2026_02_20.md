# ComfyUI 자동화 트랙 관리
> 작성일: 2026-02-20  
> 마지막 수정: 2026-02-20  
> 대상 프로젝트: Kingdom  
> 대상 경로: `Assets/Editor/ComfyUI`, `Assets/Scripts/Kingdom/Editor/SpriteSheetGenerator.cs`

## 1. 트랙 목적
- ComfyUI 기반 캐릭터 생성 파이프라인을 수동 반복 작업 없이 자동화한다.
- 출력물의 파일명/경로/프레임 규칙을 고정해, 후속 단계(AISpriteProcessor/런타임 바인딩)와 충돌을 없앤다.
- 생성 코드, 워크플로우 JSON, 산출 리소스 커밋 단위를 분리해 관리한다.

## 2. 트랙 범위
### 2.1 In Scope
- `ComfyUIHelper`를 통한 요청 생성/실행 자동화
- `workflow_hero_i2v.json` 템플릿 관리 및 입력 슬롯 고정
- 프레임 추출/정렬/시트 생성(`SpriteSheetGenerator`) 자동 연계
- 산출물 명명 규칙 및 결과 메타 리포트 정리

### 2.2 Out of Scope
- Hero/Enemy/Tower 런타임 바인딩 자체 수정
- `AISpriteProcessor` 탭/바인딩 정책 변경
- 전투 밸런스, 전투 로직(P0/P1) 수정

## 3. 산출물 계약(Contract)
1. 프레임 파일명: `{CharacterId}_{Action}_{FrameIndex:00}.png`
2. 시트 파일명: `{CharacterId}_{Action}_Sheet.png`
3. 출력 루트: `Assets/Resources/Generated/SpriteSheets/`
4. 프레임 인덱스: 0부터 연속 증가, 중간 결번 금지
5. 실패 시 결과: 부분 생성 파일 유지 + 실패 원인 로그 출력(침묵 실패 금지)

## 4. 단계별 작업 계획
### Phase A. 워크플로우 템플릿 표준화
- [ ] `workflow_hero_i2v.json` 입력 키 표준화(프롬프트/시드/프레임/해상도)
- [ ] 템플릿 버전 필드 도입(`workflowVersion`)
- [ ] 필수 노드 누락 시 즉시 중단 + 에러 로그

### Phase B. Unity 자동화 엔트리 정리
- [ ] `ComfyUIHelper`에서 단일 실행 진입점 제공
- [ ] 단일 캐릭터/배치 실행 모드 분리
- [ ] 타임아웃/재시도 정책(최대 횟수) 명시

### Phase C. 출력 정규화 및 시트 결합
- [ ] 프레임 개수 검증(최소/최대) 및 결번 검사
- [ ] `SpriteSheetGenerator` 연계로 시트 생성 자동 실행
- [ ] 시트 생성 완료 후 결과 경로 로그 표준화

### Phase D. 결과 검증/운영
- [ ] 자동화 결과 요약 로그(`성공 n, 실패 n, 경고 n`)
- [ ] 실패 케이스 재실행 커맨드 제공(대상 캐릭터 단위)
- [ ] 회귀 실행 체크리스트 업데이트(ComfyUI 트랙 전용)

## 5. 커밋/브랜치 운영 규칙
1. 워크플로우 JSON/코드 변경과 대량 이미지 산출물 커밋을 분리한다.
2. 자동화 코드 커밋 메시지와 리소스 커밋 메시지를 분리한다.
3. `ComfyUI 자동화` 트랙 범위 외 파일은 이 트랙 커밋에 포함하지 않는다.

## 6. 완료 기준(Definition of Done)
- 메뉴 또는 스크립트 1회 실행으로 `base -> i2v -> frame -> sheet` 파이프라인이 끝까지 동작한다.
- 동일 입력(프롬프트/시드)에서 재실행 시 파일 구조/개수가 일관된다.
- 실패 시 원인 로그만으로 재현 및 재시도가 가능하다.
- 본 문서와 `task.md`의 ComfyUI 트랙 상태가 동기화되어 있다.

## 7. 현재 코드 상태 체크리스트 (2026-02-20)
### 7.1 Phase A. 워크플로우 템플릿 표준화
- [~] 입력 키 일부 표준화 (`%MODEL_NAME%`, `%SEED%`, `%FRAMES%`)는 적용됨  
근거: `Assets/Editor/ComfyUI/workflow_hero_i2v.json`
- [ ] `workflowVersion` 필드 없음
- [ ] 필수 노드 누락 검증 로직 없음

### 7.2 Phase B. Unity 자동화 엔트리 정리
- [~] 메뉴 엔트리는 존재 (`1. Base`, `2. Walk I2V`, `3. Stitch`)  
근거: `Assets/Scripts/Kingdom/Editor/SpriteSheetGenerator.cs`
- [ ] 단일 실행 엔트리(원클릭 end-to-end) 없음
- [ ] 배치 실행 모드 없음
- [~] 타임아웃은 있음(루프 기반 180초/300초), 재시도 정책은 없음  
근거: `Assets/Scripts/Kingdom/Editor/SpriteSheetGenerator.cs`

### 7.3 Phase C. 출력 정규화 및 시트 결합
- [~] 출력 경로/파일명 규칙은 부분 적용됨  
근거: `Assets/Scripts/Kingdom/Editor/SpriteSheetGenerator.cs`
- [ ] 프레임 결번/최소 개수 검증 없음
- [ ] I2V 완료 후 시트 자동 생성 연계 없음(현재 Step 3 수동 실행)
- [x] 시트 생성 시 파일명 규칙 `{폴더명}_Sheet.png` 적용

### 7.4 Phase D. 결과 검증/운영
- [ ] 실행 결과 요약 로그(`성공/실패/경고`) 집계 없음
- [ ] 실패 대상 재실행 커맨드(캐릭터 단위) 없음
- [ ] ComfyUI 트랙 전용 회귀 체크리스트 자동화 없음

## 8. 즉시 착수 권장 항목
1. `SpriteSheetGenerator`에 `RunKnightWalkPipeline`(원클릭) 메뉴 추가
2. `workflow_hero_i2v.json`에 `workflowVersion` 필드 추가
3. 프레임 검증기 추가(결번, 최소 프레임 수, 파일명 패턴)
4. 실행 결과 요약 로그 구조 추가(성공/실패/경고 카운트)
