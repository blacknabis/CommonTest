# 적 유닛 구현 계획 (Enemy Implementation Plan)
> 작성일: 2026-02-19
> 기준 문서: `문서/분석/적_유닛_상세_분석.md`
> 대상 프로젝트: Kingdom

## 1. 목표
18종 적 유닛(일반/비행/엘리트/보스)의 핵심 전투 특성을 현재 전투 시스템에 안정적으로 통합한다.
이번 구현의 최우선은 "전투 판정 일관성"과 "웨이브 밸런싱 가능 상태"다.

## 2. 범위
### In Scope
- 방어/저항 기반 피해 계산 정립
- 지상/비행 경로 및 저지(블로킹) 규칙 분리
- 적 공통 상태(이동/저지됨/공격/사망) 정리
- 특성 로직 1차 도입: 회피, 재생, 사망 폭발
- 18종 `EnemyConfig` 데이터 입력 및 웨이브 검증 템플릿 구성

### Out of Scope (이번 단계 제외)
- 보스 연출(시네마틱, 특수 카메라)
- 신규 VFX/사운드 리소스 제작
- 최종 난이도 밸런싱 확정(수치 미세조정)

## 3. 선행 조건
- `DamageType`, `DamageCalculator`를 타워/적 공용으로 사용 가능해야 함
- 적이 참조할 `EnemyConfig` 직렬화 필드 확장 가능 상태여야 함
- 비행 레이어(`FlyingEnemy`)와 지상 레이어(`GroundEnemy`)가 프로젝트 레이어에 등록되어야 함

## 4. 단계별 구현

### Phase 1. 전투 기반 정리 (P0)
목표: 전투 계산과 이동 규칙의 기반 완성

1. 피해 계산 리팩터링
- `DamageCalculator`를 공용 규칙으로 통합
- 물리 피해 -> `ArmorPercent` 적용
- 마법 피해 -> `MagicResistPercent` 적용
- 최종 감쇠 상한: 95%

2. EnemyConfig 스키마 확장
- 기본: `EnemyId`, `DisplayName`, `EnemyType`
- 생존: `MaxHp`, `ArmorPercent`, `MagicResistPercent`, `HealthBarOffset`
- 공격: `AttackDamageMin/Max`, `AttackCooldownSec`, `AttackRange`, `DamageToBase`
- 보상: `BountyGold`

3. 이동/저지 규칙 분리
- `Ground`: 기존 블로킹 규칙 유지
- `Flying`: 블로킹 무시, 지상 충돌 무시, 경로는 목적지 우선

산출물(DoD)
- 방어/저항 계산이 전 유닛에서 동일 규칙으로 적용
- 비행 유닛이 병영 저지를 받지 않고 이동

### Phase 2. 상태/특성 구현 (P1)
목표: 체감 난이도를 만드는 특성 도입

1. 공격 상태 머신 정리
- `Moving -> Blocked -> Attacking -> Moving` 전환
- 공격 대상은 `IDamageable` 인터페이스로 통일

2. 특성 구현
- `DodgeChance`: 피격 시 확률 무효화
- `RegenHpPerSec`: 생존 중 주기 회복
- `DeathExplosionRadius/Damage`: 사망 시 범위 피해

산출물(DoD)
- 회피/재생/사망폭발이 중복 트리거 없이 1회 규칙으로 동작
- 블로킹 상태에서만 근접 공격 수행

### Phase 3. 데이터 자산 입력 (P1)
목표: 18종 유닛의 데이터 구성 완료

1. SO 생성/입력
- `Assets/Resources/Kingdom/Enemies/Config/` 경로에 18개 `EnemyConfig` 생성

2. 유형별 기준치 반영
- Swarm: 저체력/저보상/물량
- Armored: 중~고 방어
- Anti-Mage: 중~고 마법저항
- Fast Runner: 고속/회피
- Tank/Elite: 고체력/재생
- Flying: 비행 + 저지무시
- Boss: 보스 플래그 + 면역/특수 규칙 훅

3. 스프라이트 참조 매핑
- `EnemyConfig`에 적 표시용 스프라이트 참조 필드(예: `Sprite` 또는 `PortraitSprite`) 포함
- 18종 유닛에 기본(플레이스홀더 포함) 스프라이트 1:1 매핑
- 런타임 로드 시 스프라이트 누락(`null`) 방지 검증

산출물(DoD)
- 누락 유닛 0건
- 스프라이트 매핑 누락 0건
- 최소 4개 테스트 웨이브에서 스폰/전투/사망까지 오류 없이 진행

### Phase 4. 통합 검증 (P2)
목표: 플레이 가능 품질 확보

1. 검증 웨이브
- Wave A: Goblin x10 -> Orc x3
- Wave B: Scout x5 -> Bandit x3
- Wave C: Wing Suit x5
- Wave D: Ogre x1 + Shaman x2

2. 검증 관점
- 물리/마법 카운터 관계
- 비행 경로 분리
- 특성 동시 발동 안정성

산출물(DoD)
- 콘솔 에러 0
- 치명 밸런스 이탈 항목 정리 문서화

## 5. 구현 우선순위 백로그
### P0 (필수)
- Armor/MagicResist 계산 정합성
- Flying 저지 무시/경로 분리
- 속도형 유닛(Scout/Bandit 계열) 경로 안정성

### P1 (중요)
- Dodge/Regen/DeathBurst
- 중형/엘리트 체급 전투 체감 확보

### P2 (확장)
- 보스 전용 패턴/면역/소환
- 고유 스킬 연출/텔레그래프

## 6. 리스크 및 대응
1. 리스크: 저항 수치 과다로 TTK(Time To Kill) 비정상 증가
- 대응: Armor/MagicResist 상한 95%, QA에서 TTK 상/하한 측정

2. 리스크: 회피 + 재생 조합으로 교착 발생
- 대응: 회복은 전투 중 감쇠 또는 최소 피해 보장 규칙 검토

3. 리스크: 비행 유닛 경로가 내비게이션 예외를 유발
- 대응: 비행 전용 경로/레이어 fallback 루트 준비

## 7. QA 체크리스트
1. [ ] 고방어 유닛(Dark Knight)에게 물리 타워와 마법 타워의 유효 딜 차이가 의도대로 나는가?
2. [ ] 고마저 유닛(Mage Hunter)에게 물리 딜이 상대적으로 유효한가?
3. [ ] 비행 유닛(Wing Suit)이 병영 저지를 무시하고 목표 지점으로 이동하는가?
4. [ ] 속도형 유닛(Scout/Bandit)이 경로 이탈 없이 고속 이동하는가?
5. [ ] 재생형 유닛(Troll)이 초당 회복 규칙을 안정적으로 따르는가?
6. [ ] 사망폭발 유닛(Demon Spawn 계열) 사망 시 범위 피해가 1회만 적용되는가?
7. [ ] 18종 유닛 스프라이트가 의도한 대상에 정상 매핑되고 누락(`null`)이 없는가?

## 8. 완료 기준 (Final DoD)
- 기능: P0/P1 항목 모두 구현 완료
- 데이터: 18종 `EnemyConfig` 입력 완료
- 비주얼: 18종 기본 스프라이트 매핑 완료(플레이스홀더 허용)
- 품질: QA 체크리스트 7개 모두 통과 또는 이슈 등록 완료
- 문서: 수치/예외 규칙을 `문서/분석/적_유닛_상세_분석.md`와 동기화

## 9. 파일 가이드
- 데이터: `Assets/Scripts/Kingdom/Game/Data/EnemyConfig.cs`
- 런타임: `Assets/Scripts/Kingdom/Game/Enemies/EnemyRuntime.cs`
- 전투 계산: `Assets/Scripts/Kingdom/Game/Combat/`
- 웨이브: `Assets/Scripts/Kingdom/Game/WaveManager.cs`
- SO 리소스: `Assets/Resources/Kingdom/Enemies/Config/`

## 10. 작업 순서 제안
1. Phase 1 완료 후 플레이모드 스모크 테스트 1회
2. Phase 2 완료 후 특성 유닛만 묶은 집중 테스트 웨이브 실행
3. Phase 3 완료 후 누락/오타 점검 스크립트 또는 수동 리스트 검증
4. Phase 4 완료 후 밸런스 이슈를 별도 문서로 분리 기록
