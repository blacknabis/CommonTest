# 작업상세로그

## [2026-02-22 13:27:39] 작업 기록
- AISpriteProcessor Run All에서 배럭 4액션 추론 fallback 추가
- BarracksSoldierRuntime에서 공격 상태 유지시간을 attack 클립 길이 기준으로 보정
- null 비교를 IsNull/IsNotNull 확장 스타일로 일부 반영
- 배럭 병사 폴백 비주얼(어두워짐/찌그러짐) 제거

## [2026-02-22 13:31:58] 작업 기록
- 이슈: 몬스터 잔존 상태에서 VICTORY 팝업 조기 노출
- 원인: GameStateController.WaveRunning에서 waveDuration 경과만으로 Result 상태 자동 전이
- 조치: useLegacyWaveDurationAutoComplete(기본 false) 가드 추가, 기본 흐름을 WaveManager 완료 조건 기반으로 고정
- 검증: dotnet build Assembly-CSharp.csproj 오류 0

## [2026-02-22 13:42:05] 작업 기록
- 요청: 오브젝트 클릭 정보 + 체력 게이지 기능 플랜 수립
- 산출물: 문서/진행/오브젝트_클릭정보_체력게이지_구현_계획_2026_02_22.md
- task.md 신규 트랙 체크리스트 추가

## [2026-02-22 14:14:07] 작업 기록
- 요청: 오브젝트 클릭 정보/HP게이지 구현 문서 리뷰 후 이어서 수정 진행
- 결함 원인 정리:
  - 선택 탐지가 `Physics2D.OverlapCircleAll` 기반인데 런타임 생성 오브젝트 다수에 `Collider2D` 부재
  - 타워는 `TowerRuntime`이 `MonoBehaviour`가 아니어서 `GetComponentInParent<ISelectableTarget>()` 탐지 불가
  - `SelectionInfoPanel`의 `_txtHp` 자동 바인딩 누락
- 코드 조치:
  - `SpawnManager`: 적 생성 시 `CircleCollider2D(isTrigger, radius=0.35)` 추가
  - `TowerManager`: 타워/배럭 병사 생성 시 `CircleCollider2D` 추가, `TowerSelectableProxy` 도입
  - `HeroController`: 영웅 시각 초기화 시 `CircleCollider2D` 보강
  - `SelectionController`: LayerMask 미설정(0) 및 마스크 미매치 시 all-layer fallback 추가
  - `SelectionInfoPanel`, `WorldHpBar`, `WorldHpBarManager`: `IsNull/IsNotNull` 스타일로 null 체크 통일
- 문서 동기화:
  - `문서/진행/task.md` 진행 메모 추가
- 빌드 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0 확인 (기존 경고 유지)

## [2026-02-22 14:18:37] 작업 기록
- 사용자 제보: 게임 중앙 흰 사각형 노출 + 캐릭터 클릭 미반응
- 원인 확인:
  - `SelectionInfoPanel` 루트/PanelRoot에 `Image(sprite=null, color=white, raycastTarget=true)`가 있어 중앙에 흰 박스로 노출
  - 해당 UI Raycast가 `EventSystem.current.IsPointerOverGameObject()`에 걸려 월드 선택 입력을 차단
- 조치:
  - `SelectionInfoPanel` 시작 시 `DisablePlaceholderImagesAndRaycasts()` 추가
  - 스프라이트 없는 `Image`는 투명 처리 + 모든 `Image/TMP` raycastTarget 비활성화
  - Slider targetGraphic raycast도 비활성화
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:23:23] 작업 기록
- 사용자 제보: `BarracksSoldier_1_3` 포함 오브젝트 클릭 반응 없음
- 원인 확인:
  - `SelectionController`가 `GameScene`에서 생성/배치되지 않아 선택 입력 파이프라인 자체가 미동작
- 조치:
  - `GameScene.OnStartScene()`에 `EnsureSelectionSystems()` 호출 추가
  - `SelectionController` 및 `SelectionCircleVisual` 미존재 시 런타임 자동 생성 후 바인딩
  - `SelectionCircleVisual`에서 기본 스프라이트 경로(`UI/Sprites/Common/SelectionCircle`) 자동 로드
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:28:26] 작업 기록
- 사용자 제보: 선택 후 중앙에 큰 흰 원 + 검은 배경 패널 노출
- 조치:
  - `SelectionCircleVisual` 스케일 로직을 콜라이더 크기 기반으로 재산정 (과대 원 방지)
  - `SelectionCircleVisual` z 위치 조정(배경 위/유닛 아래)
  - `SelectionInfoPanel`의 placeholder `Image`를 강제 비활성화(`enabled=false`, alpha=0) 처리
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:34:09] 작업 기록
- 요청: HP바 항상 표기
- 조치:
  - `WorldHpBar.Update()`에서 `CanvasGroup.alpha`를 항상 `1f`로 고정
  - 기존 `HP<100%` 조건부 노출 정책 제거
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:37:51] 작업 기록
- 사용자 제보: HP바 여전히 미표시
- 원인 확인:
  - `WorldHpBarManager`가 씬/프리팹 어디에도 존재하지 않아 `TrackTarget()` 호출이 전부 무시됨
- 조치:
  - `GameScene` 시작 시 `EnsureWorldHpBarSystem()` 추가
  - `WorldHpBarManager` 런타임 자동 생성
  - `Resources/UI/WorldHpBar` 프리팹 자동 로드/주입
  - `WorldHpBarManager.ConfigureRuntime()` 추가(프리팹/루트/풀 사이즈 런타임 구성)
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:43:51] 작업 기록
- 사용자 제보: `WorldHpBarManager.GetAvailableBar()` NullReferenceException
- 원인:
  - HP바 풀(`_pool`)에 null 항목이 포함된 상태에서 `bar.gameObject` 접근
- 조치:
  - `CreateNewBar()`에서 `WorldHpBar` 컴포넌트 누락 인스턴스는 풀에 넣지 않고 폐기
  - `GetAvailableBar()`에서 null 풀 항목 정리 후 사용
  - `UntrackTarget()`에서 bar null 안전 처리
  - `Awake()` 싱글톤 중복 가드 유지
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:49:42] 작업 기록
- 사용자 제보: `[WorldHpBarManager] WorldHpBar component missing on prefab instance.`
- 원인:
  - `UI/WorldHpBar` 프리팹 인스턴스 루트에 `WorldHpBar` 컴포넌트가 없는 상태
- 조치:
  - `WorldHpBarManager.CreateNewBar()`에서 컴포넌트 누락 시 런타임 자동 추가
  - `WorldHpBar`에서 `_fillRenderer` 자동 탐색 로직 추가(`Fill` 이름 우선, 없으면 자식 SpriteRenderer fallback)
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 14:54:19] 작업 기록
- 사용자 제보: HP바가 오브젝트 정중앙에 표시됨
- 조치:
  - `WorldHpBar.UpdatePosition()`을 고정 위치(`target.Position + offset`)에서
    콜라이더/스프라이트 bounds 기반 머리 위 앵커 계산으로 변경
  - 앵커 계산 우선순위: `Collider2D.max.y` -> `SpriteRenderer.max.y` -> fallback(`target.Position`)
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 15:01:44] 작업 기록
- 사용자 요청:
  - 체력 게이지가 양쪽에서 줄어듦 -> 좌측 고정으로 변경 필요
  - 체력 게이지가 캐릭터보다 너무 높음 -> 위치 하향 필요
- 조치:
  - `WorldHpBar.UpdateHp()`에서 Fill 스케일 축소 시 localPosition X를 함께 보정하여 좌측 고정 감소 구현
  - `WorldHpBar` 기본 `_offset.y`를 0.08로 하향
  - 기존 오프셋이 큰 경우(>0.3) 런타임 안전값으로 보정
  - 머리 위 앵커 패딩 값을 축소(`extra` clamp 하향)하여 과도한 상단 위치 완화
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0

## [2026-02-22 15:29:23] 작업 기록
- 요청: 현재 논의 내용 기준으로 실행 계획 문서화
- 산출물:
  - `문서/진행/SelectionSystem_프리팹전환_및_HP바_안정화_계획_2026_02_22.md`
- 반영 내용:
  - SelectionSystem 프리팹 전환(생성 누락 리스크 제거)
  - GameScene 부트스트랩 정리(프리팹 우선 + fallback)
  - WorldHpBar 프리팹 정합성 고정
  - HP바/SelectionCircle UX 튜닝 및 검증 단계 정의
- 프로젝트 문서 동기화:
  - `문서/진행/task.md` 신규 메인 트랙 추가

## [2026-02-22 15:49:31] 작업 기록
- 요청: `SelectionSystem_프리팹전환_및_HP바_안정화_계획_2026_02_22.md` 보완 + 다른 문서 동시 반영
- 계획서 보완:
  - 실행 상태 매트릭스(완료/진행중/미완료) 추가
  - 문서 동기화 반영 지침(대상 문서 + 규칙) 추가
  - 우선순위 재정렬된 다음 실행 액션 추가
  - 리스크 대응 플레이북(증상-확인-조치) 추가
- 연동 문서 반영:
  - `task.md`에 Phase 0(Rev.2 동기화), Phase 4.5(기술 부채) 추가
  - HP바 좌측 고정 감소 항목 완료로 상태 반영

## [2026-02-22 16:52:35] 작업 기록
- 요청: 전체 커밋 후 작업 계속 진행
- 커밋:
  - `996d261` (`feat: stabilize selection/hp UI pipeline and sync docs`)
- 추가 코드 조치:
  - `GameScene.EnsureSelectionSystems()`를 `SelectionSystem` 프리팹 우선 로드(`Resources/UI/SelectionSystem`)로 보강
  - 프리팹 로드 실패/컴포넌트 누락 시 기존 런타임 생성 fallback 유지
  - `SelectionController.SuppressSelectionForCurrentFrame()` 추가
  - `GameScene.Update()`의 타워/슬롯 클릭 처리 시 해당 프레임 Selection 입력 억제로 클릭 충돌(방안 B) 방지
- 검증:
  - `dotnet build Assembly-CSharp.csproj -v minimal` 오류 0
- 문서 동기화:
  - `task.md` Phase 2 완료 체크, Phase 4.5(클릭 충돌 방지) 완료 체크

