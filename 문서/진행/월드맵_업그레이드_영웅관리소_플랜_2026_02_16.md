# 월드맵 업그레이드/영웅 관리소 구현 플랜 (NotebookLM 반영)

## 1. 목표
- 월드맵 하단 `업그레이드`, `영웅 관리소` 버튼 클릭 후 실제 동작하는 메타 UI 루프를 완성한다.
- 기존 코드/자산을 최대 재사용하여 MVP를 빠르게 붙이고, v1 확장 경로를 보장한다.

## 2. 현재 코드 기준 진단
- 버튼 클릭 동작은 현재 로그 출력만 수행.
  - `Assets/Scripts/Kingdom/UI/WorldMapView.cs:369` / `376`
- 재사용 가능한 UI 로직:
  - 업그레이드: `SkillTreeUI.cs` (베이스)
  - 영웅 관리소: `HeroSelectionUI.cs` (베이스)
- 저장 구조 혼합 상태:
  - 스테이지 진행도: `UserSaveData` (JSON)
  - 스킬트리/보너스별: `PlayerPrefs` 키(`Kingdom.SkillTree.*`)
- **결론**: 핵심은 `라우팅 + 팝업 프리팹 + 저장 연결 표준화`이다.

## 3. 킹덤러쉬 시스템 분석 (NotebookLM)
> *Source: Kingdom Rush Wiki, Reddit based on Notebook `778e7a86...`*

### 3.1 업그레이드 시스템 (Upgrades)
- **카테고리 (6종)**: 4종 타워 + 2종 스펠.
  1. `Archers`, `Barracks`, `Mages`, `Artillery`
  2. `Rain of Fire`, `Reinforcements`
- **구조**: 각 카테고리별 5단계 선형 트리 (Tier 1~5).
- **재화**: 캠페인 클리어 시 획득한 **별(Stars)**을 소모.
- **수치**: 구체적인 % 수치는 자료 부재 -> **자체 밸런싱(10%~20%)**으로 설정.
- **전략성**: 언제든 **Reset**하여 별을 돌려받고 재투자 가능.

### 3.2 영웅 시스템 (Heroes)
- **성장 모델 비교**:
  - *KR1*: 스테이지 내 레벨업(Lv 1~10), 종료 시 초기화.
  - *Frontiers 이후*: **영구 레벨업 시스템** 도입 + 스킬 포인트 투자.
- **채택 모델**: **Frontiers 방식 (영구 성장)**을 따름.
  - 영웅 레벨과 XP는 월드맵에서도 유지됨.
  - 레벨업 시 스킬 포인트(Hero Point) 획득.
- **해금**: 초반 3~4명 무료(스테이지 클리어 해금), 이후 프리미엄/추가 해금.

## 4. 구현 범위 정의

### 4.1 MVP (이번 구현)
- **진입/복귀**: 월드맵 버튼 클릭 -> 팝업 오픈/클로즈 (모달).
- **업그레이드 UI**:
  - 6개 탭(카테고리) 구성.
  - 각 노드 클릭 시 **별 소모** 및 **저장**.
  - 인게임 반영: `TowerManager`/`SpellManager` 스탯 보정.
- **영웅 관리소 UI**:
  - 영웅 리스트(좌측) / 상세(우측) 레이아웃.
  - **선택(Select)** 및 **파티 편성(Party)** 저장.
  - 인게임 반영: `GameScene` 진입 시 선택 영웅 스폰.
- **저장/복원**: 앱 재실행 시 상태 유지.

### 4.2 v1 (후속)
- **Reset 기능**: 업그레이드 초기화 및 별 환급.
- **영웅 성장**: XP/레벨 시스템, 스킬 포인트 투자 (UI에 슬롯만 미리 확보).
- **영웅 장비**: 아이템/장비 슬롯.

## 5. 아키텍처 결정

### 5.1 UI 구조
- `WorldMapView` 내 `OverlayContainer`를 공통 모달 루트로 사용.
- 팝업 프리팹 2종:
  - `Assets/Resources/UI/WorldMap/UpgradesPopup.prefab`
  - `Assets/Resources/UI/WorldMap/HeroRoomPopup.prefab`
- 닫기 동선 통일: `X 버튼`, `딤 영역 터치`, `BackKey`.

### 5.2 저장 구조 (MVP: PlayerPrefs 유지)
- **업그레이드**: 기존 `SkillTreeUI` 호환성 유지.
  - `Kingdom.SkillTree.SkillLevel.{Category}_{NodeIndex}`
  - `Kingdom.SkillTree.SpentStars`
- **영웅 관리**:
  - `Kingdom.Hero.SelectedHeroId`
  - `Kingdom.Hero.Party.0`

### 5.3 데이터 연동
- **v1 마이그레이션**: 추후 `UserSaveData` Schema v2로 통합 (JSON).
- **인게임 반영**:
  - `TowerManager` 초기화 시 `PlayerPrefs` 조회 -> 데미지/사거리/쿨타임 보정.
  - `GameScene` 영웅 스폰 시 `SelectedHeroId`로 `HeroConfig` 로드.

## 6. 구현 단계

### Phase A. 월드맵 라우팅/모달 인프라
- `WorldMapView`에 팝업 제어 함수 추가:
  - `OpenUpgradesPopup()`, `OpenHeroRoomPopup()`, `CloseOverlay()`.
- 버튼 핸들러 연결 및 클릭 사운드 적용.

### Phase B. 업그레이드 팝업 연결
- `UpgradesPopup` 프리팹 제작 (6개 탭 레이아웃).
- **별 소모 로직**: 보유 별(Total Stars) - 사용 별(Spent Stars) >= 필요 별(Cost).
- 구매 성공 시 UI 갱신 및 `PlayerPrefs` 저장.

### Phase C. 영웅 관리소 팝업 연결
- `HeroRoomPopup` 프리팹 제작 (좌측 리스트/우측 상세).
- **선택 로직**: 리스트 클릭 -> 상세 정보 갱신 -> `Select` 버튼 활성화 -> 저장.
- 영웅 성장/스킬 UI 영역은 "Coming Soon" 또는 비활성 상태로 배치.

### Phase D. 인게임 연동 및 QA
- `GameScene` 진입 시 저장된 데이터 적용 확인.
- 월드맵 <-> 업그레이드/영웅관리소 <-> 게임 진입 루프 검증.
- 앱 재실행 후 데이터 유지 확인.

## 7. 리스크 및 대응
- **이중 저장 데이터**: `UserSaveData`와 `PlayerPrefs` 불일치. -> 네임스페이스 분리 관리.
- **UI 리소스 부족**: 6개 카테고리 아이콘/영웅 일러스트. -> 기존 타워 아이콘 및 색상 틴트, 기본 영웅 스프라이트 재사용.

## 8. 완료 기준 (DoD)
- 월드맵 버튼 클릭 시 팝업이 정상적으로 열리고 닫힌다.
- 업그레이드 구매/영웅 선택이 저장되고, 앱 재실행 후 유지된다.
- 게임 진입 시 선택한 영웅이 등장하고, 업그레이드 효과가 적용된다.
