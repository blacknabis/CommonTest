# 타워·영웅 구현 계획 (Tower & Hero Implementation Plan)
> 작성일: 2026-02-19
> 기준 문서: `문서/분석/타워_유닛_상세_분석.md`, `문서/분석/영웅_유닛_상세_분석.md`
> 참고: NotebookLM 분석 결과(역할군/상성/스킬 키워드)
> 대상 프로젝트: Kingdom

## 1. 목표
타워 4계열(Archer/Barracks/Mage/Artillery)과 영웅 역할군(Tank/DPS/Support)의 전투 정체성을
현재 전투 루프에 일관되게 반영한다.

핵심 목표는 아래 3가지다.
1. 상성 체감: 방어/저항/비행/물량 카운터가 플레이에서 즉시 드러날 것
2. 역할 분리: 타워와 영웅이 서로 역할을 완전히 대체하지 않고 보완할 것
3. 데이터 주도: 수치/스킬 조정이 코드 수정 없이 데이터 중심으로 가능할 것

## 2. 범위
### In Scope
- 타워 계열별 타겟팅/피해 타입/속도 규칙 확정
- 4티어 타워 대표 스킬 훅(계열별 최소 1개)
- 영웅 공통 런타임(체력/사망/복귀/쿨다운) 정리
- 영웅 역할군 대표 능력(탱커/딜러/광역/소환) 1차 구현
- 통합 검증용 웨이브 템플릿과 QA 체크리스트 운영

### Out of Scope
- 모든 원작 스킬 1:1 완전 구현
- 최종 VFX/SFX 아트 패스
- 라이브 밸런스 최종 확정값

## 3. 선행 조건
- `DamageCalculator`, `DamageType`, `IDamageable` 공용 체계가 유지되어야 함
- `TowerManager`, `HeroController`, `WaveManager`, `SpawnManager` 이벤트 연결이 안정적이어야 함
- 기존 저장 데이터(PlayerPrefs/SO)와의 직렬화 호환이 깨지지 않아야 함

## 4. 데이터/설계 규격
### 4.1 TowerConfig 확장 기준
- TargetType: `Ground`, `Air`, `Both`
- DamageType: `Physical`, `Magic`, `True`, `Explosive`
- SkillSlot(복수 가능):
  - `SkillId`
  - `CooldownSec`
  - `ProcChance`
  - `Value1`, `Value2`, `DurationSec`
  - `TargetPolicy` (Single, Area, Self, Ally)

### 4.2 HeroConfig 확장 기준
- Identity: `HeroId`, `DisplayName`, `Role`
- Base: `MaxHp`, `DamageMin/Max`, `Armor`, `MagicResist`, `MoveSpeed`, `RespawnSec`
- Growth: `HpGrowthPerLevel`, `DamageGrowthPerLevel`, `ArmorGrowthPerLevel`
- Skills:
  - `PassiveSkillId`
  - `ActiveSkillId`
  - `ActiveCooldownSec`
  - `ActiveRange`

### 4.3 규칙 원칙
- 1~3티어: 수치 성장 중심(선형 또는 완만 곡선)
- 4티어: 역할 점프 중심(기능/판정 변화)
- 보스 면역/예외 규칙은 스킬 훅에서 공통 처리

## 5. 단계별 구현
### Phase 1. 타워 전투 규칙 정리 (P0)
목표: 계열 정체성 명확화 + 1~3티어 성장 표준화

작업
1. Archer: 단일 DPS/대공 우선
2. Barracks: 지상 저지/근접 유지
3. Mage: 방어 카운터(마법 피해)
4. Artillery: 지상 광역(스플래시)
5. 1~3티어 Cost 대비 Damage/Range/Cooldown 성장 표준화

DoD
- 계열별 타겟팅 오류 0
- 비행 대상 처리 규칙 위반 0
- 1~3티어 업그레이드 성능 역전 구간 없음

### Phase 2. 상위 타워(4티어) 스킬 훅 (P1)
목표: 상위 타워의 체감 차별화 구현

작업
1. Archer 4티어: Sniper/Poison 계열 훅 중 1개 이상
2. Mage 4티어: DeathRay/Teleport 계열 훅 중 1개 이상
3. Artillery 4티어: Cluster/Chain/Overcharge 계열 훅 중 1개 이상
4. Barracks 4티어: Heal/Buff/ThrowingAxe 계열 훅 중 1개 이상

DoD
- 각 계열 1개 이상 스킬 발동 확인
- 쿨다운/중복발동/대상없음 예외 처리 완료
- 보스 대상 금지 스킬은 자동 대체(감소 피해/무효)

### Phase 3. 영웅 공통 시스템 (P0~P1)
목표: 영웅별 능력을 얹을 수 있는 공통 프레임 확정

작업
1. Hero 상태: `Idle`, `Move`, `Engage`, `Dead`, `Respawn`
2. XP/레벨업 반영(스탯 성장)
3. 사망-복귀 루프와 스킬 쿨다운 루프 분리

DoD
- 영웅 사망 후 지정 시간 복귀 동작 확인
- 레벨업 수치가 전투 지표(DPS/생존)로 반영
- 상태 전환 중 Null/중복 호출 없음

### Phase 4. 영웅 역할군 대표 능력 (P1)
목표: 역할군 체감 확보

작업
1. Tank(예: Gerald/Alric): 버프/스턴/전선 유지 능력
2. Ranged DPS(예: Alleria): 멀티샷/소환 보조 중 1개
3. AoE/Burst(예: Malik/Bonehart): 광역 타격 1개
4. Summon/Utility(예: Cronan 계열): 소환체 운용 규칙

DoD
- 역할군별 대표 영웅 1명 이상 실전 적용
- 소환체 수/수명 상한 적용
- 탱커가 실제 전선 유지에 기여(유입 지연 시간 증가)

### Phase 5. 통합 검증 및 밸런스 백로그 (P2)
목표: 타워+영웅+적 상성 검증

시나리오
1. Tank & Spank: Barracks+Tank + Single DPS 조합
2. Armor Counter: 고방어 적 상대 Mage 효율
3. Swarm Clear: 물량 웨이브에서 Artillery/AoE 영웅 효율
4. Air Raid: 비행 웨이브에서 대공 분담 검증

DoD
- 치명 버그 0(무한 발동/중복 스폰/Null)
- 밸런스 조정 항목(과강/과약) 문서화

## 6. 우선순위 백로그
### P0
- 타워 계열 규칙 확정
- 영웅 공통 상태/복귀 루프 확정
- 상성 붕괴 버그 방지

### P1
- 4티어 스킬 훅
- 역할군 대표 영웅 능력

### P2
- 원작 세부 스킬 확장
- 연출 개선 및 최종 튜닝

## 7. 리스크 및 대응
1. 스킬 중첩으로 DPS 폭주
- 대응: 동일 효과 중첩 제한/갱신 규칙 적용

2. 소환체 과다로 성능 저하
- 대응: 최대 소환 수/유지 시간/업데이트 간격 제한

3. 타워와 영웅 역할 중복
- 대응: 역할 KPI 분리(저지, 단일딜, 광역, 카운터)

## 8. QA 체크리스트
> 운영 방침: 현재 단계는 **경량 QA(스모크 중심)**만 수행한다.  
> 본격 밸런스/장시간 회귀 QA는 스테이지 구성 단계에서 별도 실행한다.

1. [ ] Archer/Mage가 고방어 적 상대로 의도된 효율 차이를 보이는가?
2. [ ] Barracks 저지와 영웅 전선 유지가 충돌 없이 동작하는가?
3. [ ] Artillery/AoE 스킬이 물량 웨이브에서 성능 이점을 보이는가?
4. [ ] 영웅 사망/복귀/쿨다운 루프가 안정적인가?
5. [ ] 비행 웨이브에서 대공 불가 유닛이 잘못 타겟팅하지 않는가?
6. [ ] 보스 면역 규칙이 즉사/강제이동 계열에 정확히 적용되는가?
7. [ ] 소환체 수/수명 제한이 항상 지켜지는가?

## 9. 완료 기준 (Final DoD)
- 기능: Phase 1~4 구현 완료
- 데이터: 타워/영웅 주요 필드 반영 및 에셋 동기화 완료
- 품질: 경량 QA(핵심 시나리오 스모크) 통과 또는 이슈 등록 완료
- 확장 QA: 스테이지 구성 완료 후 본격 회귀/밸런스 QA로 이관
- 문서: 분석 문서와 구현 규칙/예외가 일치

## 10. 파일 가이드
- 타워 로직: `Assets/Scripts/Kingdom/Game/TowerManager.cs`
- 영웅 로직: `Assets/Scripts/Kingdom/Game/HeroController.cs`
- 전투 공용: `Assets/Scripts/Kingdom/Game/Combat/`
- 웨이브/스폰: `Assets/Scripts/Kingdom/Game/WaveManager.cs`, `Assets/Scripts/Kingdom/Game/SpawnManager.cs`
- 데이터: `Assets/Scripts/Kingdom/Game/Data/`, `Assets/Resources/Data/`


## 11. 핵심 구현 코드 (Core Logic)
### 11.1 DamageCalculator (공용)
```csharp
public static float CalculateFinalDamage(
    float baseDamage,
    EnemyConfig targetConfig,
    DamageType damageType,
    bool halfPhysicalArmorPenetration = false)
{
    float damage = Mathf.Max(0f, baseDamage);
    if (damage <= 0f || targetConfig == null) return damage;

    float resistPercent = targetConfig.GetResistancePercent(damageType);
    if (damageType == DamageType.Physical && halfPhysicalArmorPenetration)
    {
        resistPercent *= 0.5f;
    }

    resistPercent = Mathf.Clamp(resistPercent, 0f, EnemyConfig.MaxResistanceCap);
    return damage * (1f - resistPercent);
}
```

### 11.2 SkillConfig (데이터 주도)
```csharp
[Serializable]
public struct SkillData {
    public string SkillId;       // "SniperShot", "Teleport"
    public float ProcChance;     // 0.3 (30%)
    public float Cooldown;       // 10.0f
    public float Value1;         // Dmg or Duration
    public float Value2;         // SubValue
    public bool IsAreaEffect;    // 광역 여부
    
    // 런타임 상태 관리용 (데이터에는 포함 X, 런타임 래퍼 필요)
    // float _currentCooldown;
}
```

### 11.3 Hero Leveling (성장 수식)
```csharp
// 레벨 N의 스탯 = 기본값 + (성장값 * (N-1))
public float GetMaxHp(int level) => BaseMaxHp + (HpGrowth * (level - 1));
public float GetDamage(int level) => BaseDamage + (DamageGrowth * (level - 1));

// 경험치 테이블 (예시)
// Lv1 -> 2: 100XP, Lv2 -> 3: 150XP ...
public int GetRequiredXp(int level) => 100 * level * (level + 1) / 2;
```

## 12. 완료 및 이관 기준
1. **코드**: `TowerManager`와 `HeroController`가 `DamageCalculator`를 공통 참조.
2. **데이터**: 4티어 타워 SO `SkillData` 직렬화는 **Phase 2 확장 시점 완료 기준**으로 관리.
3. **검증(현 단계)**: `Assets/Resources/Data/WaveConfigs/Templates/WaveTemplate_*.asset` 기반 핵심 스모크 시나리오 통과.
4. **검증(후속)**: 스테이지 구성 완료 후 본격 회귀/밸런스 QA 별도 수행.
5. **문서**: 본 문서의 내용이 `문서/완료/` 폴더로 이관되고 `task.md`가 갱신됨.

## 13. 연계 상세 플랜
- 배럭 병사 근접교전 확장(HP/사망/재소환/상호공격)은 별도 문서로 추적한다.
- 상세 계획: `문서/진행/배럭_병사_근접교전_확장_계획_2026_02_19.md`

