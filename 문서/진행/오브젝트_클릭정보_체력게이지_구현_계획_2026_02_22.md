# 오브젝트 클릭정보 + 체력게이지 구현 계획 (2026-02-22)

## 목표
- 전투 중 오브젝트(적/영웅/타워/배럭 병사) 클릭 시 핵심 정보를 즉시 확인할 수 있다.
- 적/영웅/배럭 병사의 현재 체력을 월드 공간 UI(머리 위 HP Bar)로 확인할 수 있다.
- 성능/가독성/유지보수성을 해치지 않는 최소 구조로 단계적으로 도입한다.

## 범위
- 포함:
- `클릭 정보 패널` (Selection Inspect Panel)
- `월드 체력 게이지` (World HP Bar)
- 기본 입력 처리(좌클릭 선택/빈 영역 선택 해제)
- 제외(이번 트랙):
- 상태이상 아이콘/버프 디버프 상세
- 다중 선택/박스 선택
- 드래그 타겟팅 UI

## 설계 원칙
- 런타임 데이터 원천은 기존 Runtime 객체(`EnemyRuntime`, `BarracksSoldierRuntime`, `HeroController` 등)를 우선 사용한다.
- UI는 폴링 최소화: 이벤트 기반(선택 변경 시) + 저주기 동기화(HP 등 가변값, 예: 0.1s) 혼합.
- 월드 HP Bar는 오브젝트 풀링으로 관리해 GC/Instantiate 비용을 억제한다.
- 선택 시스템은 단일 책임: `SelectionController`가 Raycast/선택 상태만 담당.
- **Snappy Feedback**: 선택 시 즉각적인 시각적 반응(서클)과 UI 애니메이션(Pop-up)을 적용한다.

## Phase 1. 선택(클릭) 시스템 기반
- [ ] `ISelectableTarget` 인터페이스 정의
  - 식별자, DisplayName, Team/Faction, CurrentHp/MaxHp, Position 제공
- [ ] `SelectionController` 추가
  - 마우스 Raycast -> 대상 선택/해제
  - UI 클릭과 월드 클릭 충돌 방지(`EventSystem.current.IsPointerOverGameObject()` 체크)
- [ ] **선택 피드백(Selection Circle) 구현**
  - 발밑에 표시될 원형 스프라이트 프리팹/오브젝트
  - 선택 시 대상 위치로 이동 및 활성화
- [ ] 대상 어댑터 구성
  - `EnemyRuntime`, `BarracksSoldierRuntime`, `HeroController`, `TowerRuntime` 래핑/직접 구현

### 완료 기준
- 게임 화면에서 유닛 클릭 시 현재 선택 대상이 안정적으로 유지/해제된다.

## Phase 2. 클릭 정보 패널 UI
- [ ] `SelectionInfoPanel` UI 프리팹 생성/연결
  - 표시 항목:
    - **공통**: 이름, HP 바/수치
    - **적**: 아머 타입(Physical/Magic), 이동속도, 현상금
    - **아군(병사/영웅)**: 공격력, 아머 수치, 리스폰 시간(사망 시)
    - **타워**: 레벨, 공격력, 사거리, 판매가/강화가
- [ ] **Snappy UI 애니메이션 적용**
  - 패널 나타날 때 살짝 커졌다 작아지는 Pop 효과 (Scale 0.8 -> 1.1 -> 1.0)
- [ ] 패널 업데이트 루프 구현
  - 선택 변경 시 즉시 갱신
  - 선택 유지 중에는 가변 정보(HP) 저주기 갱신
- [ ] Null/Destroy 안전 처리
  - 대상 사망/파괴 시 자동 숨김 또는 해제

### 완료 기준
- 선택 대상의 핵심 정보가 팝업/패널에서 실시간으로 일관되게 보인다.

## Phase 3. 월드 체력 게이지
- [ ] `WorldHpBarView` 프리팹(캔버스/Fill/Image) 생성
- [ ] `WorldHpBarManager` 추가
  - 등록/해제 API
  - 스크린 좌표 변환(`Camera.main.WorldToScreenPoint`)
  - **표시 정책**: 체력이 100% 미만일 때만 표시(Auto-hide when full)
- [ ] 대상별 표시 정책
  - 적/영웅/배럭 병사: 대미지 입은 즉시 노출
  - 타워/건물: 선택 시에만 노출 또는 항상 OFF (Kingdom Rush 스타일 준수)
- [ ] 풀링 적용
- 생성/반납 기반으로 스폰 비용 관리

### 완료 기준
- 전투 중 주요 유닛 머리 위 체력바가 깜빡임 없이 표시된다.

## Phase 4. 통합/회귀
- [ ] 전투 루프 회귀
- 웨이브 전환, 사망/리스폰, 조기호출, 결과 팝업 전환
- [ ] 성능 체크
- 적 다수(예: 50+) 상황에서 프레임 하락/GC 스파이크 점검
- [ ] UI 상호작용 충돌 점검
- 타워 건설 UI/스킬 버튼 입력과 클릭 선택 충돌 확인

### 완료 기준
- 기능 정상 + 기존 전투/메타 흐름 회귀 없음.

## 리스크 및 대응
- 리스크: 클릭 Raycast가 타일/이펙트 콜라이더에 막힘
- 대응: 전용 LayerMask + 우선순위 필터
- 리스크: HP Bar가 카메라/해상도 변경 시 어긋남
- 대응: LateUpdate에서 카메라 기준 재투영
- 리스크: 대상 파괴 시 null race
- 대응: `IsNull()/IsNotNull()` 규칙 + 안전 해제 이벤트

## 구현 순서(권장)
1. Phase 1 (SelectionController)
2. Phase 2 (Info Panel)
3. Phase 3 (World HP Bar)
4. Phase 4 (회귀/성능)

## 산출물
- 코드:
- `Assets/Scripts/Kingdom/Game/SelectionController.cs`
- `Assets/Scripts/Kingdom/UI/SelectionInfoPanel.cs`
- `Assets/Scripts/Kingdom/UI/WorldHpBarManager.cs`
- `Assets/Scripts/Kingdom/UI/WorldHpBarView.cs`
- 문서:
- 본 계획서
- `문서/진행/작업상세로그.md` 진행 로그

## 검증 체크리스트
- [ ] 적 클릭 시 패널 표시/해제 정상
- [ ] 배럭 병사 클릭 시 상태/HP 정상
- [ ] 영웅 클릭 시 정보 노출 정상
- [ ] 적 사망 즉시 HP 바 제거
- [ ] 리스폰 개체 재등록 정상
- [ ] 웨이브 종료/결과 팝업 전환 시 잔여 UI 누수 없음
