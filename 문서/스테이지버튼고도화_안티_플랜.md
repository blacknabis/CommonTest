# 스테이지 버튼 고도화 계획 (Stage Button Standardization Plan)

## 1. 개요
현재 월드맵의 스테이지 버튼(`btnStage1` 등)은 단순한 버튼으로 구현되어 있어, 스테이지 정보(별 획득 개수, 잠금 상태, 난이도 등)를 표시하기 어렵습니다. 이를 해결하기 위해 **스테이지 버튼을 전용 컴포넌트(`UIStageNode`)가 포함된 프리팹으로 고도화**하고, 데이터 기반으로 상태를 갱신하는 구조를 수립합니다.

## 2. 목표
1.  **프리팹화 (`UIStageNode.prefab`)**: 모든 스테이지 버튼이 동일한 구조와 디자인을 공유하도록 표준화.
2.  **동적 정보 표시**:
    *   **클리어 등급 (별)**: 획득한 별(0~3개) 표시.
    *   **잠금 상태 (Lock)**: 해금 규칙(Unlock Policy)에 따른 잠금 아이콘 표시.
3.  **안정성 및 확장성**: 데이터와 뷰의 분리(ViewModel), 런타임 안전장치 마련.

## 3. 데이터 구조 설계 (Data Structure)

### 3.1. StageData (정적 정보 - ScriptableObject)
게임 디자인 단계에서 정의되는 불변 데이터입니다.
```csharp
[CreateAssetMenu(menuName = "Game/Stage/StageData")]
public class StageData : ScriptableObject
{
    public int StageID;             // 고유 ID
    public string StageName;        // 표시 이름 (예: "사우스포트")
    public string SceneName;        // 로드할 씬 이름
    public StageType StageType;     // Normal, Elite, Boss
    public Sprite Thumbnail;        // 맵 썸네일
}
```

### 3.2. UserStageProgress (동적 정보 - SaveData)
유저의 플레이 기록 중 '저장되어야 할' 최소한의 데이터입니다. **해금 여부(`IsUnlocked`)는 저장하지 않고 계산**합니다.
```csharp
[Serializable]
public class UserStageProgress
{
    public int StageID;
    public bool IsCleared;
    public int EarnedStars; // 0 ~ 3
    // IsUnlocked는 저장하지 않음 (규칙 변경 대응)
}
```

### 3.3. StageNodeViewModel (View 전용 모델)
데이터와 UI 사이의 결합을 끊기 위한 중간 객체입니다.
```csharp
public readonly struct StageNodeViewModel
{
    public readonly int StageID;
    public readonly bool IsUnlocked; // 계산된 해금 상태
    public readonly bool IsCleared;
    public readonly int EarnedStars;
    public readonly bool IsSelected;
}
```

## 4. UI 컴포넌트 설계 (`UIStageNode`)

### 4.1. 프리팹 구조
```
UIStageNode (RectTransform, Button, script:UIStageNode)
├── Visuals
│   ├── FlagImage (깃발 아이콘)
│   └── Highlight (선택 효과)
├── Status
│   ├── LockIcon (잠금 상태)
│   └── StarContainer (Horizontal Layout)
│       ├── Star1 (Image)
│       ├── Star2 (Image)
│       └── Star3 (Image)
└── Text (Optional)
    └── StageNumber (TMP)
```

### 4.2. 스크립트 기능 (`UIStageNode.cs`)
*   **역할**: 비즈니스 로직 없이, `ViewModel`을 받아 화면을 갱신하고 클릭 이벤트를 전달하는 '수동적 뷰' 역할.
*   **주요 API**:
    *   `Bind(StageNodeViewModel vm)`: 상태 갱신 (멱등성 보장).
    *   `event Action<int> OnNodeClicked`: 클릭 시 ID 전달.
*   **안전장치**: `Awake` 시 필수 컴포넌트(`LockIcon`, `Button` 등) 누락 검사 및 에러 로그.

## 5. 월드맵 연동 및 해금 로직

### 5.1. 해금 정책 (IStageUnlockPolicy)
해금 규칙을 별도 로직으로 분리하여 유연성을 확보합니다.
*   **기본 정책**: `Stage 1`은 항상 해금, 그 외는 `Stage ID - 1` 클리어 시 해금.

### 5.2. WorldMapView 흐름
1.  **수집**: 자식으로 배치된 `UIStageNode`들을 수집하고 `StageID` 중복 검사.
2.  **데이터 로드**: `GameManager`에서 `UserStageProgress` 로드.
3.  **ViewModel 생성**: `StageData` + `UserStageProgress` + `UnlockPolicy` -> `StageNodeViewModel`.
4.  **바인딩**: 각 노드에 ViewModel 주입.
5.  **인터랙션**: 노드 클릭 시, 잠금 상태면 '잠겨있음' 피드백, 해금 상태면 스테이지 선택 처리.

## 6. 작업 단계 (Action Plan)

1.  **데이터 계층 구현**
    *   `StageData` (SO), `UserStageProgress` (Class), `IStageUnlockPolicy` 인터페이스.
2.  **UI 컴포넌트 구현 (`UIStageNode`)**
    *   프리팹 제작 (Flag, Lock, Stars 구성).
    *   `Bind` 메서드 및 안전장치 구현.
3.  **WorldMapView 고도화**
    *   기존 버튼 로직 제거.
    *   노드 수집 및 초기화 로직 구현.
    *   해금 정책 적용.
4.  **테스트 및 검증**
    *   에디터에서 `StageID` 중복/누락 검출 테스트.
    *   별 0~3개 및 잠금/해금 상태 표시 확인.
