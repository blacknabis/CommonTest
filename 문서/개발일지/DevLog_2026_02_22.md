# Unity 타워디펜스 개발일지 — 선택 UI·HP 동기화·히어로 애니메이션 일괄 정리

> **날짜**: 2026-02-22  
> **프로젝트**: Kingdom Rush 스타일 타워디펜스 (Unity, C#)  
> **키워드**: Selection UI, World HP Bar, Hero Animation, SmartSlice, Editor 툴 정리

---

## 🎯 오늘 하려던 것

전투 씬에서 유닛을 클릭하면 정보 패널이 뜨고, 머리 위에 HP바가 표시되는 — 아주 기본적인 UX가 아직 불안정했다.  
구체적으로 네 가지 목표를 잡았다.

1. **선택 UX 안정화** — 영웅·적·배럭 병사·타워를 클릭했을 때 일관되게 패널이 열리도록
2. **히어로 스프라이트/애니메이션 경로 정리** — SmartSlice로 잘라 놓은 4-액션 시트를 런타임이 제대로 인식하도록
3. **월드 HP바 vs 선택 패널 정보 불일치 해결** — 현재 HP가 0으로 표시되는 치명적 버그
4. **일회성 에디터 툴 정리** — 누적된 Build* 메뉴를 개발 전용 경로로 재배치

결과적으로 **7건의 이슈**를 하루 만에 모두 잡았다. 하나씩 정리해 본다.

---

## 🐛 이슈 1 — 히어로 애니메이션이 안 나와서 게임이 멈췄다

### 현상
`GameScene` 시작 시 히어로 스프라이트 검증 단계에서 예외가 터지며 진행이 중단됐다.

### 원인
런타임 검증 로직은 `idle` / `walk` / `attack` / `die` **네 개의 개별 액션 레코드**를 기대했지만,  
`manifest.json`에는 SmartSlice가 만들어 준 `actionGroup=multi` 레코드 **하나**만 있었다.  
즉, **스프라이트 생성 도구의 출력 포맷**과 **런타임의 기대 포맷**이 어긋난 전형적인 경계면 불일치 문제.

### 수정 포인트

| 파일 | 변경 내용 |
|------|----------|
| `GameScene` | `multi`를 유효한 액션 후보로 인정하도록 검증 로직 확장 |
| `GameScene` | `multi` 텍스처 내부에 `_idle_` `_walk_` `_attack_` `_die_` 토큰이 실제 존재하는지 2차 검증 추가 |
| `HeroController` | `multi` 텍스처 로드 시 현재 액션에 해당하는 프레임만 필터링해 재생 |

### 결과
SmartSlice가 4행짜리 단일 텍스처를 뱉어도 런타임에서 4개 액션을 정상 재생할 수 있게 됐다.

---

## 🐛 이슈 2 — 영웅 HP가 항상 0/Max로 표시된다

### 현상
선택 패널에서 최대 체력은 정상인데 **현재 체력이 0**, 월드 HP바도 텅 빈 막대로 보였다.

### 원인
`HeroController`의 일부 초기화 경로에서 `_currentHp` 세팅이 빠져 있었다.  
`Configure()` → 체력 세팅 OK, 하지만 `Respawn()` 경로에서는 `_maxHp`만 갱신하고 `_currentHp`를 건드리지 않아 0인 채로 남는 문제.

### 수정
`Configure()`와 `Respawn()` 모두 `InitializeHealth()`를 호출하도록 통일했다.  
레벨업 시 `_maxHp` 갱신도 같은 메서드를 경유하게 변경.

### 결과
패널의 `120 / 120` 텍스트와 월드 HP바의 채움 비율이 정확히 일치하게 됐다.

---

## 🐛 이슈 3 — 타워를 클릭하면 액션 메뉴만 뜨고, 선택 패널은 안 뜬다

### 현상
타워 클릭 → 업그레이드/판매 액션 메뉴는 정상 표시.  
그런데 우측 상단의 `SelectionInfoPanel`은 열리지 않았다.

### 원인
`GameScene`의 입력 처리 순서 문제.  
타워 클릭을 **먼저** 소비하고, 범용 선택(Selection) 입력은 이미 suppress된 뒤였다.

### 수정
타워 클릭 분기에서 액션 메뉴를 여는 **직후**에 `SelectionController.Select(towerTarget)`를 명시적으로 호출하도록 수정.  
`TowerManager.TryGetTowerSelectableTarget()`도 추가해서 타워 → 선택 가능 대상 변환 경로를 깔끔하게 만들었다.

### 결과
타워 클릭 시 액션 메뉴와 정보 패널이 동시에 동작한다.

---

## 🐛 이슈 4 — SelectionInfoPanel 레이아웃 겹침

가독성 개선 차원의 수정이다.

- 이름·HP·ATK·DEF를 한 줄에 욱여넣던 걸 **다줄 구조로 분리**
- 이름이 길어지면 **말줄임(…) + 최대 줄 수 제한** 적용
- 패널 위치를 **우측 상단**으로 이동 → 좌측 HUD(웨이브 정보 등)와 겹침 해소
- HP 슬라이더 제거→ **텍스트 기반 HP 표기로 통일** (월드 HP바와 역할 중복 제거)

---

## 🐛 이슈 5 — 월드 HP바 NullReference + 위치 이탈

월드 HP바 쪽 자잘한 이슈를 묶어서 처리했다.

- 프리팹에 필수 컴포넌트가 빠져 있을 때 **방어 로직 보강** (NullRef 방지)
- 오브젝트 풀링 경로의 null 체크 강화
- 머리 위 앵커 계산 시 **Y 오프셋 미세 조정** → 캐릭터 크기별로 HP바가 자연스럽게 위치
- Fill 감소 방향을 **좌→우 고정**으로 보정 (기존에 우→좌로 줄어들던 문제)

---

## 🧹 이슈 6 — 에디터 Tools 메뉴 정리

개발 중 만들었던 일회성 `Build*Prefab`, 데이터 마이그레이션 메뉴가 쌓여 있었다.

- 일회성 빌더/마이그레이션 스크립트 → **삭제**
- 회귀 테스트/디버그 메뉴 → `Developer` 하위로 이동 (운영 메뉴와 분리)
- `AI Sprite Processor` 윈도우 진입점은 그대로 유지

---

## ✅ 검증

```
dotnet build Assembly-CSharp.csproj -v minimal  →  오류 0
```

플레이 테스트에서 아래 시나리오를 수동 확인했다.

| 시나리오 | 결과 |
|---------|------|
| 영웅 클릭 → 패널 노출 + HP 정상 | ✅ |
| 적 클릭 → 패널 노출 | ✅ |
| 배럭 병사 클릭 → 패널 노출 | ✅ |
| 타워 클릭 → 액션 메뉴 + 패널 동시 | ✅ |
| 영웅 HP 텍스트 / 월드 HP바 비율 일치 | ✅ |

---

## 💡 회고 — "경계면"을 보는 눈

이번 하루 수정의 공통 패턴은 **시스템 자체의 기능 부재**가 아니라,  
**시스템 간 경계면의 불일치**였다.

- SmartSlice 출력 포맷 ↔ 런타임 검증 규칙
- `HeroController`의 서로 다른 초기화 경로
- `GameScene` 입력 선처리 ↔ `SelectionController` 기대 흐름

단일 클래스만 들여다보면 각각은 정상이다. 문제는 **이어 붙이는 지점**에서 발생했다.

다음 작업에서는 이런 경계면 회귀를 자동으로 잡아낼 수 있도록,  
**선택→패널 표시→HP 정합성**을 한 번에 검증하는 통합 테스트 시나리오를 먼저 만들 계획이다.

---

## 📌 커밋 정보

| 항목 | 값 |
|------|---|
| 브랜치 | `main` |
| 커밋 해시 | `e430001` |
| 메시지 | `chore: stabilize selection UI and hero hp/runtime sprite pipeline` |
| 원격 반영 | `origin/main` push 완료 |
