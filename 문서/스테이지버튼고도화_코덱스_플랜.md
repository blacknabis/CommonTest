# 스테이지 버튼 고도화 계획 (Codex 보완안)

## 1. 목적
- 월드맵 스테이지 버튼을 단일 버튼(`btnStage1`) 중심 구조에서 데이터 기반 `UIStageNode` 구조로 전환한다.
- 잠금/별/선택 상태를 일관된 정책으로 계산하고, View는 렌더링과 이벤트 전달만 담당하도록 분리한다.
- 이후 월드맵 확장(월드 추가, 이벤트 스테이지, 배지/알림) 시 코드 수정 범위를 최소화한다.

## 2. 범위
- 포함:
1. `UIStageNode` 프리팹/컴포넌트 표준화
2. `StageId` 기반 바인딩, 잠금 정책 계산, 선택 상태 관리
3. `WorldMapView`의 노드 수집/바인딩/클릭 라우팅
4. 검증 도구(중복 ID, 누락 참조, 범위 오류)와 테스트 시나리오
- 제외:
1. 월드 경로(road) 자동 정렬/자동 배치
2. 실제 전투 밸런스 수치 튜닝
3. 씬 연출(카메라 시네머신, 고급 애니메이션) 전면 개편

## 3. 핵심 원칙
1. 단일 책임: View는 표시/입력만, 비즈니스 규칙은 Presenter/Policy로 분리
2. 파생 상태 비저장: `IsUnlocked`는 저장하지 않고 매번 계산
3. 멱등 렌더링: 동일 입력이면 동일 UI 결과 보장
4. 초기화 안전성: null/중복/범위 오류는 시작 단계에서 즉시 감지
5. 확장 우선: `StageType`, 배지, 알림, 조건 정책을 교체 가능 구조로 설계

## 4. 아키텍처
### 4.1 권장 계층
- `WorldMapView`: 노드 수집, Presenter 이벤트 연결, 화면 갱신 호출
- `WorldMapPresenter`: ViewModel 생성/선택 상태 전이/입력 처리
- `IStageUnlockPolicy`: 잠금 계산 규칙
- `IStageProgressRepository`: 진행 데이터 로드/저장 추상화

### 4.2 런타임 흐름
1. View가 `UIStageNode` 목록을 수집하고 `StageId` 중복을 검증한다.
2. Presenter가 정적 데이터(`StageData`) + 유저 진행(`UserStageProgress`)을 로드한다.
3. UnlockPolicy로 잠금 여부를 계산한다.
4. `StageNodeViewModel` 목록을 생성하여 각 노드에 `Bind`한다.
5. 노드 클릭 시 Presenter가 상태를 갱신하고 변경분만 다시 바인딩한다.

## 5. 데이터 모델
## 5.1 명명 규칙
- 전 구간 `StageId`로 통일 (`StageID` 금지)

## 5.2 StageData (정적)
```csharp
public enum StageType { Normal, Elite, Boss, Event }

[CreateAssetMenu(menuName = "Kingdom/Stage/StageData")]
public sealed class StageData : ScriptableObject
{
    public int StageId;
    public string StageName;
    public string SceneName;
    public StageType StageType;
    public Sprite Thumbnail;
    public int RequiredStarsToUnlock;
}
```

## 5.3 UserStageProgress (동적)
```csharp
[Serializable]
public sealed class UserStageProgress
{
    public int StageId;
    public bool IsCleared;
    public int EarnedStars; // Clamp 0~3
    public int BestClearTimeMs; // optional
}
```

## 5.4 ViewModel
```csharp
public readonly struct StageNodeViewModel
{
    public readonly int StageId;
    public readonly string StageLabel;
    public readonly bool IsUnlocked;
    public readonly bool IsCleared;
    public readonly int EarnedStars;
    public readonly bool IsSelected;
    public readonly StageType StageType;
    public readonly bool HasNotification;
}
```

## 6. 잠금 정책
- 인터페이스:
```csharp
public interface IStageUnlockPolicy
{
    bool IsUnlocked(
        int stageId,
        IReadOnlyDictionary<int, UserStageProgress> progressMap,
        IReadOnlyList<StageData> allStages);
}
```
- 기본 정책:
1. `StageId == 1`은 항상 잠금 해제
2. 그 외 스테이지는 직전 스테이지 클리어 시 해제
3. 필요 시 별 조건(`RequiredStarsToUnlock`) 병행

## 7. UIStageNode 설계
### 7.1 프리팹 구조
```text
UIStageNode
├─ Visuals
│  ├─ FlagImage
│  ├─ Highlight
│  └─ TypeBadge (optional)
├─ Status
│  ├─ LockIcon
│  ├─ NotificationDot (optional)
│  └─ StarContainer
│     ├─ Star1
│     ├─ Star2
│     └─ Star3
└─ Text
   └─ StageNumber (TMP)
```

### 7.2 컴포넌트 계약
```csharp
public sealed class UIStageNode : MonoBehaviour
{
    public int StageId { get; private set; }
    public event Action<int> OnNodeClicked;

    public void Initialize(int stageId);
    public void Bind(in StageNodeViewModel vm);
    public void SetInteractable(bool value);
}
```

### 7.3 구현 규칙
1. `Bind`는 멱등 보장
2. `Awake`에서 필수 참조 검증, 누락 시 명시적 Error 로그
3. 클릭 이벤트는 `StageId`만 전달, 씬 전환/규칙 판단은 Presenter에서 처리
4. `OnEnable` 구독, `OnDisable` 해제로 중복 바인딩 방지

## 8. WorldMapView 변경 항목
1. 기존 단일 버튼 바인딩 로직 제거
2. `UIStageNode` 자동 수집(`GetComponentsInChildren`) + ID 정렬
3. `StageId` 중복/누락 검증 실패 시 초기화 중단
4. Presenter 생성 및 데이터 전달
5. 노드 클릭 시:
   - 잠금 상태: 안내 토스트
   - 해제 상태: 선택 상태 갱신 + 상세패널/진입 버튼 활성화

## 9. 검증/로그/안전장치
### 9.1 에디터 검증
- `StageData` 중복 ID 검사
- `UIStageNode` 필수 참조 검사
- 뷰 노드 ID와 데이터 ID 정합성 검사

### 9.2 런타임 보호
- `EarnedStars` 범위 자동 Clamp
- `SceneName` 비어있으면 진입 차단
- 저장 데이터 누락 시 안전 기본값 적용

### 9.3 로그 규약
- Prefix 통일: `[WorldMap]`, `[StageNode]`, `[UnlockPolicy]`
- 레벨 구분:
1. Warning: 복구 가능
2. Error: 기능 제한
3. Fatal: 초기화 중단

## 10. 구현 순서 (실행 계획)
1. 데이터/정책 뼈대 작성
   - `StageData`, `UserStageProgress`, `IStageUnlockPolicy`
2. ViewModel/Presenter 구현
   - `StageNodeViewModel`, `WorldMapPresenter`
3. `UIStageNode` 구현 + 프리팹 완성
4. `WorldMapView` 연결 및 기존 로직 교체
5. 에디터 검증 도구 작성
6. 테스트/QA 및 회귀 체크

## 11. 테스트 계획
### 11.1 단위 테스트
- UnlockPolicy 케이스(기본/별 조건)
- ViewModel 매핑 정확성
- 범위 보정(별 개수 Clamp)

### 11.2 통합 테스트
- 잠금 노드 클릭 차단
- 해제 노드 선택 전환
- 선택 FX 단일성(한 노드만 선택)
- 씬 재진입 후 상태 복원

### 11.3 해상도/입력 테스트
- 16:9, 19.5:9, 4:3에서 배치/터치 영역 확인
- 마우스/터치 입력 모두 동일 동작 확인

## 12. 완료 기준 (DoD)
1. 모든 노드가 `StageId` 기반으로 정상 바인딩됨
2. 잠금/클리어/별/선택 상태가 데이터와 일치함
3. 중복 ID/누락 참조 오류를 초기화 단계에서 탐지함
4. 이벤트 중복 등록/메모리 누수 없음
5. 테스트 체크리스트 통과 및 치명 이슈 0건

## 13. 리스크와 대응
- 리스크: 데이터 불일치(노드 ID vs StageData)
  - 대응: 초기화 전 정합성 검사 + Fatal 처리
- 리스크: 저장 데이터 포맷 변경
  - 대응: `SaveVersion` 도입, 마이그레이션 함수 분리
- 리스크: 추후 정책 확장 시 조건 충돌
  - 대응: 정책 인터페이스 유지 + 정책 단위 테스트 고정
